<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leadfinder - AI-Powered Lead Discovery</title>
    <link rel="icon" type="image/png" href="LinkedIn_Image_Template__15_-removebg-preview.png">
    <script src="https://cdn.tailwindcss.com"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dark-primary': '#1a1a2e',
                        'dark-secondary': '#16213e',
                        'dark-tertiary': '#0f3460',
                        'accent-cyan': '#00d4aa',
                        'accent-teal': '#4ecdc4',
                    }
                }
            }
        }
    </script>
	
    <style>
        .score-circle {
            background: conic-gradient(from 0deg, #00d4aa 0deg, #00d4aa var(--score-deg), #374151 var(--score-deg), #374151 360deg);
        }
        .step-item {
            transition: all 0.3s ease-in-out;
        }
        
        .step-item:hover {
            background-color: rgba(15, 52, 96, 0.3);
            border-radius: 8px;
            padding: 8px;
            margin: -8px;
        }
        
        #loadingTip {
            transition: opacity 0.3s ease-in-out;
        }
        
        #progressBar {
            transition: all 0.5s ease-out;
            position: relative;
        }

        .company-context {
            line-height: 1.6;
            margin-top: 0.75rem;
        }
        
        .verification-badge {
            background: linear-gradient(135deg, #00d4aa, #4ecdc4);
            box-shadow: 0 2px 4px rgba(0, 212, 170, 0.3);
        }
        
        .verification-badge svg {
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1));
        }

    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- Header -->
    <header class="bg-dark-primary border-b border-gray-700 px-6 py-4">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="w-8 h-8 bg-accent-cyan rounded-lg flex items-center justify-center">
                    <svg class="w-5 h-5 text-dark-primary" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <h1 class="text-xl font-semibold text-white">Leadfinder Tool</h1>
            </div>
            
            <div class="flex items-center space-x-4">
                <button id="searchHistoryBtn" class="flex items-center space-x-2 px-3 py-2 rounded-lg bg-dark-secondary hover:bg-dark-tertiary transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span>Recent Searches</span>
                    <span class="bg-accent-cyan text-dark-primary px-2 py-1 rounded-full text-xs font-medium">3</span>
                </button>
                
                <div class="flex items-center space-x-2 px-3 py-2 rounded-lg bg-dark-secondary">
                    <svg class="w-4 h-4 text-accent-cyan" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V4z"/>
                    </svg>
                    <span class="text-accent-cyan font-medium">0 CREDITS</span>
                    <span class="text-gray-400">‚Ä¢ LinkedIn Search</span>
                </div>
                
                <button class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition-colors">
                    Log Out
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-6 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Search Form -->
            <div class="lg:col-span-1">
                <div class="bg-dark-secondary rounded-xl p-6">
                    <h2 class="text-xl font-semibold mb-6 text-white">Find Talent</h2>
                    <p class="text-gray-300 mb-6">Search for candidates from LinkedIn with AI-powered ranking</p>
                    
                    <form id="searchForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Job Title / Role</label>
                            <input type="text" id="jobTitle" placeholder="e.g. Restaurant Manager, Cashier, Cook" 
                                   class="w-full px-4 py-3 bg-dark-primary border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:border-accent-cyan focus:outline-none">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Industry</label>
                            <select id="industry" class="w-full px-4 py-3 bg-dark-primary border border-gray-600 rounded-lg text-white focus:border-accent-cyan focus:outline-none">
                                <option value="">Select Industry</option>
                                <option value="hospitality">Hospitality & Tourism</option>
                                <option value="retail">Retail & Commerce</option>
                                <option value="food-beverage">Food & Beverage</option>
                                <option value="manufacturing">Manufacturing</option>
                                <option value="technology">Technology</option>
                                <option value="healthcare">Healthcare</option>
                                <option value="finance">Finance</option>
                                <option value="education">Education</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Location</label>
                            <select id="location" class="w-full px-4 py-3 bg-dark-primary border border-gray-600 rounded-lg text-white focus:border-accent-cyan focus:outline-none">
                                <option value="">Select Location</option>
                                <option value="jakarta">Jakarta</option>
                                <option value="surabaya">Surabaya</option>
                                <option value="bandung">Bandung</option>
                                <option value="medan">Medan</option>
                                <option value="semarang">Semarang</option>
                                <option value="makassar">Makassar</option>
                                <option value="palembang">Palembang</option>
                                <option value="tangerang">Tangerang</option>
                                <option value="depok">Depok</option>
                                <option value="bekasi">Bekasi</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Experience Level</label>
                            <select id="experience" class="w-full px-4 py-3 bg-dark-primary border border-gray-600 rounded-lg text-white focus:border-accent-cyan focus:outline-none">
                                <option value="">Any Experience</option>
                                <option value="entry">Entry Level (0-2 years)</option>
                                <option value="mid">Mid Level (3-5 years)</option>
                                <option value="senior">Senior Level (6+ years)</option>
                                <option value="manager">Management Level</option>
                            </select>
                        </div>
                        
                        <div class="pt-4">
                            <button type="submit" id="searchBtn" class="w-full bg-accent-cyan hover:bg-accent-teal text-dark-primary font-semibold py-3 px-6 rounded-lg transition-colors flex items-center justify-center space-x-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                </svg>
                                <span>Search Talent</span>
                            </button>
                            <p class="text-sm text-gray-400 mt-2 text-center">üîç AI will match candidates against your criteria (Uses 1 credit)</p>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Results Area -->
            <div class="lg:col-span-2">
                <!-- Initial State -->
                <div id="initialState" class="bg-dark-secondary rounded-xl p-8 text-center">
                    <div class="w-16 h-16 bg-accent-cyan/20 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-accent-cyan" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                    </div>
                    <h3 class="text-xl font-semibold text-white mb-2">Ready to Find Talent</h3>
                    <p class="text-gray-400 mb-6">Fill in the search criteria and AI will find the best matching candidates across multiple platforms</p>
                    <div class="flex justify-center">
                        <button id="sampleSearchBtn" class="px-6 py-2 bg-dark-primary hover:bg-dark-tertiary rounded-lg text-accent-cyan border border-accent-cyan transition-colors">
                            Try Sample Search
                        </button>
                    </div>
                </div>
                
                <!-- Loading State -->
                <div id="loadingState" class="bg-dark-secondary rounded-xl p-8 text-center hidden">
                    <div class="animate-spin w-12 h-12 border-4 border-accent-cyan border-t-transparent rounded-full mx-auto mb-4"></div>
                    <h3 class="text-xl font-semibold text-white mb-2">AI-Powered Talent Discovery</h3>
                    <p class="text-gray-400 mb-6">Searching LinkedIn and analyzing candidates with artificial intelligence</p>
                    
                    <!-- Progress Bar -->
                    <div class="mb-6">
                        <div class="flex justify-between text-sm text-gray-300 mb-2">
                            <span>Progress</span>
                            <span id="progressPercentage">0%</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-3">
                            <div id="progressBar" class="bg-gradient-to-r from-accent-cyan to-accent-teal h-3 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <!-- Detailed Steps -->
                    <div class="bg-dark-primary rounded-lg p-4">
                        <div class="text-sm text-gray-300 space-y-3" id="loadingSteps">
                            <div class="flex items-center justify-between step-item" data-step="1">
                                <div class="flex items-center space-x-3">
                                    <div class="w-6 h-6 rounded-full bg-gray-600 flex items-center justify-center text-xs text-white">1</div>
                                    <span>Initializing LinkedIn search parameters</span>
                                </div>
                                <span class="text-gray-500">‚è∏ Pending</span>
                            </div>
                            <div class="flex items-center justify-between step-item" data-step="2">
                                <div class="flex items-center space-x-3">
                                    <div class="w-6 h-6 rounded-full bg-gray-600 flex items-center justify-center text-xs text-white">2</div>
                                    <span>Searching LinkedIn professional profiles</span>
                                </div>
                                <span class="text-gray-500">‚è∏ Pending</span>
                            </div>
                            <div class="flex items-center justify-between step-item" data-step="3">
                                <div class="flex items-center space-x-3">
                                    <div class="w-6 h-6 rounded-full bg-gray-600 flex items-center justify-center text-xs text-white">3</div>
                                    <span>Extracting candidate information</span>
                                </div>
                                <span class="text-gray-500">‚è∏ Pending</span>
                            </div>
                            <div class="flex items-center justify-between step-item" data-step="4">
                                <div class="flex items-center space-x-3">
                                    <div class="w-6 h-6 rounded-full bg-gray-600 flex items-center justify-center text-xs text-white">4</div>
                                    <span>Running AI analysis and scoring</span>
                                </div>
                                <span class="text-gray-500">‚è∏ Pending</span>
                            </div>
                            <div class="flex items-center justify-between step-item" data-step="5">
                                <div class="flex items-center space-x-3">
                                    <div class="w-6 h-6 rounded-full bg-gray-600 flex items-center justify-center text-xs text-white">5</div>
                                    <span>Evaluating role and experience match</span>
                                </div>
                                <span class="text-gray-500">‚è∏ Pending</span>
                            </div>
                            <div class="flex items-center justify-between step-item" data-step="6">
                                <div class="flex items-center space-x-3">
                                    <div class="w-6 h-6 rounded-full bg-gray-600 flex items-center justify-center text-xs text-white">6</div>
                                    <span>Ranking candidates by compatibility</span>
                                </div>
                                <span class="text-gray-500">‚è∏ Pending</span>
                            </div>
                            <div class="flex items-center justify-between step-item" data-step="7">
                                <div class="flex items-center space-x-3">
                                    <div class="w-6 h-6 rounded-full bg-gray-600 flex items-center justify-center text-xs text-white">7</div>
                                    <span>Finalizing results and recommendations</span>
                                </div>
                                <span class="text-gray-500">‚è∏ Pending</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Fun Facts -->
                    <div class="mt-4 text-xs text-gray-400" id="loadingTip">
                        üí° Tip: Higher AI scores indicate better role compatibility
                    </div>
                </div>
                
                <!-- Results State -->
                <div id="resultsState" class="hidden">
					<!-- ADD THIS NEW SECTION HERE -->
				    <div id="aiInsightsBox" class="bg-gradient-to-r from-accent-cyan/10 to-accent-teal/10 border border-accent-cyan/30 rounded-xl p-6 mb-6">
				        <div class="flex items-start space-x-3">
				            <div class="w-10 h-10 bg-accent-cyan/20 rounded-lg flex items-center justify-center flex-shrink-0">
				                <svg class="w-6 h-6 text-accent-cyan" fill="currentColor" viewBox="0 0 20 20">
				                    <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
				                </svg>
				            </div>
				            <div class="flex-1">
				                <h3 class="text-lg font-semibold text-accent-cyan mb-2 flex items-center">
				                    AI Search Insights
				                </h3>
				                <p id="aiInsightsText" class="text-gray-300 leading-relaxed">
				                    Analyzing candidates and generating insights...
				                </p>
				            </div>
				        </div>
				    </div>
                    <div class="bg-dark-secondary rounded-xl p-6 mb-6">
                        <div class="flex flex-col md:flex-row md:items-start md:justify-between mb-4 gap-3">
			    <div>
			        <h3 class="text-xl font-semibold text-white">Search Results</h3>
			        <p class="text-gray-400">
			            Found 10 candidates matching "Restaurant Manager" in jakarta
			        </p>
			    </div>
			    <div class="flex flex-row items-center gap-2 w-full md:w-auto justify-end">
				    <select class="px-3 py-2 bg-dark-primary border border-gray-600 rounded-lg text-white text-sm" id="sortSelect">
				        <option value="Sort by Score">Sort by Score</option>
				        <option value="Sort by Experience">Sort by Experience</option>
				        <option value="Sort by Location">Sort by Location</option>
				    </select>
				    <button id="compareBtn" class="hidden flex items-center justify-center px-3 py-2 w-32 bg-dark-primary border border-purple-500 text-purple-400 hover:bg-purple-500 hover:text-white font-medium text-sm rounded-lg transition-colors">
				        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
				            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
				        </svg>
				        <span id="compareBtnText" class="text-xs">Compare</span>
				    </button>
				    <button id="exportBtn" class="flex items-center justify-center px-3 py-2 w-32 bg-accent-cyan hover:bg-accent-teal text-dark-primary font-medium text-sm rounded-lg transition-colors">
				        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
				            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M8 17l4 4 4-4m-4-5v9"/>
				        </svg>
				        <span class="text-xs">Export to CSV</span>
				    </button>
				</div>
			</div>
                        
                        <!-- Filter Bar -->
                        <div class="flex items-center space-x-4 p-3 bg-dark-primary rounded-lg">
                            <input type="text" placeholder="Filter by name, title, skills..." class="flex-1 px-3 py-2 bg-transparent text-white placeholder-gray-400 border-none outline-none">
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-gray-400">Min Score:</span>
                                <input type="range" min="0" max="100" value="0" class="w-24">
                                <span class="text-sm text-accent-cyan">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Candidate Cards -->
                    <div class="space-y-4">
                        <!-- Sample Candidate 1 -->
                        <div class="bg-dark-secondary rounded-xl p-6 hover:bg-dark-tertiary transition-colors cursor-pointer candidate-card">
                            <div class="flex items-start justify-between">
                                <div class="flex items-start space-x-4 flex-1">
                                    <div class="w-12 h-12 bg-gray-600 rounded-full flex items-center justify-center">
                                        <span class="text-white font-semibold">AS</span>
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex items-center space-x-2 mb-1">
                                            <h4 class="text-lg font-semibold text-white">Ahmad Suharto</h4>
                                            <span class="px-2 py-1 bg-accent-cyan/20 text-accent-cyan text-xs rounded">JobStreet</span>
                                        </div>
                                        <p class="text-gray-300 mb-2">Restaurant Manager ‚Ä¢ 8 years experience</p>
                                        <p class="text-gray-400 text-sm mb-3">Jakarta Selatan ‚Ä¢ Hospitality & Tourism</p>
                                        <p class="text-gray-300 text-sm">Experienced restaurant manager with strong leadership in fine dining establishments. Proven track record in team management, cost control, and customer satisfaction...</p>
                                        <div class="flex items-center space-x-4 mt-3">
                                            <span class="text-xs text-gray-400">LinkedIn Profile Available</span>
                                            <span class="text-xs text-gray-400">Last Updated: 2 days ago</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex flex-col items-center ml-4">
                                    <div class="relative w-16 h-16 mb-2">
                                        <div class="w-16 h-16 rounded-full score-circle flex items-center justify-center" style="--score-deg: 306deg">
                                            <div class="w-12 h-12 bg-dark-secondary rounded-full flex items-center justify-center">
                                                <span class="text-accent-cyan font-bold text-sm">85</span>
                                            </div>
                                        </div>
                                    </div>
                                    <span class="text-xs text-gray-400">AI Score</span>
                                </div>
                            </div>
                        </div>
                    <!-- Sample Candidate 2 -->
                        <div class="bg-dark-secondary rounded-xl p-6 hover:bg-dark-tertiary transition-colors cursor-pointer candidate-card">
                            <div class="flex items-start justify-between">
                                <div class="flex items-start space-x-4 flex-1">
                                    <div class="w-12 h-12 bg-gray-600 rounded-full flex items-center justify-center">
                                        <span class="text-white font-semibold">SP</span>
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex items-center space-x-2 mb-1">
                                            <h4 class="text-lg font-semibold text-white">Sari Permata</h4>
                                            <span class="px-2 py-1 bg-blue-500/20 text-blue-400 text-xs rounded">LinkedIn</span>
                                        </div>
                                        <p class="text-gray-300 mb-2">Operations Manager ‚Ä¢ 6 years experience</p>
                                        <p class="text-gray-400 text-sm mb-3">Jakarta Pusat ‚Ä¢ Food & Beverage</p>
                                        <p class="text-gray-300 text-sm">Dynamic operations manager specializing in restaurant chains and franchise management. Expert in process optimization, staff training, and quality control...</p>
                                        <div class="flex items-center space-x-4 mt-3">
                                            <span class="text-xs text-gray-400">Full Profile Available</span>
                                            <span class="text-xs text-gray-400">Last Updated: 1 week ago</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex flex-col items-center ml-4">
                                    <div class="relative w-16 h-16 mb-2">
                                        <div class="w-16 h-16 rounded-full score-circle flex items-center justify-center" style="--score-deg: 280deg">
                                            <div class="w-12 h-12 bg-dark-secondary rounded-full flex items-center justify-center">
                                                <span class="text-accent-cyan font-bold text-sm">78</span>
                                            </div>
                                        </div>
                                    </div>
                                    <span class="text-xs text-gray-400">AI Score</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sample Candidate 3 -->
                        <div class="bg-dark-secondary rounded-xl p-6 hover:bg-dark-tertiary transition-colors cursor-pointer candidate-card">
                            <div class="flex items-start justify-between">
                                <div class="flex items-start space-x-4 flex-1">
                                    <div class="w-12 h-12 bg-gray-600 rounded-full flex items-center justify-center">
                                        <span class="text-white font-semibold">BD</span>
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex items-center space-x-2 mb-1">
                                            <h4 class="text-lg font-semibold text-white">Budi Darma</h4>
                                            <span class="px-2 py-1 bg-green-500/20 text-green-400 text-xs rounded">Karir.com</span>
                                        </div>
                                        <p class="text-gray-300 mb-2">F&B Supervisor ‚Ä¢ 5 years experience</p>
                                        <p class="text-gray-400 text-sm mb-3">Jakarta Barat ‚Ä¢ Food & Beverage</p>
                                        <p class="text-gray-300 text-sm">Dedicated food service supervisor with experience in hotel restaurants and catering. Strong background in inventory management and team coordination...</p>
                                        <div class="flex items-center space-x-4 mt-3">
                                            <span class="text-xs text-gray-400">Contact Info Available</span>
                                            <span class="text-xs text-gray-400">Last Updated: 3 days ago</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex flex-col items-center ml-4">
                                    <div class="relative w-16 h-16 mb-2">
                                        <div class="w-16 h-16 rounded-full score-circle flex items-center justify-center" style="--score-deg: 252deg">
                                            <div class="w-12 h-12 bg-dark-secondary rounded-full flex items-center justify-center">
                                                <span class="text-accent-cyan font-bold text-sm">70</span>
                                            </div>
                                        </div>
                                    </div>
                                    <span class="text-xs text-gray-400">AI Score</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Candidate Detail Modal -->
    <div id="candidateModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-dark-secondary rounded-xl max-w-4xl w-full max-h-screen overflow-y-auto">
            <div class="p-6 border-b border-gray-700">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="w-16 h-16 bg-gray-600 rounded-full flex items-center justify-center">
                            <span class="text-white font-bold text-lg">AS</span>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-white">Ahmad Suharto</h2>
                            <p class="text-gray-300">Restaurant Manager ‚Ä¢ 8 years experience</p>
                            <p class="text-gray-400">Jakarta Selatan ‚Ä¢ Available for Contact</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="text-center">
                            <div class="relative w-20 h-20 mb-2">
                                <div class="w-20 h-20 rounded-full score-circle flex items-center justify-center" style="--score-deg: 306deg">
                                    <div class="w-16 h-16 bg-dark-secondary rounded-full flex items-center justify-center">
                                        <span class="text-accent-cyan font-bold text-lg">85</span>
                                    </div>
                                </div>
                            </div>
                            <span class="text-sm text-gray-400">AI Match Score</span>
                        </div>
                        <button id="closeModal" class="text-gray-400 hover:text-white">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="p-6 space-y-6">
                <!-- AI Analysis Summary -->
                <div class="bg-dark-primary rounded-lg p-4">
                    <h3 class="text-lg font-semibold text-white mb-3 flex items-center">
                        <svg class="w-5 h-5 text-accent-cyan mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        AI Analysis Summary
                    </h3>
                    <p class="text-gray-300 mb-4">Strong match for Restaurant Manager position with excellent leadership experience and location compatibility. Recommended for immediate contact.</p>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <span class="text-sm text-gray-400">Role Relevance</span>
                            <div class="flex items-center space-x-2 mt-1">
                                <div class="flex-1 bg-gray-600 rounded-full h-2">
                                    <div class="bg-accent-cyan h-2 rounded-full" style="width: 90%"></div>
                                </div>
                                <span class="text-sm text-accent-cyan">90%</span>
                            </div>
                        </div>
                        <div>
                            <span class="text-sm text-gray-400">Experience Match</span>
                            <div class="flex items-center space-x-2 mt-1">
                                <div class="flex-1 bg-gray-600 rounded-full h-2">
                                    <div class="bg-accent-cyan h-2 rounded-full" style="width: 85%"></div>
                                </div>
                                <span class="text-sm text-accent-cyan">85%</span>
                            </div>
                        </div>
                        <div>
                            <span class="text-sm text-gray-400">Location Fit</span>
                            <div class="flex items-center space-x-2 mt-1">
                                <div class="flex-1 bg-gray-600 rounded-full h-2">
                                    <div class="bg-accent-cyan h-2 rounded-full" style="width: 95%"></div>
                                </div>
                                <span class="text-sm text-accent-cyan">95%</span>
                            </div>
                        </div>
                        <div>
                            <span class="text-sm text-gray-400">Profile Quality</span>
                            <div class="flex items-center space-x-2 mt-1">
                                <div class="flex-1 bg-gray-600 rounded-full h-2">
                                    <div class="bg-accent-cyan h-2 rounded-full" style="width: 70%"></div>
                                </div>
                                <span class="text-sm text-accent-cyan">70%</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Profile Details -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="text-lg font-semibold text-white mb-3">Profile Summary</h4>
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-400">Experience:</span>
                                <span class="text-white">8 years in hospitality</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Current Role:</span>
                                <span class="text-white">Restaurant Manager</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Location:</span>
                                <span class="text-white">Jakarta Selatan</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Source:</span>
                                <span class="text-accent-cyan">JobStreet Indonesia</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Profile Updated:</span>
                                <span class="text-white">2 days ago</span>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="text-lg font-semibold text-white mb-3">Key Strengths</h4>
                        <div class="space-y-2">
                            <div class="flex items-center space-x-2">
                                <div class="w-2 h-2 bg-accent-cyan rounded-full"></div>
                                <span class="text-gray-300 text-sm">Team Leadership & Management</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="w-2 h-2 bg-accent-cyan rounded-full"></div>
                                <span class="text-gray-300 text-sm">Fine Dining Experience</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="w-2 h-2 bg-accent-cyan rounded-full"></div>
                                <span class="text-gray-300 text-sm">Cost Control & Budget Management</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                                            <div class="w-2 h-2 bg-accent-cyan rounded-full"></div>
                                <span class="text-gray-300 text-sm">Customer Service Excellence</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="w-2 h-2 bg-accent-cyan rounded-full"></div>
                                <span class="text-gray-300 text-sm">Multi-location Experience</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Potential Concerns -->
                <div class="bg-yellow-900/20 border border-yellow-600/30 rounded-lg p-4">
                    <h4 class="text-lg font-semibold text-yellow-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                        Potential Considerations
                    </h4>
                    <div class="space-y-2 text-sm text-yellow-100">
                        <div class="flex items-start space-x-2">
                            <span class="text-yellow-400">‚Ä¢</span>
                            <span>Profile hasn't been updated in 2 weeks - may indicate job satisfaction</span>
                        </div>
                        <div class="flex items-start space-x-2">
                            <span class="text-yellow-400">‚Ä¢</span>
                            <span>Current employment status unclear - may require verification</span>
                        </div>
                        <div class="flex items-start space-x-2">
                            <span class="text-yellow-400">‚Ä¢</span>
                            <span>Limited contact information available on public profile</span>
                        </div>
                    </div>
                </div>
                
                <!-- Recommendation -->
                <div class="bg-accent-cyan/10 border border-accent-cyan/30 rounded-lg p-4">
                    <h4 class="text-lg font-semibold text-accent-cyan mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                        </svg>
                        AI Recommendation
                    </h4>
                    <p class="text-gray-300 text-sm">
                        <strong>High Priority Contact:</strong> Ahmad shows excellent alignment with restaurant management requirements. 
                        Recommend reaching out with a personalized message highlighting career growth opportunities and competitive compensation. 
                        Best contact approach: LinkedIn message or professional email during business hours.
                    </p>
                </div>
                
                <!-- Contact Actions -->
                <div class="flex items-center space-x-4">
		    <button class="px-4 py-2 bg-accent-cyan hover:bg-accent-teal text-dark-primary rounded-lg font-medium export-modal-btn" data-type="pdf">
		        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
		            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v16h16V4H4zm8 4v8m4-4H8"/>
		        </svg> Export PDF
		    </button>
		    <button class="px-4 py-2 bg-dark-primary border border-accent-cyan text-accent-cyan rounded-lg font-medium export-modal-btn" data-type="csv">
		        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
		            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 17l4 4 4-4m-4-5v9"/>
		        </svg> Export CSV
		    </button>
		    <button class="px-4 py-2 bg-dark-primary border border-gray-600 text-white rounded-lg font-medium export-modal-btn" data-type="clipboard">
		        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
		            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3a1 1 0 011-1h6a1 1 0 011 1v4"/>
		            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7H8a1 1 0 00-1 1v12a1 1 0 001 1h8a1 1 0 001-1V8a1 1 0 00-1-1z"/>
		        </svg> Copy to Clipboard
		    </button>
		</div>
            </div>
        </div>
    </div>

	<!-- Candidate Comparison Modal -->
	<div id="comparisonModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
	    <div class="bg-dark-secondary rounded-xl max-w-6xl w-full max-h-screen overflow-y-auto">
	        <div class="p-6 border-b border-gray-700">
	            <div class="flex items-center justify-between">
	                <h2 class="text-2xl font-bold text-white">Candidate Comparison</h2>
	                <button id="closeComparisonModal" class="text-gray-400 hover:text-white">
	                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
	                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
	                    </svg>
	                </button>
	            </div>
	        </div>
	        
	        <div class="p-6">
	            <div id="comparisonContent" class="grid gap-6">
	                <!-- Comparison content will be dynamically generated -->
	            </div>
	        </div>
	    </div>
	</div>

    <!-- Search History Modal -->
    <div id="historyModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-dark-secondary rounded-xl max-w-2xl w-full max-h-screen overflow-y-auto">
            <div class="p-6 border-b border-gray-700">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-bold text-white">Search History</h2>
                    <button id="closeHistoryModal" class="text-gray-400 hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="p-6 space-y-4">
                <div class="bg-dark-primary rounded-lg p-4 hover:bg-dark-tertiary transition-colors cursor-pointer">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="font-semibold text-white">Restaurant Manager in Jakarta</h3>
                        <span class="text-sm text-gray-400">2 hours ago</span>
                    </div>
                    <p class="text-sm text-gray-300 mb-2">Hospitality & Tourism ‚Ä¢ Entry to Mid Level</p>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-accent-cyan">8 candidates found</span>
                        <button class="text-xs text-gray-400 hover:text-accent-cyan">Rerun Search</button>
                    </div>
                </div>
                
                <div class="bg-dark-primary rounded-lg p-4 hover:bg-dark-tertiary transition-colors cursor-pointer">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="font-semibold text-white">Cashier in Surabaya</h3>
                        <span class="text-sm text-gray-400">1 day ago</span>
                    </div>
                    <p class="text-sm text-gray-300 mb-2">Retail & Commerce ‚Ä¢ Entry Level</p>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-accent-cyan">12 candidates found</span>
                        <button class="text-xs text-gray-400 hover:text-accent-cyan">Rerun Search</button>
                    </div>
                </div>
                
                <div class="bg-dark-primary rounded-lg p-4 hover:bg-dark-tertiary transition-colors cursor-pointer">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="font-semibold text-white">Cook in Bandung</h3>
                        <span class="text-sm text-gray-400">3 days ago</span>
                    </div>
                    <p class="text-sm text-gray-300 mb-2">Food & Beverage ‚Ä¢ Mid Level</p>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-accent-cyan">6 candidates found</span>
                        <button class="text-xs text-gray-400 hover:text-accent-cyan">Rerun Search</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="exportModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-dark-secondary rounded-xl max-w-md w-full">
            <div class="p-6 border-b border-gray-700">
                <h2 class="text-xl font-bold text-white">Export Results</h2>
                <p class="text-gray-400 text-sm mt-1">Choose export format for your search results</p>
            </div>
            <div class="p-6 space-y-4">
                <button class="w-full p-4 bg-dark-primary hover:bg-dark-tertiary rounded-lg transition-colors flex items-center space-x-3">
                    <svg class="w-8 h-8 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"/>
                    </svg>
                    <div class="text-left">
                        <div class="font-medium text-white">PDF Report</div>
                        <div class="text-sm text-gray-400">Detailed profiles with AI analysis</div>
                    </div>
                </button>
                
                <button class="w-full p-4 bg-dark-primary hover:bg-dark-tertiary rounded-lg transition-colors flex items-center space-x-3">
                    <svg class="w-8 h-8 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                    <div class="text-left">
                        <div class="font-medium text-white">CSV Spreadsheet</div>
                        <div class="text-sm text-gray-400">Contact info and basic details</div>
                    </div>
                </button>
                
                <button class="w-full p-4 bg-dark-primary hover:bg-dark-tertiary rounded-lg transition-colors flex items-center space-x-3">
                    <svg class="w-8 h-8 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M8 2a1 1 0 000 2h2a1 1 0 100-2H8z"/>
                        <path d="M3 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v6h-4.586l1.293-1.293a1 1 0 10-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L10.414 13H15v3a2 2 0 01-2 2H5a2 2 0 01-2-2V5zM15 11h2a1 1 0 110 2h-2v-2z"/>
                    </svg>
                    <div class="text-left">
                        <div class="font-medium text-white">Copy to Clipboard</div>
                        <div class="text-sm text-gray-400">Quick paste into other tools</div>
                    </div>
                </button>
            </div>
            <div class="p-6 border-t border-gray-700 flex justify-end">
                <button id="closeExportModal" class="px-4 py-2 text-gray-400 hover:text-white">Cancel</button>
            </div>
        </div>
    </div>

<div id="exportToast" class="fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-dark-secondary text-accent-cyan px-6 py-3 rounded-xl shadow-lg z-50 hidden flex items-center space-x-3">
    <svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
    </svg>
    <span id="exportToastText">Exporting...</span>
</div>
<!-- Auth Modal -->
<div id="authModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
    <div class="bg-dark-secondary rounded-xl max-w-md w-full">
        <div class="p-6 border-b border-gray-700">
            <h2 class="text-xl font-bold text-white">Login to Continue</h2>
            <p class="text-gray-400 text-sm mt-1">Access your credits and search history</p>
        </div>
        <div class="p-6 space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Email</label>
                <input type="email" id="authEmail" placeholder="Enter your email" 
                       class="w-full px-4 py-3 bg-dark-primary border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:border-accent-cyan focus:outline-none">
            </div>
            
            <button id="magicLinkBtn" class="w-full bg-accent-cyan hover:bg-accent-teal text-dark-primary font-semibold py-3 px-6 rounded-lg transition-colors">
                Send Magic Link
            </button>
            
            <div class="relative">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-600"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-2 bg-dark-secondary text-gray-400">or</span>
                </div>
            </div>
            
            <button id="googleAuthBtn" class="w-full bg-white hover:bg-gray-100 text-gray-900 font-semibold py-3 px-6 rounded-lg transition-colors flex items-center justify-center space-x-2">
                <svg class="w-5 h-5" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                <span>Continue with Google</span>
            </button>
            
            <div id="authMessage" class="text-sm text-center hidden"></div>
        </div>
        <div class="p-6 border-t border-gray-700 flex justify-end">
            <button id="closeAuthModal" class="px-4 py-2 text-gray-400 hover:text-white">Cancel</button>
        </div>
    </div>
</div>

<script>
	// Supabase configuration
	const SUPABASE_URL = 'https://brawqzylfyuotgxqmtox.supabase.co';
	const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJyYXdxenlsZnl1b3RneHFtdG94Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg1MTU0NTUsImV4cCI6MjA2NDA5MTQ1NX0.P4qazlzBHk66eItqBRK-6k2ll2I1d754ke5_r_hNxos';
	const WEBHOOK_SECRET = 'leadfinder_secretkey123';
	
	// Initialize Supabase
	const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
	console.log("Supabase client created!", supabaseClient); // ‚Üê Add this here
	
	// Auth state management
	
console.log('JavaScript is running');

let currentUser = null;
let userCredits = 0;
let currentSearchResults = [];
let currentCandidates = [];
let progressInterval = null;
let activeCandidate = null;
let currentHistoryData = [];

// Authentication functions
function showAuthModal() {
    document.getElementById('authModal').classList.remove('hidden');
}

function hideAuthModal() {
    document.getElementById('authModal').classList.add('hidden');
}

async function signInWithMagicLink() {
    const email = document.getElementById('authEmail').value;
    if (!email) {
        showAuthMessage('Please enter your email', 'error');
        return;
    }
    
    const { error } = await supabaseClient.auth.signInWithOtp({
        email: email,
        options: {
            emailRedirectTo: window.location.origin
        }
    });
    
    if (error) {
        showAuthMessage(error.message, 'error');
    } else {
        showAuthMessage('Check your email for the magic link!', 'success');
    }
}

async function signInWithGoogle() {
    const { error } = await supabaseClient.auth.signInWithOAuth({
        provider: 'google',
        options: {
            redirectTo: window.location.origin
        }
    });
    
    if (error) {
        showAuthMessage(error.message, 'error');
    }
}

function showAuthMessage(message, type) {
    const messageEl = document.getElementById('authMessage');
    messageEl.textContent = message;
    messageEl.className = `text-sm text-center ${type === 'error' ? 'text-red-400' : 'text-accent-cyan'}`;
    messageEl.classList.remove('hidden');
    
    setTimeout(() => {
        messageEl.classList.add('hidden');
    }, 5000);
}

document.addEventListener('DOMContentLoaded', () => {
// Auth modal event listeners
document.getElementById('magicLinkBtn').addEventListener('click', signInWithMagicLink);
document.getElementById('googleAuthBtn').addEventListener('click', signInWithGoogle);
document.getElementById('closeAuthModal').addEventListener('click', hideAuthModal);
	
    console.log('DOMContentLoaded fired!');
    console.log('About to call updateSearchHistoryUI...');
    
    try {
        updateSearchHistoryUI();
        console.log('updateSearchHistoryUI completed successfully');
    } catch (error) {
        console.log('Error in updateSearchHistoryUI:', error);
    }
});
        // State management
       
        let searchHistory = JSON.parse(localStorage.getItem('leadfinder_history') || '[]');
		

		// Authentication and credit management
		async function checkAuthAndCredits() {
		    console.log("checkAuthAndCredits CALLED");
		
		    if (!currentUser) {
		        console.log("No currentUser, calling supabaseClient.auth.getUser()");
		        const { data: { user } } = await supabaseClient.auth.getUser();
		        if (!user) {
		            console.log("No user from supabaseClient.auth.getUser(), showing auth modal");
		            showAuthModal();
		            return false;
		        }
		        currentUser = user;
		    }
		
		    console.log('Checking profile for user:', currentUser.id);
		
		    const { data: profile, error } = await supabaseClient
		        .from('leadfinder_users')
		        .select('credits')
		        .eq('user_id', currentUser.id)
		        .single();
		
		    console.log('Profile:', profile, 'Error:', error);
		
		    if (error) {
		        console.log('Error fetching user profile:', error);
		        // If user doesn't exist, create them
		        if (error.code === 'PGRST116') { // No rows returned
		            console.log('Creating new user profile...');
		            console.log('About to INSERT this:', {
		                user_id: currentUser.id,
		                email: currentUser.email,
		                credits: 10
		            });
		            const { data: newProfile, error: insertError } = await supabaseClient
		                .from('leadfinder_users')
		                .insert({
		                    user_id: currentUser.id,
		                    email: currentUser.email,
		                    credits: 10
		                })
		                .select()
		                .single();
		            if (insertError) {
		                console.error('Error creating user profile:', insertError);
		                return false;
		            }
		            userCredits = newProfile.credits || 10;
		            updateCreditsDisplay();
		            console.log('New user created with credits:', userCredits);
		            return true;
		        } else {
		            console.log("Error is not PGRST116, returning false.");
		        }
		        return false;
		    }
		
		    if (profile) {
		        console.log("Profile exists, updating credits display.");
		        userCredits = profile.credits || 0;
		        updateCreditsDisplay();
		        return userCredits > 0;
		    }
		
		    console.log("Reached end of function, returning false.");
		    return false;
		}
		
		function updateCreditsDisplay() {
		    console.log('updateCreditsDisplay called with userCredits:', userCredits);
		    
		    // Use the selector that works from the debug
		    const creditsElement = document.querySelector('span.text-accent-cyan.font-medium');
		    
		    if (creditsElement) {
		        creditsElement.textContent = `${userCredits} CREDITS`;
		        console.log('Credits display updated to:', userCredits);
		    } else {
		        console.error('Could not find credits element to update');
		    }
		}
		
		async function deductCredit() {
		    if (userCredits <= 0) return false;
		    const { error } = await supabaseClient
		        .from('leadfinder_users')
		        .update({ credits: userCredits - 1, updated_at: new Date().toISOString() })
		        .eq('user_id', currentUser.id);
		    if (!error) {
		        userCredits -= 1;
		        updateCreditsDisplay();
		        return true;
		    }
		    return false;
		}

		// Authentication functions
		function showAuthModal() {
		    document.getElementById('authModal').classList.remove('hidden');
		}
		
		function hideAuthModal() {
		    document.getElementById('authModal').classList.add('hidden');
		}
		
		async function signInWithMagicLink() {
		    const email = document.getElementById('authEmail').value;
		    if (!email) {
		        showAuthMessage('Please enter your email', 'error');
		        return;
		    }
		    
		    const { error } = await supabaseClient.auth.signInWithOtp({
		        email: email,
		        options: {
		            emailRedirectTo: window.location.origin
		        }
		    });
		    
		    if (error) {
		        showAuthMessage(error.message, 'error');
		    } else {
		        showAuthMessage('Check your email for the magic link!', 'success');
		    }
		}
		
		async function signInWithGoogle() {
		    const { error } = await supabaseClient.auth.signInWithOAuth({
		        provider: 'google',
		        options: {
		            redirectTo: window.location.origin
		        }
		    });
		    
		    if (error) {
		        showAuthMessage(error.message, 'error');
		    }
		}
		
		function showAuthMessage(message, type) {
		    const messageEl = document.getElementById('authMessage');
		    messageEl.textContent = message;
		    messageEl.className = `text-sm text-center ${type === 'error' ? 'text-red-400' : 'text-accent-cyan'}`;
		    messageEl.classList.remove('hidden');
		    
		    setTimeout(() => {
		        messageEl.classList.add('hidden');
		    }, 5000);
		}
		
		// Save search to Supabase
		async function saveSearchToSupabase(searchParams, results) {
		    if (!currentUser) return;
		    
		    const { error } = await supabaseClient
		        .from('search_history')
		        .insert({
		            user_id: currentUser.id,
		            search_params: searchParams,
		            results: results,
		            credits_used: 1
		        });
		    
		    if (error) {
		        console.error('Failed to save search:', error);
		    }
		}
		
		// Load search history from Supabase instead of localStorage
		async function loadSearchHistory() {
		    if (!currentUser) return [];
		    
		    const { data, error } = await supabase
		        .from('search_history')
		        .select('*')
		        .eq('user_id', currentUser.id)
		        .order('created_at', { ascending: false })
		        .limit(10);
		    
		    if (error) {
		        console.error('Failed to load search history:', error);
		        return [];
		    }
		    
		    return data.map(item => ({
		        id: item.id,
		        jobTitle: item.search_params.jobTitle,
		        industry: item.search_params.industry,
		        location: item.search_params.location,
		        experience: item.search_params.experience,
		        resultCount: item.results.totalFound || 0,
		        candidates: item.results.candidates || [],
		        timestamp: item.created_at
		    }));
		}
        
        // DOM elements
        const searchForm = document.getElementById('searchForm');
        const initialState = document.getElementById('initialState');
        const loadingState = document.getElementById('loadingState');
        const resultsState = document.getElementById('resultsState');
        const candidateModal = document.getElementById('candidateModal');
        const historyModal = document.getElementById('historyModal');
        const exportModal = document.getElementById('exportModal');
        
        // Handle search form submission
        async function handleSearch(e) {
		    e.preventDefault();
		console.log('Search button clicked');
		    
		    // Check authentication and credits first
		    const hasAuth = await checkAuthAndCredits();
		console.log('Auth check result:', hasAuth, 'Credits:', userCredits);
			if (!hasAuth) {
				console.log('Auth failed, showing modal');
			    // Auth modal is already shown by checkAuthAndCredits()
			    return;
			}
		    
		    if (userCredits <= 0) {
		        alert('Insufficient credits. Please purchase more credits to continue.');
		        return;
		    }
		
		    const formData = new FormData(searchForm);
		    const searchParams = {
		        jobTitle: formData.get('jobTitle') || document.getElementById('jobTitle').value,
		        industry: formData.get('industry') || document.getElementById('industry').value,
		        location: formData.get('location') || document.getElementById('location').value,
		        experience: formData.get('experience') || document.getElementById('experience').value
		    };

		 console.log('Search params:', searchParams);
		    
		    // Validate required fields
		    if (!searchParams.jobTitle) {
		        alert('Please enter a job title or role');
		        return;
		    }

		console.log('Starting search animation...');
		    
		    // Show loading state
		    initialState.classList.add('hidden');
		    resultsState.classList.add('hidden');
		    loadingState.classList.remove('hidden');
		    
		    const loadingPromise = showEnhancedLoading();
		    
		    try {
			     console.log('About to deduct credit...');
		        // Deduct credit before search
		        const creditDeducted = await deductCredit();
			    console.log('Credit deducted:', creditDeducted);
		        if (!creditDeducted) {
		            throw new Error('Failed to deduct credit');
		        }
			    console.log('About to call webhook...');
		        
		        // SECURED N8N WEBHOOK CALL
		        const response = await fetch('https://montpro.app.n8n.cloud/webhook-test/leadfinder-tool', {
			    method: 'POST',
			    headers: { 
			        'Content-Type': 'application/json',
			        'Authorization': `Bearer leadfinder_secretkey123`,
			        'X-User-ID': currentUser.id
			    },
		            body: JSON.stringify({
		                ...searchParams,
		                userId: currentUser.id,
		                timestamp: new Date().toISOString()
		            })
		        });
			    console.log('Webhook response status:', response.status);
		        
		        if (!response.ok) {
		            throw new Error(`HTTP error! status: ${response.status}`);
		        }
		        
		        const data = await response.json();
		        await loadingPromise;
		        
		        if (data.success) {
		            // Save search to Supabase
		            await saveSearchToSupabase(searchParams, data.results);
		            
		            processSearchResults(data);
		            loadingState.classList.add('hidden');
		            resultsState.classList.remove('hidden');
		        }
		        
		    } catch (error) {
		        console.error('Search failed:', error);
		        
		        // Refund credit on error
		        await supabaseClient
		            .from('leadfinder_users')
		            .update({ credits: userCredits + 1 })
		            .eq('id', currentUser.id);
		        userCredits += 1;
		        updateCreditsDisplay();
		        
		        loadingState.classList.add('hidden');
		        initialState.classList.remove('hidden');
		        alert(`Search failed: ${error.message}`);
		    }
		}

		function showHistorySearchResult(searchData) {
		    // Update results description
		    const resultsTitle = document.querySelector('#resultsState h3');
		    const resultsDesc = document.querySelector('#resultsState p');
		    if (resultsTitle && resultsDesc) {
		        resultsTitle.textContent = 'Search Results';
		        resultsDesc.textContent = `Found ${searchData.resultCount} candidates matching "${searchData.jobTitle}" in ${searchData.location}`;
		    }
		
		    // Update candidate cards with saved data
		    updateCandidateCards(searchData.candidates || []);
		
		    // Update the global candidate state for filtering
		    currentCandidates = searchData.candidates || [];

			attachCandidateCardHandlers(currentCandidates);
		
		    // You can optionally update analytics or filters here
		    setTimeout(() => {
		        setupResultFilters();
		    }, 100);
		}
        
        // NEW FUNCTION: Process real backend results
        function processSearchResults(data) {
            // Store candidates globally for modal access
            currentCandidates = data.results.candidates;
            // Update results description
            const resultsTitle = document.querySelector('#resultsState h3');
            const resultsDesc = document.querySelector('#resultsState p');
            
            if (resultsTitle && resultsDesc) {
                resultsTitle.textContent = 'Search Results';
                resultsDesc.textContent = `Found ${data.results.totalFound} candidates matching "${data.query.jobTitle}" in ${data.query.location}`;
            }
            
            // Update candidate cards with real data
            updateCandidateCards(data.results.candidates);
            
            // Update analytics if you have an analytics section
            updateAnalytics(data.analytics);

            // Save to history
			saveToSearchHistory(data.query, data.results.totalFound, data.results.candidates);
			updateSearchHistoryUI();

			// Update AI Insights
			const aiInsights = generateAIInsights(data.results.candidates, data.query);
			document.getElementById('aiInsightsText').textContent = aiInsights;

			// Setup filters
			setTimeout(() => {
			    setupResultFilters();
			}, 100);

        }
        
        // NEW FUNCTION: Update candidate cards
        function updateCandidateCards(candidates) {
	    const cardsContainer = document.querySelector('#resultsState .space-y-4');
	    
	    if (!cardsContainer) return;
	    
	    // Clear existing mock cards
	    cardsContainer.innerHTML = '';
	    
	    // Create real candidate cards
	    candidates.forEach(candidate => {
	        const cardHTML = createCandidateCardHTML(candidate);
	        cardsContainer.innerHTML += cardHTML;
	    });
	    
	    // Re-attach click handlers
	    attachCandidateCardHandlers(candidates);
	}
        
        // NEW FUNCTION: Create candidate card HTML
        function createCandidateCardHTML(candidate) {
            const scorePercentage = (candidate.aiScore * 3.6); // Convert to degrees for speedometer
            
            return `
                <div class="bg-dark-secondary rounded-xl p-6 hover:bg-dark-tertiary transition-colors cursor-pointer candidate-card" data-candidate-id="${candidate.id}">
                    <div class="flex items-start justify-between">
                        <div class="flex items-start space-x-4 flex-1">
							<div class="pt-1">
				                <input type="checkbox" 
				                       class="candidate-checkbox w-4 h-4 text-accent-cyan bg-dark-primary border-gray-600 rounded focus:ring-accent-cyan focus:ring-2" 
				                       data-candidate-id="${candidate.id}"
				                       onclick="event.stopPropagation(); updateCompareButton();">
				            </div>
                            <div class="w-12 h-12 bg-gray-600 rounded-full flex items-center justify-center">
                                <span class="text-white font-semibold">${candidate.name.split(' ').map(n => n[0]).join('').substring(0, 2)}</span>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-1">
                                    <h4 class="text-lg font-semibold text-white">${candidate.name}</h4>
                                    <span class="px-2 py-1 bg-blue-500/20 text-blue-400 text-xs rounded">${candidate.source}</span>
                                </div>
                                <p class="text-gray-300 mb-2">${candidate.title}</p>
                                <p class="text-gray-400 text-sm mb-3">${candidate.location} ‚Ä¢ ${candidate.experience || 'Experienced professional'}</p>
                                <p class="text-gray-300 text-sm">${candidate.snippet}</p>
                                <div class="flex items-center space-x-4 mt-3">
                                    <span class="text-xs text-gray-400">Profile Available</span>
                                    <span class="text-xs text-gray-400">${candidate.lastUpdated}</span>
                                    ${candidate.verificationStatus === 'Verified' ? '<span class="text-xs text-accent-cyan flex items-center"><svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>Verified</span>' : ''}
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col items-center ml-4">
                            <div class="relative w-16 h-16 mb-2">
                                <div class="w-16 h-16 rounded-full score-circle flex items-center justify-center" style="--score-deg: ${scorePercentage}deg">
                                    <div class="w-12 h-12 bg-dark-secondary rounded-full flex items-center justify-center">
                                        <span class="text-accent-cyan font-bold text-sm">${candidate.aiScore}</span>
                                    </div>
                                </div>
                            </div>
                            <span class="text-xs text-gray-400">AI Score</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // NEW FUNCTION: Attach click handlers to real cards
        function attachCandidateCardHandlers(candidates) {
            document.querySelectorAll('.candidate-card').forEach((card, index) => {
                card.addEventListener('click', () => {
                    const candidateId = card.getAttribute('data-candidate-id');
                    const candidate = candidates.find(c => c.id === candidateId);
                    if (candidate) {
                        showCandidateModal(candidate);
                    }
                });
            });
        }
        
        // NEW FUNCTION: Show modal with real candidate data
        // Real candidate modal function
        function showCandidateModal(candidate) {
			activeCandidate = candidate;
            if (!candidate) return;
            
            // Update modal header
            updateModalHeader(candidate);
            
            // Update AI Analysis Summary
            updateModalAnalysis(candidate);
            
            // Update Profile Details
            updateModalProfile(candidate);
            
            // Update Key Strengths
            updateModalStrengths(candidate);
            
            // Update Concerns
            updateModalConcerns(candidate);
            
            // Update Recommendation
            updateModalRecommendation(candidate);
            
            // Show modal
            candidateModal.classList.remove('hidden');
        }

        function updateModalHeader(candidate) {
            // Update name and title
            const nameElement = candidateModal.querySelector('h2');
            const titleElement = candidateModal.querySelector('p.text-gray-300');
            const locationElement = candidateModal.querySelector('p.text-gray-400');
            
            if (nameElement) nameElement.textContent = candidate.name;
            if (titleElement) titleElement.textContent = `${candidate.title} ‚Ä¢ ${candidate.experience || 'Experienced professional'}`;
            if (locationElement) {
                const contactStatus = candidate.verificationStatus === 'Verified' ? 'Verified Profile' : 'Profile Available';
                locationElement.textContent = `${candidate.location} ‚Ä¢ ${contactStatus}`;
            }
            
            // Update score circle
            const scoreElement = candidateModal.querySelector('.text-accent-cyan.font-bold.text-lg');
            const scoreCircle = candidateModal.querySelector('.score-circle');
            
            if (scoreElement) scoreElement.textContent = candidate.aiScore;
            if (scoreCircle) {
                const scoreDegrees = candidate.aiScore * 3.6;
                scoreCircle.style.setProperty('--score-deg', `${scoreDegrees}deg`);
            }
            
            // Update initials
            const initialsElement = candidateModal.querySelector('.w-16.h-16 span');
            if (initialsElement) {
                const initials = candidate.name.split(' ').map(n => n[0]).join('').substring(0, 2);
                initialsElement.textContent = initials;
            }
        }

        function updateModalAnalysis(candidate) {
            // Update AI analysis summary text
            const summaryText = candidateModal.querySelector('.bg-dark-primary p.text-gray-300');
            if (summaryText) {
                summaryText.textContent = candidate.recommendation || 'AI analysis based on profile matching and experience relevance.';
            }
            
            // Update score breakdown bars
            const scoreBreakdown = candidate.scoreBreakdown || {};
            updateScoreBar('Role Relevance', scoreBreakdown.roleRelevance || 0);
            updateScoreBar('Experience Match', scoreBreakdown.experienceMatch || 0);
            updateScoreBar('Location Fit', scoreBreakdown.locationFit || 0);
            updateScoreBar('Profile Quality', scoreBreakdown.profileQuality || 0);
        }
        
        function updateScoreBar(label, score) {
            const scoreElements = candidateModal.querySelectorAll('.grid.grid-cols-2 > div');
            
            scoreElements.forEach(element => {
                const labelElement = element.querySelector('.text-gray-400');
                if (labelElement && labelElement.textContent === label) {
                    const progressBar = element.querySelector('.bg-accent-cyan');
                    const scoreText = element.querySelector('.text-accent-cyan');
                    
                    if (progressBar) progressBar.style.width = `${score}%`;
                    if (scoreText) scoreText.textContent = `${score}%`;
                }
            });
        }
        
        function updateModalProfile(candidate) {
            const profileSection = candidateModal.querySelector('.grid.grid-cols-1.md\\:grid-cols-2 > div:first-child');
            if (!profileSection) return;
            
            const profileData = [
                ['Experience:', candidate.experience || 'Experienced professional'],
                ['Current Role:', candidate.title],
                ['Location:', candidate.location],
                ['Source:', candidate.source],
                ['Profile Updated:', candidate.lastUpdated]
            ];
            
            const profileContent = profileSection.querySelector('.space-y-3');
            if (profileContent) {
                profileContent.innerHTML = `
                    ${profileData.map(([label, value]) => `
                        <div class="flex justify-between">
                            <span class="text-gray-400">${label}</span>
                            <span class="text-white">${value}</span>
                        </div>
                    `).join('')}
                    
                    ${candidate.companyContext ? `
                        <div class="pt-3 border-t border-gray-600">
                            <span class="text-gray-400 block mb-2">Company Context:</span>
                            <span class="text-white text-sm leading-relaxed">${candidate.companyContext}</span>
                        </div>
                    ` : ''}
                    
                    <div class="flex justify-between items-center pt-2">
                        <span class="text-gray-400">Verification:</span>
                        <div class="flex items-center space-x-2">
                            ${candidate.verificationStatus === 'Verified' ? `
                                <div class="flex items-center space-x-1 bg-accent-cyan/20 text-accent-cyan px-2 py-1 rounded-full">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.238.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                    </svg>
                                    <span class="text-sm font-medium">Verified</span>
                                </div>
                            ` : `
                                <span class="text-yellow-400 text-sm">${candidate.verificationStatus || 'Unverified'}</span>
                            `}
                        </div>
                    </div>
                `;
            }
        }
        
        function updateModalStrengths(candidate) {
            const strengthsSection = candidateModal.querySelector('.grid.grid-cols-1.md\\:grid-cols-2 > div:last-child .space-y-2');
            if (!strengthsSection) return;
            
            const strengths = candidate.strengths || ['Professional background', 'Industry experience'];
            
            strengthsSection.innerHTML = strengths.map(strength => `
                <div class="flex items-center space-x-2">
                    <div class="w-2 h-2 bg-accent-cyan rounded-full"></div>
                    <span class="text-gray-300 text-sm">${strength}</span>
                </div>
            `).join('');
        }
        
        function updateModalConcerns(candidate) {
            const concernsSection = candidateModal.querySelector('.bg-yellow-900\\/20 .space-y-2');
            if (!concernsSection) return;
            
            const concerns = candidate.concerns || ['Profile verification recommended before contact'];
            
            concernsSection.innerHTML = concerns.map(concern => `
                <div class="flex items-start space-x-2">
                    <span class="text-yellow-400">‚Ä¢</span>
                    <span>${concern}</span>
                </div>
            `).join('');
        }
        
        function updateModalRecommendation(candidate) {
            const recommendationSection = candidateModal.querySelector('.bg-accent-cyan\\/10 p.text-gray-300');
            if (!recommendationSection) return;
            
            const priority = candidate.priority || 'medium';
            const recommendation = candidate.recommendation || 'Review profile for potential match';
            
            recommendationSection.innerHTML = `
                <strong>${priority.charAt(0).toUpperCase() + priority.slice(1)} Priority Contact:</strong> ${recommendation}
            `;
        }
        
        // Update the card click handler
        function attachCandidateCardHandlers(candidates) {
            document.querySelectorAll('.candidate-card').forEach((card, index) => {
                card.addEventListener('click', () => {
                    const candidateId = card.getAttribute('data-candidate-id');
                    const candidate = candidates.find(c => c.id === candidateId);
                    if (candidate) {
                        showCandidateModal(candidate);
                    }
                });
            });
        }
        
        // NEW FUNCTION: Update analytics display
        function updateAnalytics(analytics) {
            // Update any analytics displays you have
            console.log('Search Quality:', analytics.searchQuality);
            console.log('Recommended Action:', analytics.recommendedAction);
        }

		// Generate AI insights summary
		function generateAIInsights(candidates, searchQuery) {
		    const totalCandidates = candidates.length;
		    const highScoreCandidates = candidates.filter(c => c.aiScore >= 80).length;
		    const locations = [...new Set(candidates.map(c => c.location))];
		    const experiences = candidates.map(c => {
		        const match = c.experience?.match(/(\d+)/);
		        return match ? parseInt(match[0]) : 0;
		    });
		    const avgExperience = experiences.length > 0 ? Math.round(experiences.reduce((a, b) => a + b, 0) / experiences.length) : 0;
		    
		    // Generate dynamic insights
		    let insights = `Found ${totalCandidates} candidates matching "${searchQuery.jobTitle}" in ${searchQuery.location}. `;
		    
		    if (highScoreCandidates > 0) {
		        insights += `${highScoreCandidates} candidates have high compatibility scores (80+). `;
		    }
		    
		    if (avgExperience > 0) {
		        insights += `Average experience level is ${avgExperience} years. `;
		    }
		    
		    if (locations.length > 1) {
		        insights += `Candidates are spread across ${locations.length} locations. `;
		    }
		    
		    // Add specific insights based on data
		    const verifiedCount = candidates.filter(c => c.verificationStatus === 'Verified').length;
		    if (verifiedCount > 0) {
		        insights += `${verifiedCount} profiles are verified. `;
		    }
		    
		    insights += `Best matches are ready for immediate contact.`;
		    
		    return insights;
		}

		// Update compare button based on selected candidates
		function updateCompareButton() {
		    const selectedCheckboxes = document.querySelectorAll('.candidate-checkbox:checked');
		    const compareBtn = document.getElementById('compareBtn');
		    const compareBtnText = document.getElementById('compareBtnText');
		    
		    if (selectedCheckboxes.length > 0) {
		        compareBtn.classList.remove('hidden');
		        compareBtnText.textContent = `Compare (${selectedCheckboxes.length})`;
		        
		        // Limit to max 3 selections
		        if (selectedCheckboxes.length >= 3) {
		            document.querySelectorAll('.candidate-checkbox:not(:checked)').forEach(cb => {
		                cb.disabled = true;
		                cb.parentElement.style.opacity = '0.5';
		            });
		        } else {
		            document.querySelectorAll('.candidate-checkbox').forEach(cb => {
		                cb.disabled = false;
		                cb.parentElement.style.opacity = '1';
		            });
		        }
		    } else {
		        compareBtn.classList.add('hidden');
		        document.querySelectorAll('.candidate-checkbox').forEach(cb => {
		            cb.disabled = false;
		            cb.parentElement.style.opacity = '1';
		        });
		    }
		}
		
		// Get selected candidates for comparison
		function getSelectedCandidates() {
		    const selectedCheckboxes = document.querySelectorAll('.candidate-checkbox:checked');
		    const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.candidateId);
		    return currentCandidates.filter(candidate => selectedIds.includes(candidate.id));
		}

		// Show comparison modal with selected candidates
		function showComparisonModal(candidates) {
		    const modal = document.getElementById('comparisonModal');
		    const content = document.getElementById('comparisonContent');
		    
		    // Set grid columns based on number of candidates
		    const gridCols = candidates.length === 2 ? 'grid-cols-2' : 'grid-cols-3';
		    content.className = `grid gap-6 ${gridCols}`;
		    
		    // Generate comparison content
		    content.innerHTML = candidates.map(candidate => `
		        <div class="bg-dark-primary rounded-lg p-6">
		            <!-- Header -->
		            <div class="text-center mb-4">
		                <div class="w-16 h-16 bg-gray-600 rounded-full flex items-center justify-center mx-auto mb-3">
		                    <span class="text-white font-bold text-lg">${candidate.name.split(' ').map(n => n[0]).join('').substring(0, 2)}</span>
		                </div>
		                <h3 class="text-lg font-semibold text-white">${candidate.name}</h3>
		                <p class="text-gray-300 text-sm">${candidate.title}</p>
		                <div class="mt-2">
		                    <div class="w-12 h-12 rounded-full score-circle flex items-center justify-center mx-auto" style="--score-deg: ${candidate.aiScore * 3.6}deg">
		                        <div class="w-8 h-8 bg-dark-primary rounded-full flex items-center justify-center">
		                            <span class="text-accent-cyan font-bold text-sm">${candidate.aiScore}</span>
		                        </div>
		                    </div>
		                </div>
		            </div>
		            
		            <!-- Details -->
					<div class="space-y-3 text-sm">
					    <div class="flex justify-between">
					        <span class="text-gray-400">Experience:</span>
					        <span class="text-white text-right">${candidate.experience || 'N/A'}</span>
					    </div>
					    <div class="flex justify-between">
					        <span class="text-gray-400">Location:</span>
					        <span class="text-white">${candidate.location}</span>
					    </div>
					    <div class="flex justify-between">
					        <span class="text-gray-400">Source:</span>
					        <span class="text-accent-cyan">${candidate.source}</span>
					    </div>
					    <div class="flex justify-between">
					        <span class="text-gray-400">Verified:</span>
					        <span class="text-${candidate.verificationStatus === 'Verified' ? 'accent-cyan' : 'yellow-400'}">${candidate.verificationStatus}</span>
					    </div>
					</div>
					
					<!-- Score Breakdown -->
					<div class="mt-4 pt-4 border-t border-gray-600">
					    <h4 class="text-sm font-semibold text-gray-300 mb-3">AI Score Breakdown</h4>
					    <div class="space-y-2">
					        ${Object.entries(candidate.scoreBreakdown || {}).map(([key, score]) => `
					            <div>
					                <div class="flex justify-between text-xs mb-1">
					                    <span class="text-gray-400">${key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}</span>
					                    <span class="text-accent-cyan">${score}%</span>
					                </div>
					                <div class="w-full bg-gray-600 rounded-full h-1.5">
					                    <div class="bg-accent-cyan h-1.5 rounded-full" style="width: ${score}%"></div>
					                </div>
					            </div>
					        `).join('')}
					    </div>
					</div>
					
					<!-- Key Strengths -->
					<div class="mt-4 pt-4 border-t border-gray-600">
					    <h4 class="text-sm font-semibold text-gray-300 mb-2">Key Strengths</h4>
					    <div class="space-y-1">
					        ${(candidate.strengths || []).slice(0, 3).map(strength => `
					            <div class="flex items-center space-x-2">
					                <div class="w-1.5 h-1.5 bg-accent-cyan rounded-full"></div>
					                <span class="text-gray-300 text-xs">${strength}</span>
					            </div>
					        `).join('')}
					    </div>
					</div>
		        </div>
		    `).join('');
		    
		    modal.classList.remove('hidden');
		}
        
        // Enhanced loading animation with realistic 40-60 second timing
        async function showEnhancedLoading() {
            const steps = [
                { 
                    step: 1, 
                    text: 'Initializing LinkedIn search parameters', 
                    delay: 2000, 
                    progress: 8,
                    tip: 'üîç Optimizing search criteria for best results'
                },
                { 
                    step: 2, 
                    text: 'Searching LinkedIn professional profiles', 
                    delay: 8000, 
                    progress: 25,
                    tip: 'üåê Scanning thousands of LinkedIn profiles in Indonesia'
                },
                { 
                    step: 3, 
                    text: 'Extracting candidate information', 
                    delay: 15000, 
                    progress: 40,
                    tip: 'üìä Processing profile data and work history'
                },
                { 
                    step: 4, 
                    text: 'Running AI analysis and scoring', 
                    delay: 25000, 
                    progress: 60,
                    tip: 'ü§ñ AI analyzing candidate qualifications and experience'
                },
                { 
                    step: 5, 
                    text: 'Evaluating role and experience match', 
                    delay: 35000, 
                    progress: 75,
                    tip: '‚ö° Calculating compatibility scores for each candidate'
                },
                { 
                    step: 6, 
                    text: 'Ranking candidates by compatibility', 
                    delay: 42000, 
                    progress: 90,
                    tip: 'üéØ Sorting candidates by best matches first'
                },
                { 
                    step: 7, 
                    text: 'Finalizing results and recommendations', 
                    delay: 48000, 
                    progress: 100,
                    tip: '‚ú® Preparing your personalized talent recommendations'
                }
            ];
            
            let previousDelay = 0;
	    let lastProgress = 0;
	
	    for (let stepData of steps) {
	        // Animate progress from lastProgress to stepData.progress over the segment duration
	        await smoothRandomProgress(lastProgress, stepData.progress, stepData.delay - previousDelay);
	
	        updateStepStatus(stepData.step, 'processing');
	        updateLoadingTip(stepData.tip);
	
	        await new Promise(resolve => setTimeout(resolve, 800));
	        updateStepStatus(stepData.step, 'complete');
	
	        lastProgress = stepData.progress;
	        previousDelay = stepData.delay + 800;
	    }
	
	    await new Promise(resolve => setTimeout(resolve, 500));
	    updateLoadingTip('üéâ Search completed successfully! Displaying results...');
	}
        
        function updateProgressBar(percentage) {
	    const progressBar = document.getElementById('progressBar');
	    const progressText = document.getElementById('progressPercentage');
	    if (progressBar) {
	        progressBar.style.width = `${percentage}%`;
	        progressBar.style.boxShadow = `0 0 10px rgba(0, 212, 170, 0.4)`;
	    }
	    if (progressText) {
	        progressText.textContent = `${percentage}%`;
	    }
	}

	// Smooth, randomized progress increment between two values over a set duration
	async function smoothRandomProgress(from, to, totalDuration = 1000) {
	    return new Promise(resolve => {
	        let current = from;
	        const target = to;
	        const increments = [];
	        let remaining = target - current;
	        // Create random increments between 1 and 5, sum up to the difference
	        while (remaining > 0) {
	            let step = Math.min(Math.floor(Math.random() * 5) + 1, remaining);
	            increments.push(step);
	            remaining -= step;
	        }
	        const stepDuration = totalDuration / increments.length;
	
	        function doStep(i) {
	            if (i >= increments.length) {
	                updateProgressBar(target); // make sure it hits the target
	                resolve();
	                return;
	            }
	            current += increments[i];
	            updateProgressBar(current);
	            setTimeout(() => doStep(i + 1), stepDuration);
	        }
	        doStep(0);
	    });
	}
        
        function updateStepStatus(stepNumber, status) {
            const stepElement = document.querySelector(`[data-step="${stepNumber}"]`);
            if (!stepElement) return;
            
            // Find the status span by looking for the span that contains "Pending" or other status text
            const allSpans = stepElement.querySelectorAll('span');
            let statusElement = null;
            
            // Find the span that contains status text (usually the last one)
            for (let i = allSpans.length - 1; i >= 0; i--) {
                if (allSpans[i].textContent.includes('Pending') || 
                    allSpans[i].textContent.includes('Processing') || 
                    allSpans[i].textContent.includes('Complete')) {
                    statusElement = allSpans[i];
                    break;
                }
            }
            
            // Find the number circle
            const numberCircle = stepElement.querySelector('.w-6.h-6.rounded-full');
            
            if (status === 'processing') {
                // Add hover effect to the whole step
                stepElement.classList.add('bg-dark-tertiary/30', 'rounded-lg', 'scale-[1.02]', 'transition-all');
                
                if (statusElement) {
                    statusElement.className = 'text-yellow-400 flex items-center';
                    statusElement.innerHTML = `
                        <svg class="w-4 h-4 mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        Processing...
                    `;
                }
                
                if (numberCircle) {
                    numberCircle.className = 'w-6 h-6 rounded-full bg-yellow-500 flex items-center justify-center text-xs text-dark-primary font-semibold animate-pulse';
                }
                
            } else if (status === 'complete') {
                // Remove hover effect
                stepElement.classList.remove('bg-dark-tertiary/30', 'scale-[1.02]');
                
                if (statusElement) {
                    statusElement.className = 'text-accent-cyan flex items-center font-medium';
                    statusElement.innerHTML = `
                        <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                        Complete
                    `;
                }
                
                if (numberCircle) {
                    numberCircle.className = 'w-6 h-6 rounded-full bg-accent-cyan flex items-center justify-center text-xs text-dark-primary font-semibold';
                    numberCircle.innerHTML = `
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                    `;
                }
            }
        }
        
        function updateLoadingTip(tip) {
            const tipElement = document.getElementById('loadingTip');
            if (tipElement) {
                tipElement.textContent = tip;
                
                // Add a subtle animation
                tipElement.style.opacity = '0';
                setTimeout(() => {
                    tipElement.style.opacity = '1';
                }, 100);
            }
        }

        function updateLoadingStep(stepText, status) {
            const statusContainer = document.querySelector('#loadingState .space-y-2');
            if (!statusContainer) return;
            
            const stepElements = statusContainer.querySelectorAll('.flex');
            
            stepElements.forEach(element => {
                const textSpan = element.querySelector('span:first-child');
                const statusSpan = element.querySelector('span:last-child');
                
                if (textSpan && textSpan.textContent === stepText) {
                    if (status === 'processing') {
                        statusSpan.className = 'text-yellow-400';
                        statusSpan.innerHTML = '‚è≥ Processing...';
                    } else if (status === 'complete') {
                        statusSpan.className = 'text-accent-cyan';
                        statusSpan.innerHTML = '‚úì Complete';
                    }
                }
            });
        }
        
        // Update results description based on search params
        function updateResultsDescription(params) {
            const resultsTitle = document.querySelector('#resultsState h3');
            const resultsDesc = document.querySelector('#resultsState p');
            
            if (resultsTitle && resultsDesc) {
                resultsDesc.textContent = `Found 8 candidates matching "${params.jobTitle}" in ${params.location || 'Indonesia'}`;
            }
        }
        
        // Handle different export types
        function handleExport(type) {
            switch (type) {
                case 'pdf':
                    // Generate PDF report
                    alert('PDF export functionality will be implemented with jsPDF');
                    break;
                case 'csv':
                    // Generate CSV download
                    downloadCSV();
                    break;
                case 'clipboard':
                    // Copy to clipboard
                    copyToClipboard();
                    break;
            }
            exportModal.classList.add('hidden');
        }
        
        // Download CSV function
        function downloadCSV() {
	    const csvRows = [
	        ['Name', 'Title', 'Experience', 'Location', 'AI Score', 'Source', 'Strengths', 'Concerns', 'Recommendation']
	    ];
	    (currentCandidates || []).forEach(candidate => {
	        csvRows.push([
	            candidate.name,
	            candidate.title,
	            candidate.experience,
	            candidate.location,
	            candidate.aiScore,
	            candidate.source,
	            (candidate.strengths || []).join('; '),
	            (candidate.concerns || []).join('; '),
	            candidate.recommendation || ''
	        ]);
	    });
	    const csvContent = csvRows.map(row => row.map(val => `"${(val || '').toString().replace(/"/g, '""')}"`).join(',')).join('\n');
	    const blob = new Blob([csvContent], { type: 'text/csv' });
	    const url = window.URL.createObjectURL(blob);
	    const a = document.createElement('a');
	    a.setAttribute('hidden', '');
	    a.setAttribute('href', url);
	    a.setAttribute('download', `leadfinder_results_${new Date().toISOString().split('T')[0]}.csv`);
	    document.body.appendChild(a);
	    a.click();
	    document.body.removeChild(a);
	}
        
        // Copy to clipboard function
        function copyToClipboard() {
            const textData = `LEADFINDER SEARCH RESULTS
            
Ahmad Suharto - Restaurant Manager (8 years) - Jakarta Selatan - Score: 85
Sari Permata - Operations Manager (6 years) - Jakarta Pusat - Score: 78
Budi Darma - F&B Supervisor (5 years) - Jakarta Barat - Score: 70

Generated on: ${new Date().toLocaleDateString()}`;
            
            navigator.clipboard.writeText(textData).then(() => {
                alert('Results copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy: ', err);
            });
        }
        
        // Initialize search history display
        function updateSearchHistoryCount() {
            const historyBtn = document.getElementById('searchHistoryBtn');
            const countSpan = historyBtn.querySelector('span:last-child');
            if (countSpan) {
                countSpan.textContent = searchHistory.length.toString();
            }
        }

		// Update the search history UI
		async function updateSearchHistoryUI() {
		    const history = await loadSearchHistory();
		    const historyBtn = document.getElementById('searchHistoryBtn');
		    const countSpan = historyBtn.querySelector('.bg-accent-cyan');
		    
		    if (countSpan) {
		        countSpan.textContent = history.length.toString();
		    }
		    
		    const historyModal = document.getElementById('historyModal');
		    const historyContainer = historyModal.querySelector('.space-y-4');
		    
		    if (historyContainer) {
		        if (history.length === 0) {
		            historyContainer.innerHTML = `
		                <div class="text-center py-8 text-gray-400">
		                    <svg class="w-12 h-12 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
		                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
		                    </svg>
		                    <p>No search history yet</p>
		                </div>
		            `;
		        } else {
		            // Your existing history HTML generation code stays the same
		            historyContainer.innerHTML = history.map((item, index) => `
		                <div class="bg-dark-primary rounded-lg p-4 hover:bg-dark-tertiary transition-colors cursor-pointer search-history-item" data-search-index="${index}">
		                    <div class="flex items-center justify-between mb-2">
		                        <h3 class="font-semibold text-white">${item.jobTitle || 'Untitled Search'} in ${item.location || 'Any Location'}</h3>
		                        <span class="text-sm text-gray-400">${getRelativeTime(item.timestamp)}</span>
		                    </div>
		                    <p class="text-sm text-gray-300 mb-2">${item.industry || 'Any Industry'} ‚Ä¢ ${item.experience || 'Any Experience'}</p>
		                    <div class="flex items-center justify-between">
		                        <span class="text-sm text-accent-cyan">${item.resultCount} candidates found</span>
		                        <button class="px-3 py-1 bg-accent-cyan/20 hover:bg-accent-cyan text-accent-cyan hover:text-dark-primary rounded-lg text-xs font-semibold flex items-center rerun-search-btn">
		                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
		                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
		                            </svg>
		                            Rerun Search
		                        </button>
		                    </div>
		                </div>
		            `).join('');
		            
		            window.searchHistoryData = history;
		        }
		    }
		}

		// Helper function for relative time
		function getRelativeTime(timestamp) {
		    const now = new Date();
		    const then = new Date(timestamp);
		    const diffMs = now - then;
		    const diffMins = Math.floor(diffMs / 60000);
		    const diffHours = Math.floor(diffMs / 3600000);
		    const diffDays = Math.floor(diffMs / 86400000);
		    
		    if (diffMins < 60) return `${diffMins} minutes ago`;
		    if (diffHours < 24) return `${diffHours} hours ago`;
		    return `${diffDays} days ago`;
		}
	
		function saveToSearchHistory(searchParams, resultCount, candidates) {
		    const searchEntry = {
		        id: Date.now(),
		        ...searchParams,
		        resultCount: resultCount,
		    	candidates: candidates,
		        timestamp: new Date().toISOString(),
		        date: new Date().toLocaleDateString()
		    };
		    
		    // Get existing history
		    let history = JSON.parse(localStorage.getItem('leadfinder_history') || '[]');
		    
		    // Add new search to beginning
		    history.unshift(searchEntry);
		    
		    // Keep only last 10 searches
		    history = history.slice(0, 10);
		    
		    // Save back to localStorage
		    localStorage.setItem('leadfinder_history', JSON.stringify(history));
		    
		    // Update history count in UI
			updateSearchHistoryCount();
		}
		
		// 3. REAL-TIME FILTERS FOR RESULTS
		// Add these functions for filtering
		function setupResultFilters() {
		    // Text filter
		    const filterInput = document.querySelector('#resultsState input[placeholder*="Filter by name"]');
		    if (filterInput) {
		        filterInput.addEventListener('input', (e) => {
		            filterCandidates();
		        });
		    }
			if (sortSelect) {
			    sortSelect.addEventListener('change', sortCandidates);
			}
		    
		    // Score range filter
		    const scoreRange = document.querySelector('#resultsState input[type="range"]');
		    const scoreValue = scoreRange?.nextElementSibling;
		    
		    if (scoreRange) {
		        scoreRange.addEventListener('input', (e) => {
		            if (scoreValue) {
		                scoreValue.textContent = e.target.value;
		            }
		            filterCandidates();
		        });
		    }
		    
			// Sort dropdown
			const sortSelectElement = document.getElementById('sortSelect');
			if (sortSelectElement) {
			    // Remove any existing listeners first
			    sortSelectElement.removeEventListener('change', sortCandidates);
			    // Add the listener
			    sortSelectElement.addEventListener('change', sortCandidates);
			    console.log('Sort listener attached'); // Debug line
			}
		
		// Filter candidates based on criteria
		function filterCandidates() {
		    const filterInput = document.querySelector('#resultsState input[placeholder*="Filter by name"]');
		    const scoreRange = document.querySelector('#resultsState input[type="range"]');
		    const minScore = parseInt(scoreRange?.value || 0);
		    const searchTerm = filterInput?.value.toLowerCase() || '';
		    
		    const candidateCards = document.querySelectorAll('.candidate-card');
		    let visibleCount = 0;
		    
		    candidateCards.forEach(card => {
		        const candidateId = card.getAttribute('data-candidate-id');
		        const candidate = currentCandidates.find(c => c.id === candidateId);
		        
		        if (!candidate) {
		            card.style.display = 'none';
		            return;
		        }
		        
		        // Check score
		        const meetsScore = candidate.aiScore >= minScore;
		        
		        // Check text search
		        const searchableText = `${candidate.name} ${candidate.title} ${candidate.location} ${candidate.strengths?.join(' ')}`.toLowerCase();
		        const meetsSearch = searchTerm === '' || searchableText.includes(searchTerm);
		        
		        if (meetsScore && meetsSearch) {
		            card.style.display = 'block';
		            visibleCount++;
		        } else {
		            card.style.display = 'none';
		        }
		    });
		    
		    // Update results count
		    updateResultsCount(visibleCount);
		}
		
		// Sort candidates
		function sortCandidates() {
			console.log('sortCandidates called', currentCandidates.length);
		    const sortSelectElement = document.getElementById('sortSelect');
		    const sortBy = sortSelectElement?.value || 'Sort by Score';
		    const container = document.querySelector('#resultsState .space-y-4');
		    
		    if (!container) return;
		    
		    const cards = Array.from(container.querySelectorAll('.candidate-card'));
		    
		    cards.sort((a, b) => {
		        const idA = a.getAttribute('data-candidate-id');
		        const idB = b.getAttribute('data-candidate-id');
		        const candidateA = currentCandidates.find(c => c.id === idA);
		        const candidateB = currentCandidates.find(c => c.id === idB);
		        
		        if (!candidateA || !candidateB) return 0;
		        
		        switch (sortBy) {
		            case 'Sort by Score':
		                return candidateB.aiScore - candidateA.aiScore;
		            case 'Sort by Experience':
		                // Extract years from experience string
		                const yearsA = parseInt(candidateA.experience?.match(/\d+/)?.[0] || '0');
		                const yearsB = parseInt(candidateB.experience?.match(/\d+/)?.[0] || '0');
		                return yearsB - yearsA;
		            case 'Sort by Location':
		                return candidateA.location.localeCompare(candidateB.location);
		            default:
		                return 0;
		        }
		    });
		    
		    // Reorder DOM
		    cards.forEach(card => container.appendChild(card));
		}
		
		// Update visible results count
		function updateResultsCount(visibleCount) {
		    const resultsDesc = document.querySelector('#resultsState p');
		    if (resultsDesc && currentCandidates.length > 0) {
		        const totalCount = currentCandidates.length;
		        if (visibleCount < totalCount) {
		            resultsDesc.textContent = `Showing ${visibleCount} of ${totalCount} candidates`;
		        } else {
		            resultsDesc.textContent = `Found ${totalCount} candidates matching your search`;
		        }
		    }
		}

		function showExportToast(text = "Exporting...") {
		    const toast = document.getElementById('exportToast');
		    const toastText = document.getElementById('exportToastText');
		    toastText.textContent = text;
		    toast.classList.remove('hidden');
		}
		function hideExportToast() {
		    const toast = document.getElementById('exportToast');
		    toast.classList.add('hidden');
		}

		function exportCandidateToCSV(candidate) {
		    if (!candidate) return;
		    const csvRows = [
		        ["Name", "Title", "Experience", "Location", "AI Score", "Source", "Strengths", "Concerns", "Recommendation"],
		        [
		            candidate.name,
		            candidate.title,
		            candidate.experience,
		            candidate.location,
		            candidate.aiScore,
		            candidate.source,
		            (candidate.strengths || []).join("; "),
		            (candidate.concerns || []).join("; "),
		            candidate.recommendation || ""
		        ]
		    ];
		    const csvContent = csvRows.map(row => row.map(value => `"${(value || '').toString().replace(/"/g, '""')}"`).join(",")).join("\n");
		    const blob = new Blob([csvContent], { type: 'text/csv' });
		    const url = window.URL.createObjectURL(blob);
		    const a = document.createElement('a');
		    a.setAttribute('hidden', '');
		    a.setAttribute('href', url);
		    a.setAttribute('download', `candidate_${candidate.name.replace(/\s+/g, "_")}_${new Date().toISOString().split('T')[0]}.csv`);
		    document.body.appendChild(a);
		    a.click();
		    document.body.removeChild(a);
		}

		function exportCandidateToPDF(candidate) {
		    if (!candidate) return;
		    const { jsPDF } = window.jspdf;
		    const doc = new jsPDF();
		
		    // Title
		    doc.setFontSize(18);
		    doc.setTextColor(0, 212, 170);
		    doc.text("Candidate Profile", 14, 16);
		
		    // Basic info
		    doc.setFontSize(12);
		    doc.setTextColor(34, 34, 34);
		    let y = 30;
		    doc.text(`Name: ${candidate.name}`, 14, y);      y += 8;
		    doc.text(`Title: ${candidate.title}`, 14, y);    y += 8;
		    doc.text(`Experience: ${candidate.experience || ''}`, 14, y); y += 8;
		    doc.text(`Location: ${candidate.location}`, 14, y);  y += 8;
		    doc.text(`AI Score: ${candidate.aiScore}`, 14, y);   y += 8;
		    doc.text(`Source: ${candidate.source}`, 14, y);      y += 8;
		
		    // AI Analysis Summary (metrics)
		    doc.setFont(undefined, "bold");
		    doc.text("AI Analysis Metrics:", 14, y); y += 6;
		    doc.setFont(undefined, "normal");
		    const m = candidate.scoreBreakdown || {};
		    doc.text(`- Role Relevance: ${m.roleRelevance ?? 'N/A'}%`, 18, y); y += 6;
		    doc.text(`- Experience Match: ${m.experienceMatch ?? 'N/A'}%`, 18, y); y += 6;
		    doc.text(`- Location Fit: ${m.locationFit ?? 'N/A'}%`, 18, y); y += 6;
		    doc.text(`- Profile Quality: ${m.profileQuality ?? 'N/A'}%`, 18, y); y += 8;
		
		    // Company Context
		    doc.setFont(undefined, "bold");
		    doc.text("Company Context:", 14, y); y += 6;
		    doc.setFont(undefined, "normal");
		    doc.text(doc.splitTextToSize(
		        candidate.companyContext || "No company context provided.",
		        180), 18, y);
		    y += Math.max(12, doc.splitTextToSize(candidate.companyContext || "", 180).length * 6);
		
		    // Strengths
		    doc.setFont(undefined, "bold");
		    doc.text("Key Strengths:", 14, y);
		    doc.setFont(undefined, "normal");
		    y += 6;
		    (candidate.strengths || []).forEach(strength => {
		        doc.text(`- ${strength}`, 18, y);
		        y += 6;
		    });
		
		    // Concerns
		    if (candidate.concerns && candidate.concerns.length > 0) {
		        doc.setFont(undefined, "bold");
		        doc.text("Concerns:", 14, y);
		        doc.setFont(undefined, "normal");
		        y += 6;
		        (candidate.concerns || []).forEach(concern => {
		            doc.text(`- ${concern}`, 18, y);
		            y += 6;
		        });
		    }
		
		    // Recommendation
		    if (candidate.recommendation) {
		        doc.setFont(undefined, "bold");
		        doc.text("AI Recommendation:", 14, y);
		        doc.setFont(undefined, "normal");
		        y += 6;
		        doc.text(doc.splitTextToSize(candidate.recommendation, 180), 18, y);
		        y += 12;
		    }
		
		    doc.save(`candidate_${candidate.name.replace(/\s+/g, "_")}_${new Date().toISOString().split('T')[0]}.pdf`);
		}

		function exportCandidateToClipboard(candidate) {
		    if (!candidate) return;
		    const m = candidate.scoreBreakdown || {};
		    const text = `
		Candidate Profile - ${candidate.name}
		---------------------------------------
		
		Title: ${candidate.title}
		Experience: ${candidate.experience || ''}
		Location: ${candidate.location}
		AI Score: ${candidate.aiScore}
		Source: ${candidate.source}
		
		AI Analysis Metrics:
		- Role Relevance: ${m.roleRelevance ?? 'N/A'}%
		- Experience Match: ${m.experienceMatch ?? 'N/A'}%
		- Location Fit: ${m.locationFit ?? 'N/A'}%
		- Profile Quality: ${m.profileQuality ?? 'N/A'}%
		
		Company Context:
		${candidate.companyContext || "No company context provided."}
		
		Key Strengths:
		${(candidate.strengths || []).map(s => `- ${s}`).join('\n')}
		
		${candidate.concerns && candidate.concerns.length > 0 ? "Concerns:\n" + candidate.concerns.map(c => `- ${c}`).join('\n') + "\n" : ""}
		${candidate.recommendation ? "AI Recommendation:\n" + candidate.recommendation : ""}
		    `.trim();
		
		    navigator.clipboard.writeText(text).then(() => {
		        showExportToast("Copied to clipboard!");
		        setTimeout(hideExportToast, 1200);
		    }).catch(() => {
		        alert("Failed to copy to clipboard.");
		    });
		}
        
       		// Initialize app
		// Set up auth listener IMMEDIATELY when script loads (before DOMContentLoaded)
		console.log("Registering auth state change listener...");
		supabaseClient.auth.onAuthStateChange(async (event, session) => {
		    console.log('Auth state changed:', event, session?.user?.email);
		    if (event === 'SIGNED_IN') {
		        console.log('User signed in:', session.user.email);
		        currentUser = session.user;
		        hideAuthModal();
		        await checkAuthAndCredits();
		        updateCreditsDisplay();
		    } else if (event === 'SIGNED_OUT') {
		        currentUser = null;
		        userCredits = 0;
		        updateCreditsDisplay();
		    }
		});
			
		document.addEventListener('DOMContentLoaded', async () => {
		    console.log('DOM loaded, checking auth...');
		    
		    // Check for existing session
		    const { data: { session }, error } = await supabaseClient.auth.getSession();
		    console.log('Session check:', session, error);
		    
		    if (session && session.user) {
		        console.log('Found session for:', session.user.email);
		        currentUser = session.user;
		        
		        // Now check/create user profile
		        await checkAuthAndCredits();
		        updateCreditsDisplay();
		    } else {
		        console.log('No session found, showing auth modal');
		        showAuthModal();
		    }
		    
		    // Update history UI regardless of auth state
		    updateSearchHistoryUI();
		    document.getElementById('jobTitle').focus();
		});

		// Event listeners
	        searchForm.addEventListener('submit', handleSearch);
	        document.getElementById('searchHistoryBtn').addEventListener('click', () => historyModal.classList.remove('hidden'));
	        document.getElementById('closeModal').addEventListener('click', () => candidateModal.classList.add('hidden'));
	        document.getElementById('closeHistoryModal').addEventListener('click', () => historyModal.classList.add('hidden'));
	        document.getElementById('closeExportModal').addEventListener('click', () => exportModal.classList.add('hidden'));
			// Compare button click handler
			document.getElementById('compareBtn').addEventListener('click', () => {
			    const selectedCandidates = getSelectedCandidates();
			    if (selectedCandidates.length > 0) {
			        showComparisonModal(selectedCandidates);
			    }
			});
			
			// Close comparison modal
			document.getElementById('closeComparisonModal').addEventListener('click', () => {
			    document.getElementById('comparisonModal').classList.add('hidden');
			});
	        
	        // Sample search button
	        document.getElementById('sampleSearchBtn').addEventListener('click', () => {
			    document.getElementById('jobTitle').value = 'Restaurant Manager';
			    document.getElementById('industry').value = 'hospitality';
			    document.getElementById('location').value = 'jakarta';
			    document.getElementById('experience').value = 'mid';
			 
			});
	        
	        // Add click handlers for candidate cards
	        document.addEventListener('click', (e) => {
	            if (e.target.closest('.candidate-card')) {
	                candidateModal.classList.remove('hidden');
	            }
	        });
	
		document.getElementById('exportBtn').addEventListener('click', async () => {
		    showExportToast("Exporting CSV...");
		    // Wait 1s for effect (simulate processing)
		    await new Promise(r => setTimeout(r, 1000));
		    downloadCSV();
		    hideExportToast();
		});
		
	        // Close modals when clicking outside
	        document.addEventListener('click', (e) => {
	            if (e.target === candidateModal) candidateModal.classList.add('hidden');
	            if (e.target === historyModal) historyModal.classList.add('hidden');
	            if (e.target === exportModal) exportModal.classList.add('hidden');
	        });
	        
	        // Export functionality
	        document.addEventListener('click', (e) => {
	            if (e.target.closest('button') && e.target.closest('button').textContent.includes('PDF Report')) {
	                handleExport('pdf');
	            } else if (e.target.closest('button') && e.target.closest('button').textContent.includes('CSV Spreadsheet')) {
	                handleExport('csv');
	            } else if (e.target.closest('button') && e.target.closest('button').textContent.includes('Copy to Clipboard')) {
	                handleExport('clipboard');
	            }
	        });
	
		// Add event delegation for history item clicks
		document.addEventListener('click', (e) => {
		    if (e.target.classList.contains('rerun-search-btn')) {
		        e.stopPropagation();
		        const historyItem = e.target.closest('.search-history-item');
		        const searchIndex = parseInt(historyItem.dataset.searchIndex);
		        const searchData = window.searchHistoryData[searchIndex];
		        
		        // Fill form with historical search
		        document.getElementById('jobTitle').value = searchData.jobTitle || '';
		        document.getElementById('industry').value = searchData.industry || '';
		        document.getElementById('location').value = searchData.location || '';
		        document.getElementById('experience').value = searchData.experience || '';
		        
		        // Close modal and run search
		        historyModal.classList.add('hidden');
		        searchForm.dispatchEvent(new Event('submit'));
		    }
		});
        
	        // Keyboard shortcuts
	        document.addEventListener('keydown', (e) => {
	            // Escape key closes modals
	            if (e.key === 'Escape') {
	                candidateModal.classList.add('hidden');
	                historyModal.classList.add('hidden');
	                exportModal.classList.add('hidden');
	            }
	            
	            // Ctrl/Cmd + Enter submits search
	            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
	                if (!loadingState.classList.contains('hidden')) return;
	                handleSearch(e);
	            }
	        });
		    
		    (async () => {
			    await updateSearchHistoryUI();
			    document.getElementById('jobTitle').focus();
			})();
		    
		    const searchBtn = document.getElementById('searchBtn');
		    searchBtn.addEventListener('mouseenter', () => {
		        if (!searchBtn.disabled) {
		            searchBtn.classList.add('transform', 'scale-105');
		        }
		    });
		    searchBtn.addEventListener('mouseleave', () => {
		        searchBtn.classList.remove('transform', 'scale-105');
		    });

		// Candidate modal export handlers
		document.addEventListener('click', async (e) => {
		    const btn = e.target.closest('.export-modal-btn');
		    if (btn) {
		        const type = btn.dataset.type;
		        showExportToast(`Exporting ${type.toUpperCase()}...`);
		        await new Promise(r => setTimeout(r, 1000));
		        if (type === 'pdf') {
		            exportCandidateToPDF(activeCandidate);
		        } else if (type === 'csv') {
		            exportCandidateToCSV(activeCandidate);
		        } else if (type === 'clipboard') {
		            exportCandidateToClipboard(activeCandidate);
		        }
		        hideExportToast();
		    }
		});
	
		window.addEventListener("load", async () => {
			console.log("Adding window load event listener...");
		    const { data: { session } } = await supabaseClient.auth.getSession();
		    if (session && session.user) {
		        currentUser = session.user;
		        await checkAuthAndCredits();
		        updateCreditsDisplay();
		    }
		});
        
        // Mock API response structure for reference
        const mockApiResponse = {
            success: true,
            query: {
                jobTitle: "Restaurant Manager",
                industry: "hospitality",
                location: "jakarta",
                experience: "mid"
            },
            results: {
                totalFound: 8,
                candidates: [
                    {
                        id: "candidate_001",
                        name: "Ahmad Suharto",
                        title: "Restaurant Manager",
                        experience: "8 years",
                        location: "Jakarta Selatan",
                        industry: "Hospitality & Tourism",
                        snippet: "Experienced restaurant manager with strong leadership...",
                        profileUrl: "https://jobstreet.co.id/profile/ahmad-suharto",
                        source: "JobStreet",
                        aiScore: 85,
                        scoreBreakdown: {
                            roleRelevance: 90,
                            experienceMatch: 85,
                            locationFit: 95,
                            profileQuality: 70
                        },
                        lastUpdated: "2 days ago",
                        strengths: [
                            "Team Leadership & Management",
                            "Fine Dining Experience",
                            "Cost Control & Budget Management"
                        ],
                        concerns: [
                            "Profile hasn't been updated in 2 weeks",
                            "Current employment status unclear"
                        ]
                    }
                ]
            },
            searchId: "search_" + Date.now(),
            timestamp: new Date().toISOString()
        };
        
        // Function to handle real API integration
        async function callN8NWebhook(searchParams) {
            // Replace with your actual N8N webhook URL
            const webhookUrl = 'https://your-n8n-instance.com/webhook/leadfinder-search';
            
            try {
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: searchParams,
                        timestamp: new Date().toISOString(),
                        userId: 'current-user-id' // You'll get this from Supabase auth
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                return data;
                
            } catch (error) {
                console.error('N8N webhook call failed:', error);
                throw error;
            }
        }
	}
	
    </script>
</body>
</html>
