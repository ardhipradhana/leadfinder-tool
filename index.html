<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leadfinder - AI-Powered Lead Discovery</title>
    <link rel="icon" type="image/png" href="LinkedIn_Image_Template__15_-removebg-preview.png">
    <script src="https://cdn.tailwindcss.com"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dark-primary': '#1a1a2e',
                        'dark-secondary': '#16213e',
                        'dark-tertiary': '#0f3460',
                        'accent-cyan': '#00d4aa',
                        'accent-teal': '#4ecdc4',
                    }
                }
            }
        }
    </script>
	
    <style>
        .score-circle {
            background: conic-gradient(from 0deg, #00d4aa 0deg, #00d4aa var(--score-deg), #374151 var(--score-deg), #374151 360deg);
        }
        .step-item {
            transition: all 0.3s ease-in-out;
        }
        
        .step-item:hover {
            background-color: rgba(15, 52, 96, 0.3);
            border-radius: 8px;
            padding: 8px;
            margin: -8px;
        }
        
        #loadingTip {
            transition: opacity 0.3s ease-in-out;
        }
        
        #progressBar {
            transition: all 0.5s ease-out;
            position: relative;
        }

        .company-context {
            line-height: 1.6;
            margin-top: 0.75rem;
        }
        
        .verification-badge {
            background: linear-gradient(135deg, #00d4aa, #4ecdc4);
            box-shadow: 0 2px 4px rgba(0, 212, 170, 0.3);
        }
        
        .verification-badge svg {
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1));
        }

		.enhanced-score-circle {
		    background: conic-gradient(
		        from 0deg, 
		        var(--score-color) 0deg, 
		        var(--score-color) var(--score-deg), 
		        #374151 var(--score-deg), 
		        #374151 360deg
		    );
		    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
		    position: relative;
		}
		
		.enhanced-score-circle::before {
		    content: '';
		    position: absolute;
		    inset: 2px;
		    border-radius: 50%;
		    background: conic-gradient(
		        from 0deg,
		        rgba(255, 255, 255, 0.1) 0deg,
		        rgba(255, 255, 255, 0.1) var(--score-deg),
		        transparent var(--score-deg),
		        transparent 360deg
		    );
		}

		.candidate-card {
			transition: all 0.3s ease-in-out;
			border: 1px solid transparent;
		}
		
		.candidate-card:hover {
			transform: translateY(-2px);
			box-shadow: 0 8px 25px rgba(0, 212, 170, 0.15);
			border-color: rgba(0, 212, 170, 0.3);
			background: linear-gradient(135deg, #16213e 0%, #1a1a2e 100%);
		}
		
		.candidate-card:hover .enhanced-score-circle {
			transform: scale(1.05);
			filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.4));
		}
		
		.candidate-card:hover h4 {
			color: #00d4aa;
			transition: color 0.3s ease;
		}
		
		.candidate-card:hover .verification-badge,
		.candidate-card:hover [class*="priority-badge"] {
			transform: scale(1.02);
			transition: transform 0.3s ease;
		}

		.source-badge {
			backdrop-filter: blur(8px);
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
			transition: all 0.3s ease;
		}
		
		.source-badge:hover {
			transform: translateY(-1px);
			box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
		}

	    	.salary-badge {
		    background: linear-gradient(135deg, #059669, #10b981);
		    box-shadow: 0 2px 4px rgba(5, 150, 105, 0.3);
		}
		
		.difficulty-easy { @apply bg-green-500/20 text-green-400 border-green-500/30; }
		.difficulty-medium { @apply bg-yellow-500/20 text-yellow-400 border-yellow-500/30; }
		.difficulty-hard { @apply bg-red-500/20 text-red-400 border-red-500/30; }

    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- Header -->
    <header class="bg-dark-primary border-b border-gray-700 px-6 py-4">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="w-8 h-8 bg-accent-cyan rounded-lg flex items-center justify-center">
                    <svg class="w-5 h-5 text-dark-primary" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <h1 class="text-xl font-semibold text-white">Leadfinder Tool</h1>
            </div>
            
            <div class="flex items-center space-x-4">
                <button id="searchHistoryBtn" class="flex items-center space-x-2 px-3 py-2 rounded-lg bg-dark-secondary hover:bg-dark-tertiary transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span>Recent Searches</span>
                    <span class="bg-accent-cyan text-dark-primary px-2 py-1 rounded-full text-xs font-medium">3</span>
                </button>
                
                <div class="flex items-center space-x-2 px-3 py-2 rounded-lg bg-dark-secondary">
                    <svg class="w-4 h-4 text-accent-cyan" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V4z"/>
                    </svg>
                	<span id="creditsDisplay" class="text-accent-cyan font-medium">0 credits</span>
                    <span class="text-gray-400">‚Ä¢ LinkedIn Search</span>
                </div>
                
                <button class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition-colors">
                    Log Out
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-6 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Search Form -->
            <div class="lg:col-span-1">
                <div class="bg-dark-secondary rounded-xl p-6">
                    <h2 class="text-xl font-semibold mb-6 text-white">Find Talent</h2>
                    <p class="text-gray-300 mb-6">Search for candidates from LinkedIn with AI-powered ranking</p>
                    
                    <form id="searchForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Job Title / Role</label>
                            <input type="text" id="jobTitle" placeholder="e.g. Restaurant Manager, Cashier, Cook" 
                                   class="w-full px-4 py-3 bg-dark-primary border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:border-accent-cyan focus:outline-none">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Industry</label>
                            <select id="industry" class="w-full px-4 py-3 bg-dark-primary border border-gray-600 rounded-lg text-white focus:border-accent-cyan focus:outline-none">
                                <option value="">Select Industry</option>
                                <option value="hospitality">Hospitality & Tourism</option>
                                <option value="retail">Retail & Commerce</option>
                                <option value="food-beverage">Food & Beverage</option>
                                <option value="manufacturing">Manufacturing</option>
                                <option value="technology">Technology</option>
                                <option value="healthcare">Healthcare</option>
                                <option value="finance">Finance</option>
                                <option value="education">Education</option>
                                <option value="custom">Other (Custom Industry)</option>
                            </select>
				<!-- Custom Industry Input (hidden by default) -->
				<input type="text" id="customIndustry" placeholder="Enter custom industry (e.g., Gaming, Logistics, Real Estate)" 
				       class="w-full px-4 py-3 bg-dark-primary border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:border-accent-cyan focus:outline-none hidden mt-3">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Location</label>
                            <select id="location" class="w-full px-4 py-3 bg-dark-primary border border-gray-600 rounded-lg text-white focus:border-accent-cyan focus:outline-none">
                                <option value="">Select Location</option>
                                <option value="jakarta">Jakarta</option>
                                <option value="surabaya">Surabaya</option>
                                <option value="bandung">Bandung</option>
                                <option value="medan">Medan</option>
                                <option value="semarang">Semarang</option>
								<option value="solo">Solo</option>
								<option value="yogyakarta">Yogyakarta</option>
								<option value="bali">Bali</option>
                                <option value="makassar">Makassar</option>
								<option value="manado">Manado</option>
                                <option value="palembang">Palembang</option>
                                <option value="tangerang">Tangerang</option>
                                <option value="depok">Depok</option>
                                <option value="bekasi">Bekasi</option>
				    			<option value="other">Other (Custom Location)</option>
                            </select>
							<!-- Custom Location Input (hidden by default) -->
							<input type="text" id="customLocation" placeholder="Enter custom location (e.g., Lampung, Malang, Remote)" 
							       class="w-full px-4 py-3 bg-dark-primary border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:border-accent-cyan focus:outline-none hidden mt-3">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Experience Level</label>
                            <select id="experience" class="w-full px-4 py-3 bg-dark-primary border border-gray-600 rounded-lg text-white focus:border-accent-cyan focus:outline-none">
                                <option value="">Any Experience</option>
                                <option value="entry">Entry Level (0-2 years)</option>
                                <option value="mid">Mid Level (3-5 years)</option>
                                <option value="senior">Senior Level (6+ years)</option>
                                <option value="manager">Management Level</option>
                            </select>
                        </div>
                        
                        <div class="mb-4 space-y-3">
						    <h3 class="text-white font-semibold mb-3">Choose Search Type</h3>
						    
						    <!-- Standard Option -->
						    <label class="block cursor-pointer">
						        <input type="radio" name="searchType" value="standard" checked class="sr-only peer">
						        <div class="p-4 bg-dark-primary border-2 border-gray-600 rounded-lg peer-checked:border-accent-cyan peer-checked:bg-accent-cyan/10 transition-all">
						            <div class="flex justify-between items-start">
						                <div>
						                    <h4 class="font-semibold text-white">Standard Search</h4>
						                    <p class="text-gray-400 text-sm">AI candidate matching and basic analysis</p>
						                </div>
						                <span class="text-accent-cyan font-bold">1 Credit</span>
						            </div>
						        </div>
						    </label>
						    
						    <!-- Premium Option -->
						    <label class="block cursor-pointer">
						        <input type="radio" name="searchType" value="premium" class="sr-only peer">
						        <div class="p-4 bg-gradient-to-r from-purple-900/20 to-blue-900/20 border-2 border-purple-500/50 rounded-lg peer-checked:border-purple-400 peer-checked:from-purple-500/20 peer-checked:to-blue-500/20 transition-all">
						            <div class="flex justify-between items-start">
						                <div>
						                    <div class="flex items-center space-x-2 mb-1">
						                        <h4 class="font-semibold text-white">Premium Analytics</h4>
						                        <span class="bg-gradient-to-r from-purple-500 to-blue-500 text-white px-2 py-1 rounded-full text-xs font-bold">NEW</span>
						                    </div>
						                    <p class="text-gray-300 text-sm">+ Career trajectory prediction, potential scoring & growth recommendations</p>
						                </div>
						                <span class="text-purple-400 font-bold">10 Credits</span>
						            </div>
						        </div>
						    </label>
						</div>

						<div class="pt-4">
						    <button type="submit" id="searchBtn" class="w-full bg-accent-cyan hover:bg-accent-teal text-dark-primary font-semibold py-3 px-6 rounded-lg transition-colors flex items-center justify-center space-x-2">
						        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
						        </svg>
						        <span id="searchBtnText">Search Talent</span>
						    </button>
						    <p id="creditInfo" class="text-sm text-gray-400 mt-2 text-center">üîç AI will match candidates against your criteria (Uses 1 credit)</p>
						</div>
                    </form>
                </div>
            </div>
            
            <!-- Results Area -->
            <div class="lg:col-span-2">
                <!-- Initial State -->
                <div id="initialState" class="bg-dark-secondary rounded-xl p-8 text-center">
                    <div class="w-16 h-16 bg-accent-cyan/20 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-accent-cyan" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                    </div>
                    <h3 class="text-xl font-semibold text-white mb-2">Ready to Find Talent</h3>
                    <p class="text-gray-400 mb-6">Fill in the search criteria and AI will find the best matching candidates across multiple platforms</p>
                    <div class="flex justify-center">
                        <button id="sampleSearchBtn" class="px-6 py-2 bg-dark-primary hover:bg-dark-tertiary rounded-lg text-accent-cyan border border-accent-cyan transition-colors">
                            Try Sample Search
                        </button>
                    </div>
                </div>
                
                <!-- Loading State -->
                <div id="loadingState" class="bg-dark-secondary rounded-xl p-8 text-center hidden">
                    <div class="animate-spin w-12 h-12 border-4 border-accent-cyan border-t-transparent rounded-full mx-auto mb-4"></div>
                    <h3 class="text-xl font-semibold text-white mb-2">AI-Powered Talent Discovery</h3>
                    <p class="text-gray-400 mb-6">Searching LinkedIn and analyzing candidates with artificial intelligence</p>
                    
                    <!-- Progress Bar -->
                    <div class="mb-6">
                        <div class="flex justify-between text-sm text-gray-300 mb-2">
                            <span>Progress</span>
                            <span id="progressPercentage">0%</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-3">
                            <div id="progressBar" class="bg-gradient-to-r from-accent-cyan to-accent-teal h-3 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <!-- Detailed Steps -->
                    <div class="bg-dark-primary rounded-lg p-4">
                        <div class="text-sm text-gray-300 space-y-3" id="loadingSteps">
                            <div class="flex items-center justify-between step-item" data-step="1">
                                <div class="flex items-center space-x-3">
                                    <div class="w-6 h-6 rounded-full bg-gray-600 flex items-center justify-center text-xs text-white">1</div>
                                    <span>Initializing LinkedIn search parameters</span>
                                </div>
                                <span class="text-gray-500">‚è∏ Pending</span>
                            </div>
                            <div class="flex items-center justify-between step-item" data-step="2">
                                <div class="flex items-center space-x-3">
                                    <div class="w-6 h-6 rounded-full bg-gray-600 flex items-center justify-center text-xs text-white">2</div>
                                    <span>Searching LinkedIn professional profiles</span>
                                </div>
                                <span class="text-gray-500">‚è∏ Pending</span>
                            </div>
                            <div class="flex items-center justify-between step-item" data-step="3">
                                <div class="flex items-center space-x-3">
                                    <div class="w-6 h-6 rounded-full bg-gray-600 flex items-center justify-center text-xs text-white">3</div>
                                    <span>Extracting candidate information</span>
                                </div>
                                <span class="text-gray-500">‚è∏ Pending</span>
                            </div>
                            <div class="flex items-center justify-between step-item" data-step="4">
                                <div class="flex items-center space-x-3">
                                    <div class="w-6 h-6 rounded-full bg-gray-600 flex items-center justify-center text-xs text-white">4</div>
                                    <span>Running AI analysis and scoring</span>
                                </div>
                                <span class="text-gray-500">‚è∏ Pending</span>
                            </div>
                            <div class="flex items-center justify-between step-item" data-step="5">
                                <div class="flex items-center space-x-3">
                                    <div class="w-6 h-6 rounded-full bg-gray-600 flex items-center justify-center text-xs text-white">5</div>
                                    <span>Evaluating role and experience match</span>
                                </div>
                                <span class="text-gray-500">‚è∏ Pending</span>
                            </div>
                            <div class="flex items-center justify-between step-item" data-step="6">
                                <div class="flex items-center space-x-3">
                                    <div class="w-6 h-6 rounded-full bg-gray-600 flex items-center justify-center text-xs text-white">6</div>
                                    <span>Ranking candidates by compatibility</span>
                                </div>
                                <span class="text-gray-500">‚è∏ Pending</span>
                            </div>
                            <div class="flex items-center justify-between step-item" data-step="7">
                                <div class="flex items-center space-x-3">
                                    <div class="w-6 h-6 rounded-full bg-gray-600 flex items-center justify-center text-xs text-white">7</div>
                                    <span>Finalizing results and recommendations</span>
                                </div>
                                <span class="text-gray-500">‚è∏ Pending</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Fun Facts -->
                    <div class="mt-4 text-xs text-gray-400" id="loadingTip">
                        üí° Tip: Higher AI scores indicate better role compatibility
                    </div>
                </div>
                
                <!-- Results State -->
                <div id="resultsState" class="hidden">
				    <!-- AI Insights Box -->
				    <div id="aiInsightsBox" class="bg-gradient-to-r from-accent-cyan/10 to-accent-teal/10 border border-accent-cyan/30 rounded-xl p-6 mb-6">
				        <div class="flex items-start space-x-3">
				            <div class="w-10 h-10 bg-accent-cyan/20 rounded-lg flex items-center justify-center flex-shrink-0">
				                <svg class="w-6 h-6 text-accent-cyan" fill="currentColor" viewBox="0 0 20 20">
				                    <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
				                </svg>
				            </div>
				            <div class="flex-1">
				                <h3 class="text-lg font-semibold text-accent-cyan mb-2 flex items-center">
				                    AI Search Insights
				                </h3>
				                <p id="aiInsightsText" class="text-gray-300 leading-relaxed">
				                    Analyzing candidates and generating insights...
				                </p>
				            </div>
				        </div>
				    </div>
				
				    <!-- Filter and Controls Section -->
				    <div class="bg-dark-secondary rounded-xl p-6 mb-6">
				        <!-- Enhanced Filter Bar -->
				        <div class="space-y-4 p-4 bg-dark-primary rounded-lg mb-4">
				            <!-- First Row: Text Search and Score Filter -->
				            <div class="flex flex-col md:flex-row md:items-center space-y-3 md:space-y-0 md:space-x-6">
				                <div class="flex-1">
				                    <input type="text" id="nameFilter" placeholder="Filter by name, title, skills..." class="w-full px-3 py-2 bg-dark-secondary border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:border-accent-cyan focus:outline-none">
				                </div>
				                
				                <div class="flex items-center space-x-3">
				                    <span class="text-sm text-gray-400 whitespace-nowrap">Min Score:</span>
				                    <input type="range" id="scoreFilter" min="0" max="100" value="0" class="w-20 accent-accent-cyan">
				                    <span id="scoreValue" class="text-sm text-accent-cyan font-medium w-8">0</span>
				                </div>
				            </div>
				            
				            <!-- Second Row: Other Filters -->
				            <div class="flex flex-wrap items-center gap-4">
				                <!-- Experience Filter -->
				                <div class="flex items-center space-x-3">
				                    <span class="text-sm text-gray-400">Experience:</span>
				                    <div class="flex items-center space-x-2">
				                        <span class="text-xs text-gray-500">0y</span>
				                        <input type="range" id="experienceFilter" min="0" max="15" value="0" class="w-24 accent-accent-cyan">
				                        <span class="text-xs text-gray-500">15y+</span>
				                    </div>
				                    <span id="experienceValue" class="text-sm text-accent-cyan font-medium">0+</span>
				                </div>
				                
				                <!-- Verification Filter -->
				                <div class="flex items-center space-x-3">
				                    <span class="text-sm text-gray-400">Verified:</span>
				                    <label class="flex items-center space-x-2 cursor-pointer">
				                        <input type="checkbox" id="verifiedFilter" class="w-4 h-4 text-accent-cyan bg-dark-secondary border-gray-600 rounded focus:ring-accent-cyan focus:ring-2">
				                        <span class="text-sm text-gray-300">Only verified</span>
				                    </label>
				                </div>
				                
				                <!-- Location Filter -->
				                <div class="relative">
				                    <button id="locationFilterBtn" class="flex items-center space-x-2 px-3 py-2 bg-dark-secondary border border-gray-600 rounded-lg text-white hover:border-accent-cyan transition-colors">
				                        <span class="text-sm">All Locations</span>
				                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
				                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
				                        </svg>
				                    </button>
				                    
				                    <!-- Location Dropdown -->
				                    <div id="locationDropdown" class="hidden absolute top-full left-0 mt-1 w-48 bg-dark-secondary border border-gray-600 rounded-lg shadow-lg z-10 max-h-48 overflow-y-auto">
									    <div class="p-2 space-y-1">
									        <label class="flex items-center space-x-2 p-2 hover:bg-dark-tertiary rounded cursor-pointer">
									            <input type="checkbox" class="location-checkbox w-4 h-4 text-accent-cyan" value="jakarta" checked>
									            <span class="text-sm text-gray-300">Jakarta</span>
									        </label>
									        <label class="flex items-center space-x-2 p-2 hover:bg-dark-tertiary rounded cursor-pointer">
									            <input type="checkbox" class="location-checkbox w-4 h-4 text-accent-cyan" value="surabaya" checked>
									            <span class="text-sm text-gray-300">Surabaya</span>
									        </label>
									        <label class="flex items-center space-x-2 p-2 hover:bg-dark-tertiary rounded cursor-pointer">
									            <input type="checkbox" class="location-checkbox w-4 h-4 text-accent-cyan" value="bandung" checked>
									            <span class="text-sm text-gray-300">Bandung</span>
									        </label>
									        <label class="flex items-center space-x-2 p-2 hover:bg-dark-tertiary rounded cursor-pointer">
									            <input type="checkbox" class="location-checkbox w-4 h-4 text-accent-cyan" value="medan" checked>
									            <span class="text-sm text-gray-300">Medan</span>
									        </label>
									        <label class="flex items-center space-x-2 p-2 hover:bg-dark-tertiary rounded cursor-pointer">
									            <input type="checkbox" class="location-checkbox w-4 h-4 text-accent-cyan" value="semarang" checked>
									            <span class="text-sm text-gray-300">Semarang</span>
									        </label>
									        <label class="flex items-center space-x-2 p-2 hover:bg-dark-tertiary rounded cursor-pointer">
									            <input type="checkbox" class="location-checkbox w-4 h-4 text-accent-cyan" value="makassar" checked>
									            <span class="text-sm text-gray-300">Makassar</span>
									        </label>
									        <label class="flex items-center space-x-2 p-2 hover:bg-dark-tertiary rounded cursor-pointer">
									            <input type="checkbox" class="location-checkbox w-4 h-4 text-accent-cyan" value="palembang" checked>
									            <span class="text-sm text-gray-300">Palembang</span>
									        </label>
									        <label class="flex items-center space-x-2 p-2 hover:bg-dark-tertiary rounded cursor-pointer">
									            <input type="checkbox" class="location-checkbox w-4 h-4 text-accent-cyan" value="tangerang" checked>
									            <span class="text-sm text-gray-300">Tangerang</span>
									        </label>
									        <label class="flex items-center space-x-2 p-2 hover:bg-dark-tertiary rounded cursor-pointer">
									            <input type="checkbox" class="location-checkbox w-4 h-4 text-accent-cyan" value="depok" checked>
									            <span class="text-sm text-gray-300">Depok</span>
									        </label>
									        <label class="flex items-center space-x-2 p-2 hover:bg-dark-tertiary rounded cursor-pointer">
									            <input type="checkbox" class="location-checkbox w-4 h-4 text-accent-cyan" value="bekasi" checked>
									            <span class="text-sm text-gray-300">Bekasi</span>
									        </label>
									        <label class="flex items-center space-x-2 p-2 hover:bg-dark-tertiary rounded cursor-pointer">
									            <input type="checkbox" class="location-checkbox w-4 h-4 text-accent-cyan" value="other" checked>
									            <span class="text-sm text-gray-300">Other Locations</span>
									        </label>
									    </div>
									</div>
				                </div>
				                
				                <!-- Clear Filters -->
				                <button id="clearFilters" class="px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm rounded-lg transition-colors">
				                    Clear All
				                </button>
				            </div>
				        </div>
				
				        <!-- Controls Row -->
				        <div class="flex flex-row items-center justify-between">
				            <div class="text-sm text-gray-400">
				                Use filters above to narrow down candidates
				            </div>
				            <div class="flex flex-row items-center gap-2">
				                <select class="px-3 py-2 bg-dark-primary border border-gray-600 rounded-lg text-white text-sm" id="sortSelect">
				                    <option value="Sort by Score">Sort by Score</option>
				                    <option value="Sort by Experience">Sort by Experience</option>
				                    <option value="Sort by Location">Sort by Location</option>
				                </select>
				                <button id="compareBtn" class="hidden flex items-center justify-center px-3 py-2 w-32 bg-dark-primary border border-purple-500 text-purple-400 hover:bg-purple-500 hover:text-white font-medium text-sm rounded-lg transition-colors">
				                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
				                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
				                    </svg>
				                    <span id="compareBtnText" class="text-xs">Compare</span>
				                </button>
				                <button id="exportBtn" class="flex items-center justify-center px-3 py-2 w-32 bg-accent-cyan hover:bg-accent-teal text-dark-primary font-medium text-sm rounded-lg transition-colors">
				                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
				                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M8 17l4 4 4-4m-4-5v9"/>
				                    </svg>
				                    <span class="text-xs">Export to CSV</span>
				                </button>
				            </div>
				        </div>
				    </div>
				    
				    <!-- Candidate Cards -->
					<div id="candidateCardsContainer" class="space-y-4">
                        <!-- Sample Candidate 1 -->
                        <div class="bg-dark-secondary rounded-xl p-6 hover:bg-dark-tertiary transition-colors cursor-pointer candidate-card" style="display: none;">
                            <div class="flex items-start justify-between">
                                <div class="flex items-start space-x-4 flex-1">
                                    <div class="w-12 h-12 bg-gray-600 rounded-full flex items-center justify-center">
                                        <span class="text-white font-semibold">AS</span>
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex items-center space-x-2 mb-1">
                                            <h4 class="text-lg font-semibold text-white">Ahmad Suharto</h4>
                                            <span class="px-2 py-1 bg-accent-cyan/20 text-accent-cyan text-xs rounded">JobStreet</span>
                                        </div>
                                        <p class="text-gray-300 mb-2">Restaurant Manager ‚Ä¢ 8 years experience</p>
                                        <p class="text-gray-400 text-sm mb-3">Jakarta Selatan ‚Ä¢ Hospitality & Tourism</p>
                                        <p class="text-gray-300 text-sm">Experienced restaurant manager with strong leadership in fine dining establishments. Proven track record in team management, cost control, and customer satisfaction...</p>
                                        <div class="flex items-center space-x-4 mt-3">
                                            <span class="text-xs text-gray-400">LinkedIn Profile Available</span>
                                            <span class="text-xs text-gray-400">Last Updated: 2 days ago</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex flex-col items-center ml-4">
                                    <div class="relative w-16 h-16 mb-2">
                                        <div class="w-16 h-16 rounded-full score-circle flex items-center justify-center" style="--score-deg: 306deg">
                                            <div class="w-12 h-12 bg-dark-secondary rounded-full flex items-center justify-center">
                                                <span class="text-accent-cyan font-bold text-sm">85</span>
                                            </div>
                                        </div>
                                    </div>
                                    <span class="text-xs text-gray-400">AI Score</span>
                                </div>
                            </div>
                        </div>
                    <!-- Sample Candidate 2 -->
                        <div class="bg-dark-secondary rounded-xl p-6 hover:bg-dark-tertiary transition-colors cursor-pointer candidate-card" style="display: none;">
                            <div class="flex items-start justify-between">
                                <div class="flex items-start space-x-4 flex-1">
                                    <div class="w-12 h-12 bg-gray-600 rounded-full flex items-center justify-center">
                                        <span class="text-white font-semibold">SP</span>
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex items-center space-x-2 mb-1">
                                            <h4 class="text-lg font-semibold text-white">Sari Permata</h4>
                                            <span class="px-2 py-1 bg-blue-500/20 text-blue-400 text-xs rounded">LinkedIn</span>
                                        </div>
                                        <p class="text-gray-300 mb-2">Operations Manager ‚Ä¢ 6 years experience</p>
                                        <p class="text-gray-400 text-sm mb-3">Jakarta Pusat ‚Ä¢ Food & Beverage</p>
                                        <p class="text-gray-300 text-sm">Dynamic operations manager specializing in restaurant chains and franchise management. Expert in process optimization, staff training, and quality control...</p>
                                        <div class="flex items-center space-x-4 mt-3">
                                            <span class="text-xs text-gray-400">Full Profile Available</span>
                                            <span class="text-xs text-gray-400">Last Updated: 1 week ago</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex flex-col items-center ml-4">
                                    <div class="relative w-16 h-16 mb-2">
                                        <div class="w-16 h-16 rounded-full score-circle flex items-center justify-center" style="--score-deg: 280deg">
                                            <div class="w-12 h-12 bg-dark-secondary rounded-full flex items-center justify-center">
                                                <span class="text-accent-cyan font-bold text-sm">78</span>
                                            </div>
                                        </div>
                                    </div>
                                    <span class="text-xs text-gray-400">AI Score</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sample Candidate 3 -->
                        <div class="bg-dark-secondary rounded-xl p-6 hover:bg-dark-tertiary transition-colors cursor-pointer candidate-card" style="display: none;">
                            <div class="flex items-start justify-between">
                                <div class="flex items-start space-x-4 flex-1">
                                    <div class="w-12 h-12 bg-gray-600 rounded-full flex items-center justify-center">
                                        <span class="text-white font-semibold">BD</span>
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex items-center space-x-2 mb-1">
                                            <h4 class="text-lg font-semibold text-white">Budi Darma</h4>
                                            <span class="px-2 py-1 bg-green-500/20 text-green-400 text-xs rounded">Karir.com</span>
                                        </div>
                                        <p class="text-gray-300 mb-2">F&B Supervisor ‚Ä¢ 5 years experience</p>
                                        <p class="text-gray-400 text-sm mb-3">Jakarta Barat ‚Ä¢ Food & Beverage</p>
                                        <p class="text-gray-300 text-sm">Dedicated food service supervisor with experience in hotel restaurants and catering. Strong background in inventory management and team coordination...</p>
                                        <div class="flex items-center space-x-4 mt-3">
                                            <span class="text-xs text-gray-400">Contact Info Available</span>
                                            <span class="text-xs text-gray-400">Last Updated: 3 days ago</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex flex-col items-center ml-4">
                                    <div class="relative w-16 h-16 mb-2">
                                        <div class="w-16 h-16 rounded-full score-circle flex items-center justify-center" style="--score-deg: 252deg">
                                            <div class="w-12 h-12 bg-dark-secondary rounded-full flex items-center justify-center">
                                                <span class="text-accent-cyan font-bold text-sm">70</span>
                                            </div>
                                        </div>
                                    </div>
                                    <span class="text-xs text-gray-400">AI Score</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Candidate Detail Modal -->
    <div id="candidateModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-dark-secondary rounded-xl max-w-4xl w-full max-h-screen overflow-y-auto">
            <div class="p-6 border-b border-gray-700">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="w-16 h-16 bg-gray-600 rounded-full flex items-center justify-center">
                            <span class="text-white font-bold text-lg">AS</span>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-white">Ahmad Suharto</h2>
                            <p class="text-gray-300">Restaurant Manager ‚Ä¢ 8 years experience</p>
                            <p class="text-gray-400">Jakarta Selatan ‚Ä¢ Available for Contact</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="text-center">
                            <div class="relative w-20 h-20 mb-2">
                                <div class="w-20 h-20 rounded-full score-circle flex items-center justify-center" style="--score-deg: 306deg">
                                    <div class="w-16 h-16 bg-dark-secondary rounded-full flex items-center justify-center">
                                        <span class="text-accent-cyan font-bold text-lg">85</span>
                                    </div>
                                </div>
                            </div>
                            <span class="text-sm text-gray-400">AI Match Score</span>
                        </div>
                        <button id="closeModal" class="text-gray-400 hover:text-white">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="p-6 space-y-6">
                <!-- AI Analysis Summary -->
                <div class="bg-dark-primary rounded-lg p-4">
                    <h3 class="text-lg font-semibold text-white mb-3 flex items-center">
                        <svg class="w-5 h-5 text-accent-cyan mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        AI Analysis Summary
                    </h3>
                    <p class="text-gray-300 mb-4">Strong match for Restaurant Manager position with excellent leadership experience and location compatibility. Recommended for immediate contact.</p>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <span class="text-sm text-gray-400">Role Relevance</span>
                            <div class="flex items-center space-x-2 mt-1">
                                <div class="flex-1 bg-gray-600 rounded-full h-2">
                                    <div class="bg-accent-cyan h-2 rounded-full" style="width: 90%"></div>
                                </div>
                                <span class="text-sm text-accent-cyan">90%</span>
                            </div>
                        </div>
                        <div>
                            <span class="text-sm text-gray-400">Experience Match</span>
                            <div class="flex items-center space-x-2 mt-1">
                                <div class="flex-1 bg-gray-600 rounded-full h-2">
                                    <div class="bg-accent-cyan h-2 rounded-full" style="width: 85%"></div>
                                </div>
                                <span class="text-sm text-accent-cyan">85%</span>
                            </div>
                        </div>
                        <div>
                            <span class="text-sm text-gray-400">Location Fit</span>
                            <div class="flex items-center space-x-2 mt-1">
                                <div class="flex-1 bg-gray-600 rounded-full h-2">
                                    <div class="bg-accent-cyan h-2 rounded-full" style="width: 95%"></div>
                                </div>
                                <span class="text-sm text-accent-cyan">95%</span>
                            </div>
                        </div>
                        <div>
                            <span class="text-sm text-gray-400">Profile Quality</span>
                            <div class="flex items-center space-x-2 mt-1">
                                <div class="flex-1 bg-gray-600 rounded-full h-2">
                                    <div class="bg-accent-cyan h-2 rounded-full" style="width: 70%"></div>
                                </div>
                                <span class="text-sm text-accent-cyan">70%</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Profile Details -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="text-lg font-semibold text-white mb-3">Profile Summary</h4>
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-400">Experience:</span>
                                <span class="text-white">8 years in hospitality</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Current Role:</span>
                                <span class="text-white">Restaurant Manager</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Location:</span>
                                <span class="text-white">Jakarta Selatan</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Source:</span>
                                <span class="text-accent-cyan">JobStreet Indonesia</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Profile Updated:</span>
                                <span class="text-white">2 days ago</span>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="text-lg font-semibold text-white mb-3">Key Strengths</h4>
                        <div class="space-y-2">
                            <div class="flex items-center space-x-2">
                                <div class="w-2 h-2 bg-accent-cyan rounded-full"></div>
                                <span class="text-gray-300 text-sm">Team Leadership & Management</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="w-2 h-2 bg-accent-cyan rounded-full"></div>
                                <span class="text-gray-300 text-sm">Fine Dining Experience</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="w-2 h-2 bg-accent-cyan rounded-full"></div>
                                <span class="text-gray-300 text-sm">Cost Control & Budget Management</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                                            <div class="w-2 h-2 bg-accent-cyan rounded-full"></div>
                                <span class="text-gray-300 text-sm">Customer Service Excellence</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="w-2 h-2 bg-accent-cyan rounded-full"></div>
                                <span class="text-gray-300 text-sm">Multi-location Experience</span>
                            </div>
                        </div>
			    			<!-- Current Skills Section -->
							<div>
							    <h4 class="text-lg font-semibold text-white mb-3">Current Skills</h4>
							    <div id="currentSkillsContainer" class="flex flex-wrap gap-2">
							        <!-- Skills will be populated by JavaScript -->
							    </div>
							</div>
							
							<!-- Growth Opportunities Section -->
							<div>
							    <h4 class="text-lg font-semibold text-white mb-3">Growth Opportunities</h4>
							    <div id="growthOpportunitiesContainer" class="space-y-2">
							        <!-- Growth opportunities will be populated by JavaScript -->
							    </div>
							</div>
                    </div>
                </div>
                
                <!-- Potential Concerns -->
                <div class="bg-yellow-900/20 border border-yellow-600/30 rounded-lg p-4">
                    <h4 class="text-lg font-semibold text-yellow-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                        Potential Considerations
                    </h4>
                    <div class="space-y-2 text-sm text-yellow-100">
                        <div class="flex items-start space-x-2">
                            <span class="text-yellow-400">‚Ä¢</span>
                            <span>Profile hasn't been updated in 2 weeks - may indicate job satisfaction</span>
                        </div>
                        <div class="flex items-start space-x-2">
                            <span class="text-yellow-400">‚Ä¢</span>
                            <span>Current employment status unclear - may require verification</span>
                        </div>
                        <div class="flex items-start space-x-2">
                            <span class="text-yellow-400">‚Ä¢</span>
                            <span>Limited contact information available on public profile</span>
                        </div>
                    </div>
                </div>
                
                <!-- Recommendation -->
                <div class="bg-accent-cyan/10 border border-accent-cyan/30 rounded-lg p-4">
                    <h4 class="text-lg font-semibold text-accent-cyan mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                        </svg>
                        AI Recommendation
                    </h4>
                    <p class="text-gray-300 text-sm">
                        <strong>Priority Level:</strong> Ahmad shows excellent alignment with restaurant management requirements. 
                        Recommend reaching out with a personalized message highlighting career growth opportunities and competitive compensation. 
                        Best contact approach: LinkedIn message or professional email during business hours.
                    </p>
                </div>

	    		<!-- Career Predictive Analytics Section -->
				<div class="bg-gradient-to-r from-purple-900/20 to-blue-900/20 border border-purple-500/30 rounded-lg p-4 mt-6">
				    <h4 class="text-lg font-semibold text-purple-400 mb-3 flex items-center">
				        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
				            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
				        </svg>
				        Career Predictive Analytics
				    </h4>
				    <div id="careerAnalyticsContent" class="text-gray-300 whitespace-pre-line text-sm leading-relaxed">
				        <!-- Analytics content will be populated by JavaScript -->
				    </div>
				</div>
                
                <!-- Contact Actions -->
                <div class="flex items-center space-x-3">
				    <button id="viewLinkedInBtn" class="flex items-center justify-center px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors shadow-lg hover:shadow-xl">
				        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
				            <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
				        </svg>
				        <span>View LinkedIn Profile</span>
				    </button>
				    <button class="flex items-center justify-center px-4 py-3 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition-colors shadow-lg hover:shadow-xl export-modal-btn" data-type="pdf">
				        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
				            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
				        </svg>
				        <span>Export PDF</span>
				    </button>
				    <button class="flex items-center justify-center px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors shadow-lg hover:shadow-xl export-modal-btn" data-type="csv">
				        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
				            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
				        </svg>
				        <span>Export CSV</span>
				    </button>
				    <button class="flex items-center justify-center px-4 py-3 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-lg transition-colors shadow-lg hover:shadow-xl export-modal-btn" data-type="clipboard">
				        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
				            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/>
				        </svg>
				        <span>Copy to Clipboard</span>
				    </button>
				</div>
            </div>
        </div>
    </div>

	<!-- Candidate Comparison Modal -->
	<div id="comparisonModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
	    <div class="bg-dark-secondary rounded-xl max-w-6xl w-full max-h-screen overflow-y-auto">
	        <div class="p-6 border-b border-gray-700">
	            <div class="flex items-center justify-between">
	                <h2 class="text-2xl font-bold text-white">Candidate Comparison</h2>
	                <button id="closeComparisonModal" class="text-gray-400 hover:text-white">
	                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
	                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
	                    </svg>
	                </button>
	            </div>
	        </div>
	        
	        <div class="p-6">
	            <div id="comparisonContent" class="grid gap-6">
	                <!-- Comparison content will be dynamically generated -->
	            </div>
	        </div>
	    </div>
	</div>

    <!-- Search History Modal -->
    <div id="historyModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-dark-secondary rounded-xl max-w-2xl w-full max-h-screen overflow-y-auto">
            <div class="p-6 border-b border-gray-700">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-bold text-white">Search History</h2>
                    <button id="closeHistoryModal" class="text-gray-400 hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="p-6 space-y-4">
                <div class="bg-dark-primary rounded-lg p-4 hover:bg-dark-tertiary transition-colors cursor-pointer">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="font-semibold text-white">Restaurant Manager in Jakarta</h3>
                        <span class="text-sm text-gray-400">2 hours ago</span>
                    </div>
                    <p class="text-sm text-gray-300 mb-2">Hospitality & Tourism ‚Ä¢ Entry to Mid Level</p>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-accent-cyan">8 candidates found</span>
                        <button class="text-xs text-gray-400 hover:text-accent-cyan">Rerun Search</button>
                    </div>
                </div>
                
                <div class="bg-dark-primary rounded-lg p-4 hover:bg-dark-tertiary transition-colors cursor-pointer">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="font-semibold text-white">Cashier in Surabaya</h3>
                        <span class="text-sm text-gray-400">1 day ago</span>
                    </div>
                    <p class="text-sm text-gray-300 mb-2">Retail & Commerce ‚Ä¢ Entry Level</p>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-accent-cyan">12 candidates found</span>
                        <button class="text-xs text-gray-400 hover:text-accent-cyan">Rerun Search</button>
                    </div>
                </div>
                
                <div class="bg-dark-primary rounded-lg p-4 hover:bg-dark-tertiary transition-colors cursor-pointer">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="font-semibold text-white">Cook in Bandung</h3>
                        <span class="text-sm text-gray-400">3 days ago</span>
                    </div>
                    <p class="text-sm text-gray-300 mb-2">Food & Beverage ‚Ä¢ Mid Level</p>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-accent-cyan">6 candidates found</span>
                        <button class="text-xs text-gray-400 hover:text-accent-cyan">Rerun Search</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="exportModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-dark-secondary rounded-xl max-w-md w-full">
            <div class="p-6 border-b border-gray-700">
                <h2 class="text-xl font-bold text-white">Export Results</h2>
                <p class="text-gray-400 text-sm mt-1">Choose export format for your search results</p>
            </div>
            <div class="p-6 space-y-4">
                <button class="w-full p-4 bg-dark-primary hover:bg-dark-tertiary rounded-lg transition-colors flex items-center space-x-3">
                    <svg class="w-8 h-8 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"/>
                    </svg>
                    <div class="text-left">
                        <div class="font-medium text-white">PDF Report</div>
                        <div class="text-sm text-gray-400">Detailed profiles with AI analysis</div>
                    </div>
                </button>
                
                <button class="w-full p-4 bg-dark-primary hover:bg-dark-tertiary rounded-lg transition-colors flex items-center space-x-3">
                    <svg class="w-8 h-8 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                    <div class="text-left">
                        <div class="font-medium text-white">CSV Spreadsheet</div>
                        <div class="text-sm text-gray-400">Contact info and basic details</div>
                    </div>
                </button>
                
                <button class="w-full p-4 bg-dark-primary hover:bg-dark-tertiary rounded-lg transition-colors flex items-center space-x-3">
                    <svg class="w-8 h-8 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M8 2a1 1 0 000 2h2a1 1 0 100-2H8z"/>
                        <path d="M3 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v6h-4.586l1.293-1.293a1 1 0 10-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L10.414 13H15v3a2 2 0 01-2 2H5a2 2 0 01-2-2V5zM15 11h2a1 1 0 110 2h-2v-2z"/>
                    </svg>
                    <div class="text-left">
                        <div class="font-medium text-white">Copy to Clipboard</div>
                        <div class="text-sm text-gray-400">Quick paste into other tools</div>
                    </div>
                </button>
            </div>
            <div class="p-6 border-t border-gray-700 flex justify-end">
                <button id="closeExportModal" class="px-4 py-2 text-gray-400 hover:text-white">Cancel</button>
            </div>
        </div>
    </div>

<div id="exportToast" class="fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-dark-secondary text-accent-cyan px-6 py-3 rounded-xl shadow-lg z-50 hidden flex items-center space-x-3">
    <svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
    </svg>
    <span id="exportToastText">Exporting...</span>
</div>
<!-- Auth Modal -->
<div id="authModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
    <div class="bg-dark-secondary rounded-xl max-w-md w-full">
        <div class="p-6 border-b border-gray-700">
            <h2 class="text-xl font-bold text-white">Login to Continue</h2>
            <p class="text-gray-400 text-sm mt-1">Access your credits and search history</p>
        </div>
        <div class="p-6 space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Email</label>
                <input type="email" id="authEmail" placeholder="Enter your email" 
                       class="w-full px-4 py-3 bg-dark-primary border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:border-accent-cyan focus:outline-none">
            </div>
            
            <button id="magicLinkBtn" class="w-full bg-accent-cyan hover:bg-accent-teal text-dark-primary font-semibold py-3 px-6 rounded-lg transition-colors">
                Send Magic Link
            </button>
            
            <div class="relative">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-600"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-2 bg-dark-secondary text-gray-400">or</span>
                </div>
            </div>
            
            <button id="googleAuthBtn" class="w-full bg-white hover:bg-gray-100 text-gray-900 font-semibold py-3 px-6 rounded-lg transition-colors flex items-center justify-center space-x-2">
                <svg class="w-5 h-5" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                <span>Continue with Google</span>
            </button>
            
            <div id="authMessage" class="text-sm text-center hidden"></div>
        </div>
        <div class="p-6 border-t border-gray-700 flex justify-end">
            <button id="closeAuthModal" class="px-4 py-2 text-gray-400 hover:text-white">Cancel</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
	console.log('JavaScript is running!');
	console.log('Step 1: Starting initialization...');

const SUPABASE_URL = 'https://brawqzylfyuotgxqmtox.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJyYXdxenlsZnl1b3RneHFtdG94Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg1MTU0NTUsImV4cCI6MjA2NDA5MTQ1NX0.P4qazlzBHk66eItqBRK-6k2ll2I1d754ke5_r_hNxos';
const WEBHOOK_SECRET = 'leadfinder_secretkey123';
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
	console.log('Step 2: Supabase initialized');

let currentUser = null;
let userCredits = 0;
	console.log('Step 3: Variables declared');
let currentSearchResults = [];
let currentCandidates = [];
let progressInterval = null;
let activeCandidate = null;
let currentHistoryData = [];

// Authentication functions
function showAuthModal() {
    document.getElementById('authModal').classList.remove('hidden');
}

function hideAuthModal() {
    document.getElementById('authModal').classList.add('hidden');
}

function updateCreditsDisplay() {
	const creditsDisplay = document.getElementById('creditsDisplay');
	if (!creditsDisplay) return;
	if (currentUser && userCredits > 0) {
		creditsDisplay.textContent = `${userCredits} credits`;
	} else {
		creditsDisplay.textContent = "0 credits";
	}
}

function showAuthMessage(message, type) {
	const messageEl = document.getElementById('authMessage');
	messageEl.textContent = message;
	messageEl.className = `text-sm text-center ${type === 'error' ? 'text-red-400' : 'text-accent-cyan'}`;
	messageEl.classList.remove('hidden');
	setTimeout(() => { messageEl.classList.add('hidden'); }, 5000);
}

async function checkAuthAndCredits() {
	if (!currentUser) {
		const { data: { user } } = await supabaseClient.auth.getUser();
		if (!user) {
			showAuthModal();
			return false;
		}
		currentUser = user;
	}

	const { data: profile, error } = await supabaseClient
		.from('leadfinder_users')
		.select('credits')
		.eq('user_id', currentUser.id)
		.single();

	if (error) {
	    if (error.code === 'PGRST116') {
	        // Try to insert, but handle duplicate user gracefully
	        const { data: newProfile, error: insertError } = await supabaseClient
	            .from('leadfinder_users')
	            .insert({
	                user_id: currentUser.id,
	                email: currentUser.email,
	                credits: 10
	            })
	            .select()
	            .single();
	        if (insertError) {
	            // If user already exists, just fetch their existing profile
	            if (insertError.code === '23505') { // duplicate key error
	                const { data: existingProfile } = await supabaseClient
	                    .from('leadfinder_users')
	                    .select('credits')
	                    .eq('user_id', currentUser.id)
	                    .single();
	                userCredits = existingProfile?.credits || 0;
	                updateCreditsDisplay();
	                return true;
	            } else {
	                alert('User creation failed: ' + insertError.message);
	                return false;
	            }
	        } else {
	            // Success: new user created
	            userCredits = newProfile.credits || 10;
	            updateCreditsDisplay();
	            return true;
	        }
	    } else {
	        alert('Error fetching profile: ' + error.message);
	        return false;
	    }
	}

	if (profile) {
		userCredits = profile.credits || 0;
		updateCreditsDisplay();
		return userCredits > 0;
	}

	return false;
}

async function deductCredit() {
	if (userCredits <= 0) return false;
	const { error } = await supabaseClient
		.from('leadfinder_users')
		.update({ credits: userCredits - 1, updated_at: new Date().toISOString() })
		.eq('user_id', currentUser.id);
	if (!error) {
		userCredits -= 1;
		updateCreditsDisplay();
		return true;
	}
	return false;
}
	
async function signInWithMagicLink() {
	const email = document.getElementById('authEmail').value;
	if (!email) {
		showAuthMessage('Please enter your email', 'error');
		return;
	}
	const { error } = await supabaseClient.auth.signInWithOtp({
		email: email,
		options: { emailRedirectTo: window.location.origin }
	});
	if (error) {
		showAuthMessage(error.message, 'error');
	} else {
		showAuthMessage('Check your email for the magic link!', 'success');
	}
}

async function signInWithGoogle() {
	const { error } = await supabaseClient.auth.signInWithOAuth({
		provider: 'google',
		options: { redirectTo: window.location.origin }
	});
	if (error) {
		showAuthMessage(error.message, 'error');
	}
}

supabaseClient.auth.onAuthStateChange(async (event, session) => {
	if (event === 'SIGNED_IN') {
		currentUser = session.user;
		hideAuthModal();
		await checkAuthAndCredits();
		updateCreditsDisplay();
	} else if (event === 'SIGNED_OUT') {
		currentUser = null;
		userCredits = 0;
		updateCreditsDisplay();
	}
});

// --- 4. Main session check on page load ---
console.log('Step 4: Skipping Supabase session check for now...');
// Temporarily skip Supabase to test the rest of the app
// showAuthModal(); // Comment this out so we don't show auth modal
console.log('Step 6: Auth handling completed');

console.log('Step 7: Moving to DOM elements...');

// --- 5. Event listeners ---
document.getElementById('magicLinkBtn').addEventListener('click', signInWithMagicLink);
document.getElementById('googleAuthBtn').addEventListener('click', signInWithGoogle);
document.getElementById('closeAuthModal').addEventListener('click', hideAuthModal);
       
let searchHistory = JSON.parse(localStorage.getItem('leadfinder_history') || '[]');

// Save search to Supabase
async function saveSearchToSupabase(searchParams, results) {
    if (!currentUser) return;
    const { error } = await supabaseClient
        .from('search_history')
        .insert({
            user_id: currentUser.id,
            search_params: searchParams,
            results: results,
            credits_used: 1
        });
    if (error) {
        console.error('Failed to save search:', error);
    }
}

// Load search history from Supabase instead of localStorage
async function loadSearchHistory() {
    if (!currentUser) return [];
    const { data, error } = await supabaseClient
        .from('search_history')
        .select('*')
        .eq('user_id', currentUser.id)
        .order('created_at', { ascending: false })
        .limit(10);
    if (error) {
        console.error('Failed to load search history:', error);
        return [];
    }
    return data.map(item => ({
        id: item.id,
        jobTitle: item.search_params.jobTitle,
        industry: item.search_params.industry,
        location: item.search_params.location,
        experience: item.search_params.experience,
        resultCount: item.results.totalFound || 0,
        candidates: item.results.candidates || [],
        timestamp: item.created_at
    }));
}
		        
// DOM elements
console.log('Step 4: Looking for DOM elements...');
const searchForm = document.getElementById('searchForm');
console.log('searchForm element:', searchForm);
const initialState = document.getElementById('initialState');
console.log('initialState found:', initialState);
const loadingState = document.getElementById('loadingState');
const resultsState = document.getElementById('resultsState');
const candidateModal = document.getElementById('candidateModal');
const historyModal = document.getElementById('historyModal');
const exportModal = document.getElementById('exportModal');

// Form submission
if (searchForm) {
    console.log('Adding submit listener to form');
    searchForm.addEventListener('submit', function(e) {
        console.log('Form submitted! Preventing default...');
        e.preventDefault();
        console.log('About to call handleSearch');
        handleSearch(e);
    });
} else {
    console.log('ERROR: searchForm not found!');
}

// Handle custom location input
document.getElementById('location').addEventListener('change', function() {
    const locationSelect = this;
    const customLocationInput = document.getElementById('customLocation');
    
    if (locationSelect.value === 'other') {
        // Show custom input with smooth animation
        customLocationInput.classList.remove('hidden');
        customLocationInput.focus();
    } else {
        // Hide custom input
        customLocationInput.classList.add('hidden');
        customLocationInput.value = ''; // Clear the custom input when hidden
    }
});

// Handle custom industry input
document.getElementById('industry').addEventListener('change', function() {
    const industrySelect = this;
    const customIndustryInput = document.getElementById('customIndustry');
    
    if (industrySelect.value === 'custom') {
        // Show custom input with smooth animation
        customIndustryInput.classList.remove('hidden');
        customIndustryInput.focus();
    } else {
        // Hide custom input
        customIndustryInput.classList.add('hidden');
        customIndustryInput.value = ''; // Clear the custom input when hidden
    }
});

// ADD THESE DEBUG LINES:
console.log('Search form found:', document.getElementById('searchForm'));
console.log('Sample search button found:', document.getElementById('sampleSearchBtn'));

// Sample search (fills the form with a demo search)
document.getElementById('sampleSearchBtn').addEventListener('click', () => {
    document.getElementById('jobTitle').value = 'Restaurant Manager';
    document.getElementById('industry').value = 'hospitality';
    document.getElementById('location').value = 'jakarta';
    document.getElementById('experience').value = 'mid';
});

// Sample search (fills the form with a demo search)
const sampleBtn = document.getElementById('sampleSearchBtn');
if (sampleBtn) {
    console.log('Attaching click listener to sample button');
    sampleBtn.addEventListener('click', (e) => {
        console.log('Sample button clicked!');
        e.preventDefault();
        e.stopPropagation();
        
        document.getElementById('jobTitle').value = 'Restaurant Manager';
        document.getElementById('industry').value = 'hospitality';
        document.getElementById('location').value = 'jakarta';
        document.getElementById('experience').value = 'mid';
        console.log('Form values set');
    });
    console.log('Sample button listener attached');
} else {
    console.log('Sample button not found!');
}

// Candidate card modal opening by card click (delegated)
document.addEventListener('click', (e) => {
    if (e.target.closest('.candidate-card')) {
        candidateModal.classList.remove('hidden');
    }
});

// Export button for main list
document.getElementById('exportBtn').addEventListener('click', async () => {
    showExportToast("Exporting CSV...");
    // Wait for effect
    await new Promise(r => setTimeout(r, 1000));
    downloadCSV();
    hideExportToast();
});

// --- Main Search Handler and Helpers ---

// Get location value (either from dropdown or custom input)
function getLocationValue() {
    const locationSelect = document.getElementById('location');
    const customLocation = document.getElementById('customLocation');
    
    if (locationSelect.value === 'other' && customLocation.value.trim()) {
        return customLocation.value.trim();
    } else if (locationSelect.value && locationSelect.value !== 'other') {
        return locationSelect.value;
    } else {
        return '';
    }
}

// Get industry value (either from dropdown or custom input)
function getIndustryValue() {
    const industrySelect = document.getElementById('industry');
    const customIndustry = document.getElementById('customIndustry');
    
    if (industrySelect.value === 'custom' && customIndustry.value.trim()) {
        return customIndustry.value.trim();
    } else if (industrySelect.value && industrySelect.value !== 'custom') {
        return industrySelect.value;
    } else {
        return '';
    }
}
	
// Handle search form submission
async function handleSearch(e) {
    console.log('=== HANDLE SEARCH STARTED ===');
    e.preventDefault();
    console.log('Default prevented');
    
    alert('Search function is working!');
    
    console.log('=== HANDLE SEARCH ENDED ===');
}

// --- Results Processing & Candidate Rendering ---

// Process backend results and update UI
function processSearchResults(data) {
    // Store candidates globally for modal access
    currentCandidates = data.results.candidates;
    // Update results description
    const resultsTitle = document.querySelector('#resultsState h3');
    const resultsDesc = document.querySelector('#resultsState p');
    
    if (resultsTitle && resultsDesc) {
        resultsTitle.textContent = 'Search Results';
        resultsDesc.textContent = `Found ${data.results.totalFound} candidates matching "${data.query.jobTitle}" in ${data.query.location}`;
    }
    
    // Update candidate cards with real data
    updateCandidateCards(data.results.candidates);
    
    // Update analytics if you have an analytics section
    if (data.analytics) updateAnalytics(data.analytics);

    // Save to local search history as well
    // saveToSearchHistory(data.query, data.results.totalFound, data.results.candidates);
    updateSearchHistoryUI();

    // Update AI Insights
	console.log('About to generate AI insights with query:', data.query);
    const aiInsights = generateAIInsights(data.results.candidates, data.query);
	console.log('Generated insights:', aiInsights);
    document.getElementById('aiInsightsText').textContent = aiInsights;

    // Setup result filters
    setTimeout(() => {
        setupResultFilters();
    }, 100);
}

function showHistorySearchResult(searchData) {
    console.log('Showing history search result for:', searchData);
    
    // Update results description with correct search data
    const resultsTitle = document.querySelector('#resultsState h3');
    const resultsDesc = document.querySelector('#resultsState p');
    if (resultsTitle && resultsDesc) {
        resultsTitle.textContent = 'Search Results';
        resultsDesc.textContent = `Found ${searchData.resultCount} candidates matching "${searchData.jobTitle}" in ${searchData.location}`;
    }
    
    // Update candidate cards with saved data
    updateCandidateCards(searchData.candidates || []);
    
    // Update the global candidate state for filtering
    currentCandidates = searchData.candidates || [];
    attachCandidateCardHandlers(currentCandidates);
    
    // Update AI Insights for this search
    const aiInsights = generateAIInsights(searchData.candidates || [], searchData);
    document.getElementById('aiInsightsText').textContent = aiInsights;
    
    // Setup result filters
    setTimeout(() => {
        setupResultFilters();
    }, 100);
}

function updateResultsDescription(params) {
    const resultsTitle = document.querySelector('#resultsState h3');
    const resultsDesc = document.querySelector('#resultsState p');
    if (resultsTitle && resultsDesc) {
        resultsDesc.textContent = `Found 8 candidates matching "${params.jobTitle}" in ${params.location || 'Indonesia'}`;
    }
}

// Update the candidate cards in the UI
function updateCandidateCards(candidates) {
    const cardsContainer = document.getElementById('candidateCardsContainer');
    if (!cardsContainer) {
        console.error('Cards container not found');
        return;
    }
    
    // Clear old cards
    cardsContainer.innerHTML = '';
    
    // Render real cards
    candidates.forEach(candidate => {
        const cardHTML = createCandidateCardHTML(candidate);
        cardsContainer.innerHTML += cardHTML;
    });
    
    // Re-attach click handlers
    attachCandidateCardHandlers(candidates);
}

// Generate priority badge based on AI score
function getPriorityBadge(score) {
    if (score >= 80) {
        return `<span class="px-2 py-1 bg-green-500/20 text-green-400 text-xs rounded font-medium border border-green-500/30">
            High Priority
        </span>`;
    } else if (score >= 60) {
        return `<span class="px-2 py-1 bg-yellow-500/20 text-yellow-400 text-xs rounded font-medium border border-yellow-500/30">
            Medium Priority
        </span>`;
    } else {
        return `<span class="px-2 py-1 bg-gray-500/20 text-gray-400 text-xs rounded font-medium border border-gray-500/30">
            Low Priority
        </span>`;
    }
}

// Generate verification badge with better styling
function getVerificationBadge(status) {
    if (status === 'Verified') {
        return `<span class="text-xs text-accent-cyan px-2 py-1 bg-accent-cyan/20 rounded-full flex items-center font-medium border border-accent-cyan/30">
            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.238.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            Verified
        </span>`;
    } else {
        return `<span class="text-xs text-gray-400 px-2 py-1 bg-gray-600/20 rounded-full border border-gray-600/30">
            ${status || 'Unverified'}
        </span>`;
    }
}

// Get color based on AI score
function getScoreColor(score) {
    if (score >= 80) return '#10b981'; // Green
    if (score >= 60) return '#f59e0b'; // Yellow/Orange  
    return '#6b7280'; // Gray
}

// Generate source badge with platform-specific styling
function getSourceBadge(source) {
    const sourceStyles = {
        'LinkedIn': {
            bg: 'bg-blue-600/20',
            text: 'text-blue-400',
            border: 'border-blue-600/40',
            icon: `<svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 24 24">
                <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
            </svg>`
        },
        'JobStreet': {
            bg: 'bg-green-600/20',
            text: 'text-green-400',
            border: 'border-green-600/40',
            icon: `<svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2L2 7V10C2 16 6 20.5 12 22C18 20.5 22 16 22 10V7L12 2Z"/>
            </svg>`
        },
        'Karir.com': {
            bg: 'bg-orange-600/20',
            text: 'text-orange-400',
            border: 'border-orange-600/40',
            icon: `<svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM13 17H11V15H13V17ZM13 13H11V7H13V13Z"/>
            </svg>`
        }
    };

    const style = sourceStyles[source] || {
        bg: 'bg-gray-600/20',
        text: 'text-gray-400',
        border: 'border-gray-600/40',
        icon: `<svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 2L2 7V10C2 16 6 20.5 12 22C18 20.5 22 16 22 10V7L12 2Z"/>
        </svg>`
    };

    return `<span class="source-badge px-2 py-1 ${style.bg} ${style.text} border ${style.border} text-xs rounded-full font-medium flex items-center">
        ${style.icon}
        ${source}
    </span>`;
}

// Render 1 candidate card as HTML
function createCandidateCardHTML(candidate) {
    const scorePercentage = (candidate.aiScore * 3.6); // For speedometer UI
    
    // Extract hiring difficulty level for CSS class
    const difficultyLevel = candidate.hiringDifficulty?.toLowerCase().includes('easy') ? 'easy' :
                           candidate.hiringDifficulty?.toLowerCase().includes('hard') ? 'hard' : 'medium';
    
    // Get top 2-3 current skills for display
    const displaySkills = (candidate.currentSkills || []).slice(0, 3);
    
    return `
        <div class="bg-dark-secondary rounded-xl p-6 hover:bg-dark-tertiary transition-colors cursor-pointer candidate-card" data-candidate-id="${candidate.id}">
            <div class="flex items-start justify-between">
                <div class="flex items-start space-x-4 flex-1">
                    <div class="pt-1">
                        <input type="checkbox" 
                            class="candidate-checkbox w-4 h-4 text-accent-cyan bg-dark-primary border-gray-600 rounded focus:ring-accent-cyan focus:ring-2" 
                            data-candidate-id="${candidate.id}">
                    </div>
                    <div class="w-12 h-12 bg-gray-600 rounded-full flex items-center justify-center">
                        <span class="text-white font-semibold">${candidate.name.split(' ').map(n => n[0]).join('').substring(0, 2)}</span>
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center space-x-2 mb-1">
                            <h4 class="text-lg font-semibold text-white">${candidate.name}</h4>
                            ${getSourceBadge(candidate.source)}
                        </div>
                        <p class="text-gray-300 mb-2">${candidate.title}</p>
                        <p class="text-gray-400 text-sm mb-2">${candidate.location} ‚Ä¢ ${candidate.experience || 'Experienced professional'}</p>
                        
                        <!-- Skills badges (replacing priority badge) -->
                        <div class="flex items-center space-x-2 mb-3">
                            ${displaySkills.map(skill => `<span class="px-2 py-1 bg-blue-500/20 text-blue-400 border border-blue-500/30 text-xs rounded-full font-medium">${skill}</span>`).join('')}
                        </div>
                        
                        <!-- Salary and Difficulty badges -->
                        <div class="flex items-center space-x-2 mb-3">
                            ${candidate.salaryRange ? `<span class="salary-badge px-2 py-1 text-white text-xs rounded-full font-medium">${candidate.salaryRange}</span>` : ''}
                            ${candidate.hiringDifficulty ? `<span class="difficulty-${difficultyLevel} px-2 py-1 text-xs rounded-full font-medium border">${candidate.hiringDifficulty.split(' - ')[0]}</span>` : ''}
                        </div>
                        
                        <p class="text-gray-300 text-sm">${candidate.snippet}</p>
                        <div class="flex items-center space-x-4 mt-3">
                            <span class="text-xs text-gray-400">Profile Available</span>
                            <span class="text-xs text-gray-400">${candidate.lastUpdated}</span>
                            ${getVerificationBadge(candidate.verificationStatus)}
                        </div>
                    </div>
                </div>
                <div class="flex flex-col items-center ml-4">
                    <div class="relative w-16 h-16 mb-2">
                        <div class="w-16 h-16 rounded-full enhanced-score-circle flex items-center justify-center" style="--score-deg: ${scorePercentage}deg; --score-color: ${getScoreColor(candidate.aiScore)}">
                            <div class="w-12 h-12 bg-dark-secondary rounded-full flex items-center justify-center shadow-inner">
                                <span class="font-bold text-sm" style="color: ${getScoreColor(candidate.aiScore)}">${candidate.aiScore}</span>
                            </div>
                        </div>
                    </div>
                    <span class="text-xs text-gray-400">AI Score</span>
                </div>
            </div>
        </div>
    `;
}

// --- Candidate Modal Logic ---

// Attach click handlers to each candidate card (for details modal)
function attachCandidateCardHandlers(candidates) {
    document.querySelectorAll('.candidate-card').forEach((card, index) => {
        card.addEventListener('click', () => {
            const candidateId = card.getAttribute('data-candidate-id');
            const candidate = candidates.find(c => c.id === candidateId);
            if (candidate) {
                showCandidateModal(candidate);
            }
        });
    });
	// ADD THIS: Attach checkbox event listeners
    document.querySelectorAll('.candidate-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function(e) {
            e.stopPropagation();
			e.preventDefault();
            console.log('Checkbox clicked:', this.checked);
            updateCompareButton();
        });
		// Also prevent clicks from bubbling
	    checkbox.addEventListener('click', function(e) {
	        e.stopPropagation();
	    });
    });
}

// Show modal with candidate data
function showCandidateModal(candidate) {
    activeCandidate = candidate;
    if (!candidate) return;

    // Update modal sections
    updateModalHeader(candidate);
    updateModalAnalysis(candidate);
    updateModalProfile(candidate);
    updateModalStrengths(candidate);
	updateModalCurrentSkills(candidate);
	updateModalGrowthOpportunities(candidate);
    updateModalConcerns(candidate);
    updateModalRecommendation(candidate);
	updateModalCareerAnalytics(candidate);

    // Show modal
    candidateModal.classList.remove('hidden');
}

// Modal section updaters:
function updateModalHeader(candidate) {
    const nameElement = candidateModal.querySelector('h2');
    const titleElement = candidateModal.querySelector('p.text-gray-300');
    const locationElement = candidateModal.querySelector('p.text-gray-400');

    if (nameElement) nameElement.textContent = candidate.name;
    if (titleElement) titleElement.textContent = `${candidate.title} ‚Ä¢ ${candidate.experience || 'Experienced professional'}`;
    if (locationElement) {
        const contactStatus = candidate.verificationStatus === 'Verified' ? 'Verified Profile' : 'Profile Available';
        locationElement.textContent = `${candidate.location} ‚Ä¢ ${contactStatus}`;
    }

    // Update score circle
    const scoreElement = candidateModal.querySelector('.text-accent-cyan.font-bold.text-lg');
    const scoreCircle = candidateModal.querySelector('.score-circle');
    if (scoreElement) scoreElement.textContent = candidate.aiScore;
    if (scoreCircle) {
        const scoreDegrees = candidate.aiScore * 3.6;
        scoreCircle.style.setProperty('--score-deg', `${scoreDegrees}deg`);
    }

    // Update initials
    const initialsElement = candidateModal.querySelector('.w-16.h-16 span');
    if (initialsElement) {
        const initials = candidate.name.split(' ').map(n => n[0]).join('').substring(0, 2);
        initialsElement.textContent = initials;
    }
}

function updateModalAnalysis(candidate) {
    const summaryText = candidateModal.querySelector('.bg-dark-primary p.text-gray-300');
    if (summaryText) {
        summaryText.textContent = candidate.recommendation || 'AI analysis based on profile matching and experience relevance.';
    }

    // Update score breakdown bars
    const scoreBreakdown = candidate.scoreBreakdown || {};
    updateScoreBar('Role Relevance', scoreBreakdown.roleRelevance || 0);
    updateScoreBar('Experience Match', scoreBreakdown.experienceMatch || 0);
    updateScoreBar('Location Fit', scoreBreakdown.locationFit || 0);
    updateScoreBar('Profile Quality', scoreBreakdown.profileQuality || 0);
}

function updateScoreBar(label, score) {
    const scoreElements = candidateModal.querySelectorAll('.grid.grid-cols-2 > div');
    scoreElements.forEach(element => {
        const labelElement = element.querySelector('.text-gray-400');
        if (labelElement && labelElement.textContent === label) {
            const progressBar = element.querySelector('.bg-accent-cyan');
            const scoreText = element.querySelector('.text-accent-cyan');
            if (progressBar) progressBar.style.width = `${score}%`;
            if (scoreText) scoreText.textContent = `${score}%`;
        }
    });
}

function updateModalProfile(candidate) {
    const profileSection = candidateModal.querySelector('.grid.grid-cols-1.md\\:grid-cols-2 > div:first-child');
    if (!profileSection) return;

    const profileData = [
        ['Experience:', candidate.experience || 'Experienced professional'],
        ['Current Role:', candidate.title],
        ['Location:', candidate.location],
        ['Source:', candidate.source],
        ['Salary Range:', candidate.salaryRange || 'Not specified'],
        ['Hiring Difficulty:', candidate.hiringDifficulty || 'Not assessed'],
        ['Profile Updated:', candidate.lastUpdated]
    ];

    const profileContent = profileSection.querySelector('.space-y-3');
    if (profileContent) {
        profileContent.innerHTML = `
            ${profileData.map(([label, value]) => `
                <div class="flex justify-between">
                    <span class="text-gray-400">${label}</span>
                    <span class="text-white">${value}</span>
                </div>
            `).join('')}
            ${candidate.companyContext ? `
                <div class="pt-3 border-t border-gray-600">
                    <span class="text-gray-400 block mb-2">Company Context:</span>
                    <span class="text-white text-sm leading-relaxed">${candidate.companyContext}</span>
                </div>
            ` : ''}
            <div class="flex justify-between items-center pt-2">
                <span class="text-gray-400">Verification:</span>
                <div class="flex items-center space-x-2">
                    ${candidate.verificationStatus === 'Verified' ? `
                        <div class="flex items-center space-x-1 bg-accent-cyan/20 text-accent-cyan px-2 py-1 rounded-full">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.238.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                            <span class="text-sm font-medium">Verified</span>
                        </div>
                    ` : `
                        <span class="text-yellow-400 text-sm">${candidate.verificationStatus || 'Unverified'}</span>
                    `}
                </div>
            </div>
        `;
    }
}

function updateModalStrengths(candidate) {
    const strengthsSection = candidateModal.querySelector('.grid.grid-cols-1.md\\:grid-cols-2 > div:last-child .space-y-2');
    if (!strengthsSection) return;

    const strengths = candidate.strengths || ['Professional background', 'Industry experience'];
    strengthsSection.innerHTML = strengths.map(strength => `
        <div class="flex items-center space-x-2">
            <div class="w-2 h-2 bg-accent-cyan rounded-full"></div>
            <span class="text-gray-300 text-sm">${strength}</span>
        </div>
    `).join('');
}

function updateModalConcerns(candidate) {
    const concernsSection = candidateModal.querySelector('.bg-yellow-900\\/20 .space-y-2');
    if (!concernsSection) return;

    const concerns = candidate.concerns || ['Profile verification recommended before contact'];
    concernsSection.innerHTML = concerns.map(concern => `
        <div class="flex items-start space-x-2">
            <span class="text-yellow-400">‚Ä¢</span>
            <span>${concern}</span>
        </div>
    `).join('');
}

function updateModalRecommendation(candidate) {
    const recommendationSection = candidateModal.querySelector('.bg-accent-cyan\\/10 p.text-gray-300');
    if (!recommendationSection) return;

    const priority = candidate.priority || 'medium';
    const recommendation = candidate.recommendation || 'Review profile for potential match';

    recommendationSection.innerHTML = `
        <strong>${priority.charAt(0).toUpperCase() + priority.slice(1)} Priority Contact:</strong> ${recommendation}
    `;
}

// Update current skills section in modal
function updateModalCurrentSkills(candidate) {
    const skillsContainer = candidateModal.querySelector('#currentSkillsContainer');
    if (!skillsContainer) return;

    const currentSkills = candidate.currentSkills || [];
    skillsContainer.innerHTML = currentSkills.map(skill => `
        <span class="px-3 py-1 bg-blue-500/20 text-blue-400 border border-blue-500/30 text-sm rounded-full font-medium">
            ${skill}
        </span>
    `).join('');
}

// Update growth opportunities section in modal
function updateModalGrowthOpportunities(candidate) {
    const growthContainer = candidateModal.querySelector('#growthOpportunitiesContainer');
    if (!growthContainer) return;

    const growthOpportunities = candidate.growthOpportunities || [];
    growthContainer.innerHTML = growthOpportunities.map(opportunity => `
        <div class="flex items-start space-x-2">
            <div class="w-2 h-2 bg-accent-cyan rounded-full mt-2"></div>
            <span class="text-gray-300 text-sm">${opportunity}</span>
        </div>
    `).join('');
}

// Update career analytics section in modal
function updateModalCareerAnalytics(candidate) {
    const analyticsContainer = candidateModal.querySelector('#careerAnalyticsContent');
    if (analyticsContainer && candidate.careerAnalytics) {
        analyticsContainer.textContent = candidate.careerAnalytics;
    }
}

// --- Result Filters and Sorting ---
function setupResultFilters() {
    console.log('setupResultFilters called');
    setupEnhancedFilters();
    
    // Sort dropdown
    const sortSelectElement = document.getElementById('sortSelect');
    if (sortSelectElement) {
        sortSelectElement.addEventListener('change', sortCandidates);
        console.log('Sort listener attached');
    }
}

// Filter candidates based on criteria
function filterCandidates() {
    const filterInput = document.querySelector('#resultsState input[placeholder*="Filter by name"]');
    const scoreRange = document.querySelector('#resultsState input[type="range"]');
    const minScore = parseInt(scoreRange?.value || 0);
    const searchTerm = filterInput?.value.toLowerCase() || '';

    const candidateCards = document.querySelectorAll('.candidate-card');
    let visibleCount = 0;

    candidateCards.forEach(card => {
        const candidateId = card.getAttribute('data-candidate-id');
        const candidate = currentCandidates.find(c => c.id === candidateId);

        if (!candidate) {
            card.style.display = 'none';
            return;
        }

        // Check score
        const meetsScore = candidate.aiScore >= minScore;

        // Check text search
        const searchableText = `${candidate.name} ${candidate.title} ${candidate.location} ${candidate.strengths?.join(' ')}`.toLowerCase();
        const meetsSearch = searchTerm === '' || searchableText.includes(searchTerm);

        if (meetsScore && meetsSearch) {
            card.style.display = 'block';
            visibleCount++;
        } else {
            card.style.display = 'none';
        }
    });

    // Update results count
    updateResultsCount(visibleCount);
}

// Enhanced filtering functionality
function setupEnhancedFilters() {
    // Experience filter
    const experienceFilter = document.getElementById('experienceFilter');
    const experienceValue = document.getElementById('experienceValue');
    if (experienceFilter && experienceValue) {
        experienceFilter.addEventListener('input', (e) => {
            experienceValue.textContent = e.target.value + '+';
            filterCandidatesEnhanced();
        });
    }
    
    // Score filter  
    const scoreFilter = document.getElementById('scoreFilter');
    const scoreValue = document.getElementById('scoreValue');
    if (scoreFilter && scoreValue) {
        scoreFilter.addEventListener('input', (e) => {
            scoreValue.textContent = e.target.value;
            filterCandidatesEnhanced();
        });
    }
    
    // Text filter
    const nameFilter = document.getElementById('nameFilter');
    if (nameFilter) {
        nameFilter.addEventListener('input', filterCandidatesEnhanced);
    }
    
    // Verification filter
    const verifiedFilter = document.getElementById('verifiedFilter');
    if (verifiedFilter) {
        verifiedFilter.addEventListener('change', filterCandidatesEnhanced);
    }
    
    // Location dropdown
    const locationBtn = document.getElementById('locationFilterBtn');
    const locationDropdown = document.getElementById('locationDropdown');
    if (locationBtn && locationDropdown) {
        locationBtn.addEventListener('click', () => {
            locationDropdown.classList.toggle('hidden');
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!locationBtn.contains(e.target) && !locationDropdown.contains(e.target)) {
                locationDropdown.classList.add('hidden');
            }
        });
        
        // Location checkboxes
        document.querySelectorAll('.location-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                updateLocationButtonText();
                filterCandidatesEnhanced();
            });
        });
    }
    
    // Clear filters
	const clearFilters = document.getElementById('clearFilters');
	if (clearFilters) {
	    clearFilters.addEventListener('click', () => {
	        console.log('Clear filters clicked');
	        console.log('Total candidates before clear:', currentCandidates.length);
	        
	        document.getElementById('nameFilter').value = '';
	        document.getElementById('experienceFilter').value = '0';
	        document.getElementById('scoreFilter').value = '0';
	        document.getElementById('verifiedFilter').checked = false;
	        document.querySelectorAll('.location-checkbox').forEach(cb => cb.checked = true);
	        experienceValue.textContent = '0+';
	        scoreValue.textContent = '0';
	        updateLocationButtonText();
	        
	        console.log('About to call filterCandidatesEnhanced');
	        filterCandidatesEnhanced();
	    });
	}
}

function filterCandidatesEnhanced() {
    console.log('filterCandidatesEnhanced called');
    const nameFilter = document.getElementById('nameFilter')?.value.toLowerCase() || '';
    const minExperience = parseInt(document.getElementById('experienceFilter')?.value || 0);
    const minScore = parseInt(document.getElementById('scoreFilter')?.value || 0);
    const verifiedOnly = document.getElementById('verifiedFilter')?.checked || false;
    
    console.log('Filter values:', { nameFilter, minExperience, minScore, verifiedOnly });
    
    const selectedLocations = Array.from(document.querySelectorAll('.location-checkbox:checked'))
        .map(cb => cb.value.toLowerCase());
    
    console.log('Selected locations:', selectedLocations);
    
    const candidateCards = document.querySelectorAll('.candidate-card');
    let visibleCount = 0;
    
    candidateCards.forEach(card => {
        const candidateId = card.getAttribute('data-candidate-id');
        const candidate = currentCandidates.find(c => c.id === candidateId);
        
        if (!candidate) {
            console.log('Candidate not found for card:', candidateId);
            card.style.display = 'none';
            return;
        }
        
        // Test each filter condition
        const searchableText = `${candidate.name} ${candidate.title} ${candidate.location}`.toLowerCase();
        const passesTextFilter = nameFilter === '' || searchableText.includes(nameFilter);
        
        const experienceYears = parseInt(candidate.experience?.match(/\d+/)?.[0] || '0');
        const passesExperienceFilter = experienceYears >= minExperience;
        
        const passesScoreFilter = candidate.aiScore >= minScore;
        
        const passesVerificationFilter = !verifiedOnly || candidate.verificationStatus === 'Verified';
        
        // Location filter
		const candidateLocation = candidate.location.toLowerCase();
		const specificCities = ['jakarta', 'surabaya', 'bandung', 'medan', 'semarang', 'makassar', 'palembang', 'tangerang', 'depok', 'bekasi'];
		const candidateHasSpecificCity = specificCities.some(city => candidateLocation.includes(city));
		
		let passesLocationFilter;
		if (candidateHasSpecificCity) {
		    // If candidate has a specific city, check if that city is selected
		    passesLocationFilter = selectedLocations.some(loc => candidateLocation.includes(loc));
		} else {
		    // If candidate has no specific city (like "Indonesia"), check if "other" is selected
		    passesLocationFilter = selectedLocations.includes('other');
		}
		
		// If no locations are selected, show all
		if (selectedLocations.length === 0) {
		    passesLocationFilter = true;
		}
        
        const allTestsPass = passesTextFilter && passesExperienceFilter && passesScoreFilter && 
		    passesVerificationFilter && passesLocationFilter;
		
		if (allTestsPass) {
            card.style.display = 'block';
            visibleCount++;
        } else {
            card.style.display = 'none';
        }
    });
    
    console.log('Visible count after filtering:', visibleCount);
    updateResultsCount(visibleCount);
}

// Update location button text
function updateLocationButtonText() {
    const selectedLocations = Array.from(document.querySelectorAll('.location-checkbox:checked'));
    const locationBtn = document.getElementById('locationFilterBtn');
    const btnText = locationBtn.querySelector('span');
    
    if (selectedLocations.length === 0) {
        btnText.textContent = 'No Locations';
    } else if (selectedLocations.length === document.querySelectorAll('.location-checkbox').length) {
        btnText.textContent = 'All Locations';
    } else if (selectedLocations.length === 1) {
        btnText.textContent = selectedLocations[0].nextElementSibling.textContent;
    } else {
        btnText.textContent = `${selectedLocations.length} Locations`;
    }
}

// Sort candidates
function sortCandidates() {
    console.log('sortCandidates called', currentCandidates.length);
    const sortSelectElement = document.getElementById('sortSelect');
    const sortBy = sortSelectElement?.value || 'Sort by Score';
    console.log('Sort by:', sortBy);
    const container = document.querySelector('#candidateCardsContainer');
    console.log('Container found:', !!container);

    if (!container) return;

    const cards = Array.from(container.querySelectorAll('.candidate-card'));
    console.log('Cards found for sorting:', cards.length); // ADD THIS

    cards.sort((a, b) => {
        const idA = a.getAttribute('data-candidate-id');
        const idB = b.getAttribute('data-candidate-id');
        const candidateA = currentCandidates.find(c => c.id === idA);
        const candidateB = currentCandidates.find(c => c.id === idB);

        console.log('Comparing:', candidateA?.name, 'vs', candidateB?.name); // ADD THIS

        if (!candidateA || !candidateB) return 0;

        switch (sortBy) {
            case 'Sort by Score':
                console.log('Sorting by score:', candidateB.aiScore, 'vs', candidateA.aiScore); // ADD THIS
                return candidateB.aiScore - candidateA.aiScore;
            case 'Sort by Experience':
                const yearsA = parseInt(candidateA.experience?.match(/\d+/)?.[0] || '0');
                const yearsB = parseInt(candidateB.experience?.match(/\d+/)?.[0] || '0');
                console.log('Sorting by experience:', yearsB, 'vs', yearsA); // ADD THIS
                return yearsB - yearsA;
            case 'Sort by Location':
                console.log('Sorting by location:', candidateA.location, 'vs', candidateB.location); // ADD THIS
                return candidateA.location.localeCompare(candidateB.location);
            default:
                return 0;
        }
    });

    console.log('About to reorder DOM elements'); // ADD THIS
    // Reorder DOM
    cards.forEach(card => container.appendChild(card));
    console.log('DOM reordering complete'); // ADD THIS
}

// Update visible results count
function updateResultsCount(visibleCount) {
    const resultsDesc = document.querySelector('#resultsState p');
    if (resultsDesc && currentCandidates.length > 0) {
        const totalCount = currentCandidates.length;
        if (visibleCount < totalCount) {
            resultsDesc.textContent = `Showing ${visibleCount} of ${totalCount} candidates`;
        } else {
            resultsDesc.textContent = `Found ${totalCount} candidates matching your search`;
        }
    }
}

// --- Candidate Comparison Logic ---

// Update the compare button based on selected candidates
function updateCompareButton() {
console.log('updateCompareButton called');
    const selectedCheckboxes = document.querySelectorAll('.candidate-checkbox:checked');
	console.log('Selected checkboxes:', selectedCheckboxes.length);
    const compareBtn = document.getElementById('compareBtn');
	console.log('Compare button found:', compareBtn);
    const compareBtnText = document.getElementById('compareBtnText');

    if (selectedCheckboxes.length > 0) {
        compareBtn.classList.remove('hidden');
        compareBtnText.textContent = `Compare (${selectedCheckboxes.length})`;

        // Limit to max 3 selections
        if (selectedCheckboxes.length >= 3) {
            document.querySelectorAll('.candidate-checkbox:not(:checked)').forEach(cb => {
                cb.disabled = true;
                cb.parentElement.style.opacity = '0.5';
            });
        } else {
            document.querySelectorAll('.candidate-checkbox').forEach(cb => {
                cb.disabled = false;
                cb.parentElement.style.opacity = '1';
            });
        }
    } else {
        compareBtn.classList.add('hidden');
        document.querySelectorAll('.candidate-checkbox').forEach(cb => {
            cb.disabled = false;
            cb.parentElement.style.opacity = '1';
        });
    }
}

// Get selected candidates for comparison
function getSelectedCandidates() {
    const selectedCheckboxes = document.querySelectorAll('.candidate-checkbox:checked');
    const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.candidateId);
    return currentCandidates.filter(candidate => selectedIds.includes(candidate.id));
}

// Show comparison modal with selected candidates
function showComparisonModal(candidates) {
    const modal = document.getElementById('comparisonModal');
    const content = document.getElementById('comparisonContent');

    // Set grid columns based on number of candidates
    const gridCols = candidates.length === 2 ? 'grid-cols-2' : 'grid-cols-3';
    content.className = `grid gap-6 ${gridCols}`;

    // Generate comparison content
    content.innerHTML = candidates.map(candidate => `
        <div class="bg-dark-primary rounded-lg p-6">
            <!-- Header -->
            <div class="text-center mb-4">
                <div class="w-16 h-16 bg-gray-600 rounded-full flex items-center justify-center mx-auto mb-3">
                    <span class="text-white font-bold text-lg">${candidate.name.split(' ').map(n => n[0]).join('').substring(0, 2)}</span>
                </div>
                <h3 class="text-lg font-semibold text-white">${candidate.name}</h3>
                <p class="text-gray-300 text-sm">${candidate.title}</p>
                <div class="mt-2">
                    <div class="w-12 h-12 rounded-full score-circle flex items-center justify-center mx-auto" style="--score-deg: ${candidate.aiScore * 3.6}deg">
                        <div class="w-8 h-8 bg-dark-primary rounded-full flex items-center justify-center">
                            <span class="text-accent-cyan font-bold text-sm">${candidate.aiScore}</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Details -->
            <div class="space-y-3 text-sm">
                <div class="flex justify-between">
                    <span class="text-gray-400">Experience:</span>
                    <span class="text-white text-right">${candidate.experience || 'N/A'}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Location:</span>
                    <span class="text-white">${candidate.location}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Source:</span>
                    <span class="text-accent-cyan">${candidate.source}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Verified:</span>
                    <span class="text-${candidate.verificationStatus === 'Verified' ? 'accent-cyan' : 'yellow-400'}">${candidate.verificationStatus}</span>
                </div>
            </div>
            <!-- Score Breakdown -->
            <div class="mt-4 pt-4 border-t border-gray-600">
                <h4 class="text-sm font-semibold text-gray-300 mb-3">AI Score Breakdown</h4>
                <div class="space-y-2">
                    ${(Object.entries(candidate.scoreBreakdown || {})).map(([key, score]) => `
                        <div>
                            <div class="flex justify-between text-xs mb-1">
                                <span class="text-gray-400">${key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}</span>
                                <span class="text-accent-cyan">${score}%</span>
                            </div>
                            <div class="w-full bg-gray-600 rounded-full h-1.5">
                                <div class="bg-accent-cyan h-1.5 rounded-full" style="width: ${score}%"></div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
            <!-- Key Strengths -->
            <div class="mt-4 pt-4 border-t border-gray-600">
                <h4 class="text-sm font-semibold text-gray-300 mb-2">Key Strengths</h4>
                <div class="space-y-1">
                    ${(candidate.strengths || []).slice(0, 3).map(strength => `
                        <div class="flex items-center space-x-2">
                            <div class="w-1.5 h-1.5 bg-accent-cyan rounded-full"></div>
                            <span class="text-gray-300 text-xs">${strength}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `).join('');

    modal.classList.remove('hidden');
}

// --- Export and Clipboard Logic ---

function showExportToast(text = "Exporting...") {
    const toast = document.getElementById('exportToast');
    const toastText = document.getElementById('exportToastText');
    toastText.textContent = text;
    toast.classList.remove('hidden');
}
function hideExportToast() {
    const toast = document.getElementById('exportToast');
    toast.classList.add('hidden');
}

// Export all current candidates as CSV
function downloadCSV() {
    const csvRows = [
        ['Name', 'Title', 'Experience', 'Location', 'AI Score', 'Source', 'Strengths', 'Concerns', 'Recommendation']
    ];
    (currentCandidates || []).forEach(candidate => {
        csvRows.push([
            candidate.name,
            candidate.title,
            candidate.experience,
            candidate.location,
            candidate.aiScore,
            candidate.source,
            (candidate.strengths || []).join('; '),
            (candidate.concerns || []).join('; '),
            candidate.recommendation || ''
        ]);
    });
    const csvContent = csvRows.map(row => row.map(val => `"${(val || '').toString().replace(/"/g, '""')}"`).join(',')).join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.setAttribute('hidden', '');
    a.setAttribute('href', url);
    a.setAttribute('download', `leadfinder_results_${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

// Copy summary of results to clipboard
function copyToClipboard() {
    const textData = `LEADFINDER SEARCH RESULTS

${(currentCandidates || []).map(c =>
    `${c.name} - ${c.title} (${c.experience}) - ${c.location} - Score: ${c.aiScore}`
).join('\n')}

Generated on: ${new Date().toLocaleDateString()}`;
    navigator.clipboard.writeText(textData).then(() => {
        alert('Results copied to clipboard!');
    }).catch(err => {
        console.error('Failed to copy: ', err);
    });
}

// Export one candidate to CSV
function exportCandidateToCSV(candidate) {
    if (!candidate) return;
    const csvRows = [
        ["Name", "Title", "Experience", "Location", "AI Score", "Source", "Strengths", "Concerns", "Recommendation"],
        [
            candidate.name,
            candidate.title,
            candidate.experience,
            candidate.location,
            candidate.aiScore,
            candidate.source,
            (candidate.strengths || []).join("; "),
            (candidate.concerns || []).join("; "),
            candidate.recommendation || ""
        ]
    ];
    const csvContent = csvRows.map(row => row.map(value => `"${(value || '').toString().replace(/"/g, '""')}"`).join(",")).join("\n");
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.setAttribute('hidden', '');
    a.setAttribute('href', url);
    a.setAttribute('download', `candidate_${candidate.name.replace(/\s+/g, "_")}_${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

// Export one candidate to PDF (uses jsPDF library)
function exportCandidateToPDF(candidate) {
    if (!candidate) return;
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Title
    doc.setFontSize(18);
    doc.setTextColor(0, 212, 170);
    doc.text("Candidate Profile", 14, 16);

    // Basic info
    doc.setFontSize(12);
    doc.setTextColor(34, 34, 34);
    let y = 30;
    doc.text(`Name: ${candidate.name}`, 14, y);      y += 8;
    doc.text(`Title: ${candidate.title}`, 14, y);    y += 8;
    doc.text(`Experience: ${candidate.experience || ''}`, 14, y); y += 8;
    doc.text(`Location: ${candidate.location}`, 14, y);  y += 8;
    doc.text(`AI Score: ${candidate.aiScore}`, 14, y);   y += 8;
    doc.text(`Source: ${candidate.source}`, 14, y);      y += 8;

    // AI Analysis Summary (metrics)
    doc.setFont(undefined, "bold");
    doc.text("AI Analysis Metrics:", 14, y); y += 6;
    doc.setFont(undefined, "normal");
    const m = candidate.scoreBreakdown || {};
    doc.text(`- Role Relevance: ${m.roleRelevance ?? 'N/A'}%`, 18, y); y += 6;
    doc.text(`- Experience Match: ${m.experienceMatch ?? 'N/A'}%`, 18, y); y += 6;
    doc.text(`- Location Fit: ${m.locationFit ?? 'N/A'}%`, 18, y); y += 6;
    doc.text(`- Profile Quality: ${m.profileQuality ?? 'N/A'}%`, 18, y); y += 8;

    // Company Context
    doc.setFont(undefined, "bold");
    doc.text("Company Context:", 14, y); y += 6;
    doc.setFont(undefined, "normal");
    doc.text(doc.splitTextToSize(
        candidate.companyContext || "No company context provided.",
        180), 18, y);
    y += Math.max(12, doc.splitTextToSize(candidate.companyContext || "", 180).length * 6);

    // Strengths
    doc.setFont(undefined, "bold");
    doc.text("Key Strengths:", 14, y);
    doc.setFont(undefined, "normal");
    y += 6;
    (candidate.strengths || []).forEach(strength => {
        doc.text(`- ${strength}`, 18, y);
        y += 6;
    });

    // Concerns
    if (candidate.concerns && candidate.concerns.length > 0) {
        doc.setFont(undefined, "bold");
        doc.text("Concerns:", 14, y);
        doc.setFont(undefined, "normal");
        y += 6;
        (candidate.concerns || []).forEach(concern => {
            doc.text(`- ${concern}`, 18, y);
            y += 6;
        });
    }

    // Recommendation
    if (candidate.recommendation) {
        doc.setFont(undefined, "bold");
        doc.text("AI Recommendation:", 14, y);
        doc.setFont(undefined, "normal");
        y += 6;
        doc.text(doc.splitTextToSize(candidate.recommendation, 180), 18, y);
        y += 12;
    }

    doc.save(`candidate_${candidate.name.replace(/\s+/g, "_")}_${new Date().toISOString().split('T')[0]}.pdf`);
}

// Export one candidate to Clipboard
function exportCandidateToClipboard(candidate) {
    if (!candidate) return;
    const m = candidate.scoreBreakdown || {};
    const text = `
Candidate Profile - ${candidate.name}
---------------------------------------

Title: ${candidate.title}
Experience: ${candidate.experience || ''}
Location: ${candidate.location}
AI Score: ${candidate.aiScore}
Source: ${candidate.source}

AI Analysis Metrics:
- Role Relevance: ${m.roleRelevance ?? 'N/A'}%
- Experience Match: ${m.experienceMatch ?? 'N/A'}%
- Location Fit: ${m.locationFit ?? 'N/A'}%
- Profile Quality: ${m.profileQuality ?? 'N/A'}%

Company Context:
${candidate.companyContext || "No company context provided."}

Key Strengths:
${(candidate.strengths || []).map(s => `- ${s}`).join('\n')}

${candidate.concerns && candidate.concerns.length > 0 ? "Concerns:\n" + candidate.concerns.map(c => `- ${c}`).join('\n') + "\n" : ""}
${candidate.recommendation ? "AI Recommendation:\n" + candidate.recommendation : ""}
    `.trim();

    navigator.clipboard.writeText(text).then(() => {
        showExportToast("Copied to clipboard!");
        setTimeout(hideExportToast, 1200);
    }).catch(() => {
        alert("Failed to copy to clipboard.");
    });
}

function handleExport(type) {
    switch (type) {
        case 'pdf':
            // Generate PDF report
            alert('PDF export functionality will be implemented with jsPDF');
            break;
        case 'csv':
            // Generate CSV download
            downloadCSV();
            break;
        case 'clipboard':
            // Copy to clipboard
            copyToClipboard();
            break;
    }
    exportModal.classList.add('hidden');
}

// Export button event delegation
document.addEventListener('click', (e) => {
    if (e.target.closest('button') && e.target.closest('button').textContent.includes('PDF Report')) {
        handleExport('pdf');
    } else if (e.target.closest('button') && e.target.closest('button').textContent.includes('CSV Spreadsheet')) {
        handleExport('csv');
    } else if (e.target.closest('button') && e.target.closest('button').textContent.includes('Copy to Clipboard')) {
        handleExport('clipboard');
    }
});

// --- Search History Logic ---

// Update search history count badge
function updateSearchHistoryCount() {
    const historyBtn = document.getElementById('searchHistoryBtn');
    const countSpan = historyBtn.querySelector('span:last-child');
    if (countSpan) {
        countSpan.textContent = searchHistory.length.toString();
    }
}

// Update the search history UI with recent history
async function updateSearchHistoryUI() {
    const history = JSON.parse(localStorage.getItem('leadfinder_history') || '[]');
    const historyBtn = document.getElementById('searchHistoryBtn');
    const countSpan = historyBtn.querySelector('.bg-accent-cyan');
    
    if (countSpan) {
        countSpan.textContent = history.length.toString();
    }
    
    const historyModal = document.getElementById('historyModal');
    const historyContainer = historyModal.querySelector('.space-y-4');
    
    if (historyContainer) {
        if (history.length === 0) {
            historyContainer.innerHTML = `
                <div class="text-center py-8 text-gray-400">
                    <svg class="w-12 h-12 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                    </svg>
                    <p>No search history yet</p>
                </div>
            `;
        } else {
            historyContainer.innerHTML = history.map((item, index) => `
                <div class="bg-dark-primary rounded-lg p-4 hover:bg-dark-tertiary transition-colors cursor-pointer search-history-item" data-search-index="${index}">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="font-semibold text-white">${item.jobTitle || 'Untitled Search'} in ${item.location || 'Any Location'}</h3>
                        <span class="text-sm text-gray-400">${getRelativeTime(item.timestamp)}</span>
                    </div>
                    <p class="text-sm text-gray-300 mb-2">${item.industry || 'Any Industry'} ‚Ä¢ ${item.experience || 'Any Experience'}</p>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-accent-cyan">${item.resultCount} candidates found</span>
                        <button class="px-3 py-1 bg-accent-cyan/20 hover:bg-accent-cyan text-accent-cyan hover:text-dark-primary rounded-lg text-xs font-semibold flex items-center rerun-search-btn">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                            Rerun Search
                        </button>
                    </div>
                </div>
            `).join('');
            
            window.searchHistoryData = history;
        }
    }
}

// Helper for relative time strings
function getRelativeTime(timestamp) {
    const now = new Date();
    const then = new Date(timestamp);
    const diffMs = now - then;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    if (diffMins < 60) return `${diffMins} minutes ago`;
    if (diffHours < 24) return `${diffHours} hours ago`;
    return `${diffDays} days ago`;
}

// Save a search to local history (still useful as fallback or secondary record)
function saveToSearchHistory(searchParams, resultCount, candidates) {
	console.log('Saving search to history:', searchParams);
    const searchEntry = {
        id: Date.now(),
        ...searchParams,
        resultCount: resultCount,
        candidates: candidates,
        timestamp: new Date().toISOString(),
        date: new Date().toLocaleDateString()
    };
	console.log('Search entry created:', searchEntry);
    // Get existing history
    let history = JSON.parse(localStorage.getItem('leadfinder_history') || '[]');
    history.unshift(searchEntry);
    history = history.slice(0, 50);
    localStorage.setItem('leadfinder_history', JSON.stringify(history));
    updateSearchHistoryCount();
}

// Event delegation for rerun search button in history
document.addEventListener('click', (e) => {
    if (e.target.classList.contains('rerun-search-btn')) {
        e.stopPropagation();
        const historyItem = e.target.closest('.search-history-item');
        const searchIndex = parseInt(historyItem.dataset.searchIndex);
        const searchData = window.searchHistoryData[searchIndex];
        // Fill form with historical search
        document.getElementById('jobTitle').value = searchData.jobTitle || '';
        document.getElementById('industry').value = searchData.industry || '';
        document.getElementById('location').value = searchData.location || '';
        document.getElementById('experience').value = searchData.experience || '';
        // Close modal and run search
        historyModal.classList.add('hidden');
        searchForm.dispatchEvent(new Event('submit'));
    }
});

// --- Analytics & AI Insights Logic ---

// Update any analytics displays you have (optional; console.log for now)
function updateAnalytics(analytics) {
    // Example: update analytics widgets if you have them
    if (!analytics) return;
    console.log('Search Quality:', analytics.searchQuality);
    console.log('Recommended Action:', analytics.recommendedAction);
}

// Extract job title from search query string
function extractJobTitleFromQuery(queryString) {
    if (!queryString) return null;
    // Remove location and extra keywords, keep first 2-3 words
    const words = queryString.split(' ').filter(word => 
        !['indonesia', 'jakarta', 'bandung', '-jobs', '-hiring', '-vacancy'].includes(word.toLowerCase())
    );
    return words.slice(0, 3).join(' '); // Take first 3 words as job title
}

// Generate and display AI insights summary for the search
function generateAIInsights(candidates, searchQuery) {
	console.log('generateAIInsights called with:', searchQuery);
    console.log('searchQuery properties:', Object.keys(searchQuery));
    console.log('jobTitle value:', searchQuery.jobTitle);
    console.log('location value:', searchQuery.location);
    console.log('searchQuery value:', searchQuery.searchQuery);
	
    const totalCandidates = candidates.length;
    const highScoreCandidates = candidates.filter(c => c.aiScore >= 80).length;
    const locations = [...new Set(candidates.map(c => c.location))];
    const experiences = candidates.map(c => {
        const match = c.experience?.match(/(\d+)/);
        return match ? parseInt(match[0]) : 0;
    });
    const avgExperience = experiences.length > 0
        ? Math.round(experiences.reduce((a, b) => a + b, 0) / experiences.length)
        : 0;

	// FIX: Use the correct property names
    const jobTitle = extractJobTitleFromQuery(searchQuery.searchQuery) || searchQuery.jobTitle || 'the position';
    const location = searchQuery.location || 'the specified location';

    let insights = `Found ${totalCandidates} candidates matching "${jobTitle}" in ${location}. `;
    if (highScoreCandidates > 0) {
        insights += `${highScoreCandidates} candidates have high compatibility scores (80+). `;
    }
    if (avgExperience > 0) {
        insights += `Average experience level is ${avgExperience} years. `;
    }
    if (locations.length > 1) {
        insights += `Candidates are spread across ${locations.length} locations. `;
    }
    const verifiedCount = candidates.filter(c => c.verificationStatus === 'Verified').length;
    if (verifiedCount > 0) {
        insights += `${verifiedCount} profiles are verified. `;
    }
    insights += `Best matches are ready for immediate contact.`;

    return insights;
}

// --- Enhanced Loading Animation ---

// Main enhanced loading function with steps and tips
async function showEnhancedLoading() {
    const steps = [
        { 
            step: 1, 
            text: 'Initializing LinkedIn search parameters', 
            delay: 2000, 
            progress: 8,
            tip: 'üîç Optimizing search criteria for best results'
        },
        { 
            step: 2, 
            text: 'Searching LinkedIn professional profiles', 
            delay: 8000, 
            progress: 25,
            tip: 'üåê Scanning thousands of LinkedIn profiles in Indonesia'
        },
        { 
            step: 3, 
            text: 'Extracting candidate information', 
            delay: 15000, 
            progress: 40,
            tip: 'üìä Processing profile data and work history'
        },
        { 
            step: 4, 
            text: 'Running AI analysis and scoring', 
            delay: 25000, 
            progress: 60,
            tip: 'ü§ñ AI analyzing candidate qualifications and experience'
        },
        { 
            step: 5, 
            text: 'Evaluating role and experience match', 
            delay: 35000, 
            progress: 75,
            tip: '‚ö° Calculating compatibility scores for each candidate'
        },
        { 
            step: 6, 
            text: 'Ranking candidates by compatibility', 
            delay: 42000, 
            progress: 90,
            tip: 'üéØ Sorting candidates by best matches first'
        },
        { 
            step: 7, 
            text: 'Finalizing results and recommendations', 
            delay: 48000, 
            progress: 100,
            tip: '‚ú® Preparing your personalized talent recommendations'
        }
    ];

    let previousDelay = 0;
    let lastProgress = 0;

    for (let stepData of steps) {
        // Animate progress from lastProgress to stepData.progress over the segment duration
        await smoothRandomProgress(lastProgress, stepData.progress, stepData.delay - previousDelay);

        updateStepStatus(stepData.step, 'processing');
        updateLoadingTip(stepData.tip);

        await new Promise(resolve => setTimeout(resolve, 800));
        updateStepStatus(stepData.step, 'complete');

        lastProgress = stepData.progress;
        previousDelay = stepData.delay + 800;
    }

    await new Promise(resolve => setTimeout(resolve, 500));
    updateLoadingTip('üéâ Search completed successfully! Displaying results...');
}

// Smooth, randomized progress increment between two values over a set duration
async function smoothRandomProgress(from, to, totalDuration = 1000) {
    return new Promise(resolve => {
        let current = from;
        const target = to;
        const increments = [];
        let remaining = target - current;
        // Create random increments between 1 and 5, sum up to the difference
        while (remaining > 0) {
            let step = Math.min(Math.floor(Math.random() * 5) + 1, remaining);
            increments.push(step);
            remaining -= step;
        }
        const stepDuration = totalDuration / increments.length;

        function doStep(i) {
            if (i >= increments.length) {
                updateProgressBar(target); // make sure it hits the target
                resolve();
                return;
            }
            current += increments[i];
            updateProgressBar(current);
            setTimeout(() => doStep(i + 1), stepDuration);
        }
        doStep(0);
    });
}

// Update the progress bar visually
function updateProgressBar(percentage) {
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressPercentage');
    if (progressBar) {
        progressBar.style.width = `${percentage}%`;
        progressBar.style.boxShadow = `0 0 10px rgba(0, 212, 170, 0.4)`;
    }
    if (progressText) {
        progressText.textContent = `${percentage}%`;
    }
}

// Update the step status indicator and style
function updateStepStatus(stepNumber, status) {
    const stepElement = document.querySelector(`[data-step="${stepNumber}"]`);
    if (!stepElement) return;
    const allSpans = stepElement.querySelectorAll('span');
    let statusElement = null;
    for (let i = allSpans.length - 1; i >= 0; i--) {
        if (allSpans[i].textContent.includes('Pending') || 
            allSpans[i].textContent.includes('Processing') || 
            allSpans[i].textContent.includes('Complete')) {
            statusElement = allSpans[i];
            break;
        }
    }
    const numberCircle = stepElement.querySelector('.w-6.h-6.rounded-full');
    if (status === 'processing') {
        stepElement.classList.add('bg-dark-tertiary/30', 'rounded-lg', 'scale-[1.02]', 'transition-all');
        if (statusElement) {
            statusElement.className = 'text-yellow-400 flex items-center';
            statusElement.innerHTML = `
                <svg class="w-4 h-4 mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                Processing...
            `;
        }
        if (numberCircle) {
            numberCircle.className = 'w-6 h-6 rounded-full bg-yellow-500 flex items-center justify-center text-xs text-dark-primary font-semibold animate-pulse';
        }
    } else if (status === 'complete') {
        stepElement.classList.remove('bg-dark-tertiary/30', 'scale-[1.02]');
        if (statusElement) {
            statusElement.className = 'text-accent-cyan flex items-center font-medium';
            statusElement.innerHTML = `
                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                Complete
            `;
        }
        if (numberCircle) {
            numberCircle.className = 'w-6 h-6 rounded-full bg-accent-cyan flex items-center justify-center text-xs text-dark-primary font-semibold';
            numberCircle.innerHTML = `
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                </svg>
            `;
        }
    }
}

function updateLoadingStep(stepText, status) {
    const statusContainer = document.querySelector('#loadingState .space-y-2');
    if (!statusContainer) return;
    
    const stepElements = statusContainer.querySelectorAll('.flex');
    
    stepElements.forEach(element => {
	const textSpan = element.querySelector('span:first-child');
	const statusSpan = element.querySelector('span:last-child');
	
	if (textSpan && textSpan.textContent === stepText) {
	    if (status === 'processing') {
		statusSpan.className = 'text-yellow-400';
		statusSpan.innerHTML = '‚è≥ Processing...';
	    } else if (status === 'complete') {
		statusSpan.className = 'text-accent-cyan';
		statusSpan.innerHTML = '‚úì Complete';
	    }
	}
    });
}

// Update loading step tip message (with fade animation)
function updateLoadingTip(tip) {
    const tipElement = document.getElementById('loadingTip');
    if (tipElement) {
        tipElement.textContent = tip;
        tipElement.style.opacity = '0';
        setTimeout(() => {
            tipElement.style.opacity = '1';
        }, 100);
    }
}

// --- Utility: Modal/Keyboard Shortcuts & Startup Focus ---

// Handle search type radio button changes
document.addEventListener('change', function(e) {
    if (e.target.name === 'searchType') {
        const searchType = e.target.value;
        const creditInfo = document.getElementById('creditInfo');
        const searchBtnText = document.getElementById('searchBtnText');
        
        if (searchType === 'premium') {
            creditInfo.innerHTML = 'üöÄ Premium search with AI Career Predictive Analytics (Uses 10 credits)';
            creditInfo.className = 'text-sm text-purple-400 mt-2 text-center';
            searchBtnText.textContent = 'Start Premium Search';
        } else {
            creditInfo.innerHTML = 'üîç AI will match candidates against your criteria (Uses 1 credit)';
            creditInfo.className = 'text-sm text-gray-400 mt-2 text-center';
            searchBtnText.textContent = 'Search Talent';
        }
    }
});

// Close modals when clicking outside
document.addEventListener('click', (e) => {
    if (e.target === candidateModal) candidateModal.classList.add('hidden');
    if (e.target === historyModal) historyModal.classList.add('hidden');
    if (e.target === exportModal) exportModal.classList.add('hidden');
});

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
    // Escape key closes modals
    if (e.key === 'Escape') {
        candidateModal.classList.add('hidden');
        historyModal.classList.add('hidden');
        exportModal.classList.add('hidden');
    }
    // Ctrl/Cmd + Enter submits search (unless loading)
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        if (!loadingState.classList.contains('hidden')) return;
        handleSearch(e);
    }
});

// Initial UI setup: update search history, focus job title input, scale search button on hover
(async () => {
    await updateSearchHistoryUI();
    document.getElementById('jobTitle').focus();
})();
const searchBtn = document.getElementById('searchBtn');
searchBtn.addEventListener('mouseenter', () => {
    if (!searchBtn.disabled) {
        searchBtn.classList.add('transform', 'scale-105');
    }
});
searchBtn.addEventListener('mouseleave', () => {
    searchBtn.classList.remove('transform', 'scale-105');
});

// Candidate modal export handlers
document.addEventListener('click', async (e) => {
    const btn = e.target.closest('.export-modal-btn');
    if (btn) {
        const type = btn.dataset.type;
        showExportToast(`Exporting ${type.toUpperCase()}...`);
        await new Promise(r => setTimeout(r, 1000));
        if (type === 'pdf') {
            exportCandidateToPDF(activeCandidate);
        } else if (type === 'csv') {
            exportCandidateToCSV(activeCandidate);
        } else if (type === 'clipboard') {
            exportCandidateToClipboard(activeCandidate);
        }
        hideExportToast();
    }
	// Manual test for checkboxes
setTimeout(() => {
    console.log('Testing checkbox listeners...');
    const checkboxes = document.querySelectorAll('.candidate-checkbox');
    console.log('Found checkboxes:', checkboxes.length);
    checkboxes.forEach((cb, i) => {
        console.log(`Checkbox ${i}:`, cb);
    });
}, 2000);
});
	// Compare button event listener
	document.getElementById('compareBtn').addEventListener('click', function() {
	    console.log('Compare button clicked');
	    const selectedCandidates = getSelectedCandidates();
	    console.log('Selected candidates:', selectedCandidates.length);
	    if (selectedCandidates.length > 0) {
	        showComparisonModal(selectedCandidates);
	    }
	});
	// ADD THIS: Comparison modal close handlers
	document.getElementById('closeComparisonModal').addEventListener('click', function() {
	    document.getElementById('comparisonModal').classList.add('hidden');
	});
	
	// Close comparison modal when clicking outside
	document.getElementById('comparisonModal').addEventListener('click', function(e) {
	    if (e.target === this) {
	        this.classList.add('hidden');
	    }
	});
	// LinkedIn button click handler
	document.getElementById('viewLinkedInBtn').addEventListener('click', function() {
	    if (activeCandidate && activeCandidate.profileUrl) {
	        window.open(activeCandidate.profileUrl, '_blank');
	    } else {
	        alert('LinkedIn profile URL not available for this candidate');
	    }
	});
	// Search History modal handler
	document.getElementById('searchHistoryBtn').addEventListener('click', function() {
	    updateSearchHistoryUI();
	    document.getElementById('historyModal').classList.remove('hidden');
	});
	// Close history modal handlers
	document.getElementById('closeHistoryModal').addEventListener('click', function() {
	    document.getElementById('historyModal').classList.add('hidden');
	});
	
	document.getElementById('historyModal').addEventListener('click', function(e) {
	    if (e.target === this) {
	        this.classList.add('hidden');
	    }
	});
	// Event delegation for search history items
	document.addEventListener('click', (e) => {
	    // Existing rerun search button handler
	    if (e.target.classList.contains('rerun-search-btn')) {
	        e.stopPropagation();
	        const historyItem = e.target.closest('.search-history-item');
	        const searchIndex = parseInt(historyItem.dataset.searchIndex);
	        const searchData = window.searchHistoryData[searchIndex];
	        // Fill form with historical search
	        document.getElementById('jobTitle').value = searchData.jobTitle || '';
	        document.getElementById('industry').value = searchData.industry || '';
	        document.getElementById('location').value = searchData.location || '';
	        document.getElementById('experience').value = searchData.experience || '';
	        // Close modal and run search
	        document.getElementById('historyModal').classList.add('hidden');
	        document.getElementById('searchForm').dispatchEvent(new Event('submit'));
	    }
	    
	    // ADD THIS: Click on history item to show results
	    if (e.target.closest('.search-history-item') && !e.target.closest('.rerun-search-btn')) {
	        const historyItem = e.target.closest('.search-history-item');
	        const searchIndex = parseInt(historyItem.dataset.searchIndex);
	        const searchData = window.searchHistoryData[searchIndex];
	        
	        console.log('History item clicked:', searchData);
	        
	        // Show the previous results without running new search
	        showHistorySearchResult(searchData);
	        
	        // Close history modal and show results
	        document.getElementById('historyModal').classList.add('hidden');
	        document.getElementById('initialState').classList.add('hidden');
	        document.getElementById('resultsState').classList.remove('hidden');
	    }
	});
});
    </script>
</body>
</html>
